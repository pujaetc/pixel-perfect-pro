<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelPerfect Pro</title>

    <!-- 1. Global OpenCV Callbacks & State (defined BEFORE opencv.js script tag) -->
    <script>
        // Define updateEnhanceButtonState globally
        window.updateEnhanceButtonState = function() {
            const enhanceBtn = document.getElementById('enhanceBtn');
            if (enhanceBtn) {
                enhanceBtn.disabled = !window.isOpenCvReady;
                enhanceBtn.classList.toggle('opacity-50', !window.isOpenCvReady);
                enhanceBtn.classList.toggle('cursor-not-allowed', !window.isOpenCvReady);
            }
        };

        // --- OpenCV এর জন্য গ্লোবাল স্টেট ---
        let isOpenCvReady = false;
        window.isOpenCvReady = false;
        let openCvLoadTimer;

        // --- OpenCV লোডিং কলব্যাক ---
        function onOpenCvError() {
            console.error("HEAD: onOpenCvError CALLED");
            clearTimeout(openCvLoadTimer);
            isOpenCvReady = false;
            window.isOpenCvReady = false;
            const statusEl = document.getElementById('opencvStatus');
            if (statusEl) {
                statusEl.innerHTML = `<i class="ph-fill ph-x-circle text-red-400"></i> OpenCV Failed`;
                statusEl.classList.remove('text-yellow-400', 'text-green-400');
                statusEl.classList.add('text-red-400');
            }
            if (window.showToast) {
                window.showToast('Failed to load OpenCV.js. Enhancement features will be unavailable.', 'error');
            } else {
                document.addEventListener('DOMContentLoaded', () => {
                    if (window.showToast) window.showToast('Failed to load OpenCV.js. Enhancement features will be unavailable.', 'error');
                });
            }
            if (window.updateEnhanceButtonState) {
                window.updateEnhanceButtonState();
            } else {
                 document.addEventListener('DOMContentLoaded', () => {
                    if(window.updateEnhanceButtonState) window.updateEnhanceButtonState();
                });
            }
        }

        function onOpenCvReady() {
            console.log("HEAD: onOpenCvReady CALLED");
            openCvLoadTimer = setTimeout(() => {
                console.error("HEAD: OpenCV.js initialization timed out after 30 seconds (cv.onRuntimeInitialized did not fire).");
                onOpenCvError();
            }, 30000);

            if (typeof cv === 'undefined') {
                console.error("HEAD: OpenCV Error: 'cv' object is undefined in onOpenCvReady. Script might be malformed or blocked.");
                onOpenCvError();
                return;
            }

            console.log("HEAD: Setting cv.onRuntimeInitialized callback...");
            cv.onRuntimeInitialized = () => {
                console.log("HEAD: cv.onRuntimeInitialized CALLED SUCCESSFULLY!");
                clearTimeout(openCvLoadTimer);
                isOpenCvReady = true;
                window.isOpenCvReady = true;
                const statusEl = document.getElementById('opencvStatus');
                if (statusEl) {
                    statusEl.innerHTML = `<i class="ph-fill ph-check-circle text-green-400"></i> OpenCV Ready`;
                    statusEl.classList.remove('text-yellow-400', 'text-red-400');
                    statusEl.classList.add('text-green-400');
                } else {
                    console.error("opencvStatus element not found when OpenCV initialized.");
                }
                if (window.updateEnhanceButtonState) {
                    window.updateEnhanceButtonState();
                } else {
                    console.warn("updateEnhanceButtonState was not defined when OpenCV initialized. Scheduling for DOMContentLoaded.");
                    document.addEventListener('DOMContentLoaded', () => {
                        if (window.updateEnhanceButtonState) window.updateEnhanceButtonState();
                        else console.error("updateEnhanceButtonState still not defined after DOMContentLoaded from OpenCV init.");
                    });
                }
            };
        }
    </script>

    <!-- 2. OpenCV.js - onload এবং onerror কলব্যাক সহ লোড করা -->
    <script async src="https://docs.opencv.org/4.9.0/opencv.js" onload="onOpenCvReady();" onerror="onOpenCvError();" type="text/javascript"></script>

    <!-- 3. অন্যান্য স্ক্রিপ্ট এবং লিঙ্ক -->
    <!-- Google Apps Script Configuration -->
    <script>
        // Configuration for API endpoints
        
        
        // Global fetch configuration
        const fetchConfig = {
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json'
            },
            redirect: 'follow'
        };
        
        // Configure fetch options for CORS
        const fetchOptions = {
            mode: 'cors',
            credentials: 'omit',
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // Global error handler for API calls
        function handleApiError(error) {
            console.error('API Error:', error);
            window.showToast?.(error.message || 'An error occurred while processing your request', 'error');
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Cropper.js Library -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>

    <!-- JSZip Library (Added for Batch Processing) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>


    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #161b22; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #58a6ff; }
        .card-frosted, .modal-content { background-color: rgba(22, 27, 34, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(48, 54, 61, 0.5); }
        .gradient-text { background: linear-gradient(to right, #38bdf8, #3b82f6); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
        .progress-ring__circle { transition: stroke-dashoffset 0.5s ease-out; transform: rotate(-90deg); transform-origin: 50% 50%; }
        .toggle-checkbox:checked { right: 0; border-color: #38bdf8; }
        .toggle-checkbox:checked + .toggle-label { background-color: #38bdf8; }
        .drag-over { border-color: #38bdf8; background-color: rgba(56, 189, 248, 0.1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        #toast-notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 8px; color: white; font-size: 14px; font-weight: 500; z-index: 1000; transition: bottom 0.5s ease-in-out; border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); }
        #toast-notification.show { bottom: 20px; }
        #toast-notification.success { background-color: rgba(22, 163, 74, 0.7); }
        #toast-notification.error { background-color: rgba(220, 38, 38, 0.7); }
        #toast-notification.info { background-color: rgba(56, 189, 248, 0.7); }
        .accent-sky-400 { accent-color: #38bdf8; }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        
        /* Before/After Image Slider Styles */
        #image-compare-slider, #batch-image-compare-slider, #sr-image-compare-slider { -webkit-appearance: none; appearance: none; background: transparent; }
        #afterImageSliderContainer > #afterImageSlider,
        #batch-afterImageSliderContainer > #batch-afterImageSlider,
        #sr-afterImageSliderContainer > #sr-afterImageSlider { 
            width: auto; /* Let the container width control it */
            max-width: none; 
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            object-fit: contain;
        }
        
       
        /* REVISED: General Adjustment Slider Styles */
        .adjustment-row { display: flex; align-items: center; gap: 0.75rem; font-size: 0.875rem; }
        .adjustment-row label { width: 100px; flex-shrink: 0; font-weight: 500; color: #374151; }
        .dark .adjustment-row label { color: #d1d5db; }
        .adjustment-row .number-input-wrapper { display: flex; align-items: center; gap: 2px; flex-shrink: 0; }
        .adjustment-row .number-input {
            width: 40px;
            -moz-appearance: textfield;
            appearance: textfield;
            text-align: center;
            padding: 2px;
            font-size: 12px;
            font-weight: 600;
            background-color: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        .adjustment-row .number-input::-webkit-outer-spin-button, .adjustment-row .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .dark .adjustment-row .number-input { background-color: #374151; border-color: #4b5563; }
        .slider-arrow-btn {
            height: 1.1rem; width: 1.25rem; display: flex; align-items: center; justify-content: center;
            background-color: #e5e7eb; color: #4b5563; transition: background-color 0.15s;
        }
        .slider-arrow-btn:hover { background-color: #d1d5db; }
        .dark .slider-arrow-btn { background-color: #4b5563; color: #dbdcdd; }
        .dark .slider-arrow-btn:hover { background-color: #6b7280; }
        .slider-arrow-btn:first-child { border-top-left-radius: 4px; border-top-right-radius: 4px; }
        .slider-arrow-btn:last-child { border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }


        /* START: NEW STYLES FOR ENHANCED PREVIEW MODAL */
        #large-preview-container {
            cursor: grab;
            user-select: none;
        }
        #large-preview-container.panning {
            cursor: grabbing;
        }
        .viewer-pane {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            display: none;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .viewer-pane.active {
            display: flex;
        }
        .viewer-pane img {
            position: absolute;
            max-width: none; /* Important for pan/zoom */
            transition: transform 0.1s ease-out; /* Smooths zoom slightly */
            pointer-events: none; /* Let parent container handle events */
            user-select: none;
        }
        #split-view-pane > div { /* Container for each split image */
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        #split-view-pane > div:first-child {
            border-right: 1px solid #4a5568;
        }
        .viewer-label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background-color: rgba(0,0,0,0.6);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            pointer-events: none;
            z-index: 10;
        }
        #split-after-container .viewer-label,
        #slider-after-container .viewer-label {
             left: auto;
             right: 1rem;
        }

        #preview-toolbar {
            position: absolute;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(20, 20, 20, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 0.5rem;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 102;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .toolbar-btn {
            background-color: transparent;
            border: none;
            color: #d1d5db;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        .toolbar-btn:hover {
            background-color: rgba(255,255,255,0.15);
            color: white;
        }
        .toolbar-btn.active {
            background-color: #4f46e5; /* Indigo color for active state */
            color: white;
        }
        .toolbar-btn i {
            font-size: 1.25rem;
        }
        #zoom-level-display {
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 45px;
            text-align: center;
            color: #e5e7eb;
        }
        .toolbar-divider {
            width: 1px;
            height: 1.5rem;
            background-color: rgba(255,255,255,0.2);
            margin: 0 0.25rem;
        }
        
        /* New slider handle style */
        #large-preview-slider-handle {
            position: absolute;
            top: 0;
            left: 50%; /* Initial position */
            width: 3px;
            height: 100%;
            background-color: #00bcd4; /* Teal color */
            cursor: ew-resize;
            transform: translateX(-50%);
            z-index: 50;
        }
        #large-preview-slider-handle::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #00bcd4;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        /* END: NEW STYLES */
    </style>
</head>
<body class="antialiased flex flex-col min-h-screen">

    <div class="flex-grow w-full p-4 md:p-4">
      <header class="w-full flex-shrink-0 py-2 px-4 md:px-6 flex items-center justify-between mb-8 border-b border-gray-700 sticky top-0 bg-opacity-80 backdrop-blur-lg z-50 bg-[#0d1117]">
    <!-- Left Side: Logo & Title -->
    <div class="flex items-center gap-4">
      <a href='https://imgpixelpro.blogspot.com'><img src="https://lh3.googleusercontent.com/d/1v7HUgJoPYfn-oCFp3xm81gb56GQFIA8t" alt="PixelPerfect Pro Logo" class="h-9 w-9 md:h-12 md:w-12 flex-shrink-0"></a>
        <div class="hidden md:block">
            <h1 class="text-2xl font-bold text-white leading-tight">PixelPerfect Pro</h1>
            <div class="flex items-baseline gap-5">
                
                <p class="text-xs text-gray-400 whitespace-nowrap">AI Image Analyze & Enhance</p>
            </div>
              
         
        </div>
        <div class="md:hidden">
             <h1 class="text-xl font-bold text-white">PixelPerfect Pro</h1>
        </div>
    </div>

    <!-- Right Side Content (Desktop) -->
    <div class="hidden md:flex items-center gap-5">
        <!-- All Tools Dropdown -->
        <div class="relative" id="all-tools-dropdown-container">
            <button id="all-tools-btn" onclick="window.openAllTools && window.openAllTools(event)" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold text-gray-300 rounded-lg hover:bg-gray-700 transition-colors">
                <i class="ph ph-arrows-out text-lg"></i>
                <span>All Tools</span>
                <i class="ph ph-caret-down"></i>
            </button>
            <div id="all-tools-dropdown" class="hidden md:hidden absolute top-full mt-2 w-screen max-w-md left-1/2 -translate-x-1/2 md:left-auto md:right-0 md:translate-x-0 md:w-[60rem] md:max-w-none origin-top-right rounded-md bg-[#161b22] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none border border-gray-700 z-[100]">
                 <div class="flex flex-col md:flex-row p-2">
                    <!-- AI Tools Column -->
                    <div class="w-full md:w-1/2 md:pr-2 md:border-r md:border-gray-700">
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">AI Tools</div>
                        <a href="https://img2pixelpro.blogspot.com/p/ai-keyword-description.html" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-file-text"></i><span>AI Keyword & Description</span></a>
                        <a href="https://imgbgremovepro.blogspot.com/" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-eraser text-lg"></i><span>Remove BG Pro</span></a>
                        <a href="https://pixelstudioai.blogspot.com/" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-arrows-out-cardinal text-lg"></i><span>AI-Powered Pixel-Check Studio</span></a>
                        <a href="https://app--pixel-perfect-ai-3f3ef0a0.base44.app" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-shooting-star"></i><span>AI-Image Upscale</span></a>
                        <a href="https://app--microstock-pro-c77f0cba.base44.app" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-magic-wand"></i><span>AI-Analyze for Microstock site</span></a>
                        <a href="https://imggenpro.blogspot.com/" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-magic-wand"></i><span>Text to Image Generator</span></a>
                    </div>
                    <!-- Adjustment Tools Column -->
                    <div class="w-full md:w-1/2 md:pl-2">
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Adjustment Tools</div>
                        <a href="https://bulkeditmultitool.blogspot.com/" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-lightbulb"></i><span>Multi Image Tools</span></a>
                        <a href="#" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-sliders-horizontal text-lg"></i><span>Adjustments</span></a>
                        <a href="#" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-chart-bar text-lg"></i><span>Histogram</span></a>
                        <a href="#" class="flex items-center gap-3 px-3 py-4 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-sparkle text-lg"></i><span>Sharpen / Smart Focus</span></a>
                    </div>
                     <!-- Others Tools Column -->
                    <div class="w-full md:w-1/2 md:pl-2">
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Others Tools</div>
                        <a href="https://onlinemynotepad.blogspot.com/" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-file-text"></i><span>Online Notepad</span></a>
                    </div>
                </div>
            </div>
        </div>
        <!-- Plan Buttons -->
        <div class="hidden md:flex items-center gap-2">
            <button class="px-3 py-1.5 text-xs font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700 transition-colors flex items-center gap-1.5">🎁 <span>Invite friends</span></button>
            <button class="px-3 py-1.5 text-xs font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-1.5">💰 <span>Unlimited credits</span></button>
            <button class="px-3 py-1.5 text-xs font-semibold text-gray-300 bg-gray-700/50 rounded-lg hover:bg-gray-600/50 transition-colors flex items-center gap-1.5">✅ <span>Free plan</span></button>
        </div>
        <!-- Icon Buttons -->
        <div class="hidden md:flex items-center gap-4">
            
            <button class="text-gray-400 hover:text-white transition-colors"><i class="ph ph-gear text-xl"></i></button>
            <div id="auth-section" class="relative">
                <button id="login-button" class="text-gray-400 hover:text-white transition-colors"><i class="ph ph-user-circle text-2xl"></i></button>
                <img id="user-avatar" src="" alt="User Avatar" class="hidden w-8 h-8 rounded-full bg-gray-700 border-2 border-gray-600 cursor-pointer">
                <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-72 origin-top-right rounded-md bg-[#161b22] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none border border-gray-700 z-50">
                     <div class="py-4 px-4">
                        <div class="flex flex-col items-center pb-4 border-b border-gray-700">
                            <img id="user-avatar-dropdown" src="" alt="User Avatar" class="w-16 h-16 rounded-full mb-3 bg-gray-700">
                            <p id="user-name-dropdown" class="text-lg font-semibold text-white">Pramila Das</p>
                            <p id="user-email-dropdown" class="text-sm text-gray-400">pramilacob456@gmail.com</p>
                        </div>
                        <div class="mt-4 space-y-2">
                            <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-users text-lg"></i><span>Switch account</span></a>
                            <a href="#" id="logout-button" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-sign-out text-lg"></i><span>Sign out</span></a>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-700 text-center">
                            <p class="text-xs text-gray-500"><a href="#" class="hover:underline">Privacy Policy</a> &middot; <a href="#" class="hover:underline">Terms of Service</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Hamburger Menu (Mobile) -->
    <div class="md:hidden">
        <button id="mobile-menu-toggle" class="p-2 text-gray-400 hover:text-white">
            <i class="ph ph-list text-3xl"></i>
        </button>
    </div>
    <!-- Mobile Menu Panel -->
    <div id="mobile-menu-content" class="hidden absolute top-full left-0 w-full bg-[#0d1117] border-t border-gray-700 p-4 flex-col gap-4 max-h-[85vh] overflow-y-auto">
        <!-- Buttons will be injected here by JS -->
    </div>
    </header>
    <!-- All Tools Modal (desktop) -->
    <div id="all-tools-modal" class="hidden fixed inset-0 z-[200] bg-black/40 flex items-start justify-center pt-24 px-4 pb-4">
        <div class="relative w-full max-w-5xl rounded-lg border border-gray-700 bg-[#161b22] shadow-2xl">
            <button id="close-all-tools-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <!-- Modal content will be injected here to avoid duplication -->
            <div id="all-tools-modal-content" class="p-2"></div>
        </div>
    </div>
    <!-- Profile Modal (Mobile Only) -->
    <div id="profile-modal" class="hidden fixed inset-0 z-[210] bg-black/50 md:hidden flex items-start justify-center pt-28 px-4 pb-4">
        <div class="relative w-full max-w-sm rounded-lg border border-gray-700 bg-[#161b22] shadow-2xl">
            <button id="close-profile-modal" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div id="profile-modal-body" class="py-6 px-6"></div>
        </div>
    </div>
        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="flex flex-col gap-6">
               <div id="uploadBox" class="requires-login relative card-frosted p-6 rounded-xl flex flex-col items-center justify-center text-center border-2 border-dashed border-gray-700 hover:border-sky-500 transition-all h-96 cursor-pointer">
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <div class="flex flex-col items-center gap-3 text-gray-400">
                     <i class="ph-bold ph-upload-simple text-5xl"></i>
                        <p class="font-semibold">Drag & drop an image here</p>
                        <p class="text-sm">or</p>
                        <button id="browseBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors text-sm">Browse Files</button>
                     </div>
                     <p class="text-sm mt-4 text-gray-500">or paste image URL below</p>
                    <input type="text" id="imageUrl" placeholder="https://..." class="requires-login w-full max-w-sm mt-2 bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all text-center">
                    <!-- Add preview section inside upload box -->
                  <div id="uploadPreview" class="hidden w-full mt-4">
                   <img id="uploadPreviewImage" class="max-h-48 mx-auto object-contain rounded-lg" src="" alt="Upload Preview">
                   </div>
                </div>

                <div id="imagePreviewContainer" class="hidden relative w-full h-96 card-frosted rounded-xl overflow-hidden group">
                  <img id="imagePreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='100%25' height='100%25' fill='%23222b3a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='gray' font-size='24'%3ENo Image%3C/text%3E%3C/svg%3E" alt="Image Preview" class="w-full h-full object-contain">
                    <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                        <button id="viewLargeBtn" class="text-white text-sm bg-black/50 py-2 px-4 rounded-lg hover:bg-black/70 transition-colors">
                            <i class="ph ph-arrows-out"></i> Large Preview
                        </button>
                     </div>
                     <button id="closePreviewBtn" class="absolute top-3 right-3 bg-black/50 text-white rounded-full p-1.5 hover:bg-black/70 transition-colors">
                        <i class="ph ph-x text-lg"></i>
                    </button>
                    <!-- Hover: Image Properties Overlay -->
                    <div id="hoverPropsOverlay" class="absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity">
                        <div class="absolute left-3 bottom-3 bg-black/10 text-white p-3 rounded-lg border border-white/10">
                            <p class="font-semibold text-sm mb-1">Image Properties</p>
                            <div class="text-xs space-y-1">
                                <div>File Name: <span id="hover-tech-prop-filename">N/A</span></div>
                                <div>Dimensions: <span id="hover-tech-prop-dimensions">N/A</span></div>
                                <div>File Size: <span id="hover-tech-prop-filesize">N/A</span></div>
                                <div>Type: <span id="hover-tech-prop-filetype">N/A</span></div>
                            </div>
                        </div>
                    </div>
                 
             </div>
             
             <!-- Recent Files Section (Re-added) -->
             <div id="recentFilesContainer" class="hidden card-frosted p-5 rounded-xl">
                 <h3 class="font-semibold text-white mb-3">Recent Files</h3>
                 <div id="recentFilesGrid" class="grid grid-cols-3 sm:grid-cols-5 gap-3">
                     <!-- Recent file cards will be injected here -->
                 </div>
             </div>

                <div class="card-frosted p-5 rounded-xl flex flex-col gap-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-3 self-start">
                           <label for="ugcToggle" class="text-sm font-medium text-gray-300">Analysis Mode:</label>
                            <div class="flex items-center gap-2 text-sm">
                               <span>Stock</span>
                               <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                    <input type="checkbox" name="toggle" id="ugcToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer">
                                   <label for="ugcToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                            </div>
                               <span>UGC</span>
                           </div>
                       </div>
                       <span id="opencvStatus" class="text-xs text-yellow-400 flex items-center gap-1"><i class="ph ph-spinner animate-spin"></i> OpenCV loading...</span>
                   </div>
                    <div class="mb-2">
                        <label for="enhancePromptType" class="block text-sm font-medium text-gray-300 mb-1">AI Suggestion Mode:</label>
                        <select id="enhancePromptType" class="w-full bg-gray-800 border border-gray-700 text-gray-300 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block p-2.5">
                            <option value="microstock">Microstock Technical Check</option>
                            <option value="aesthetic">General Aesthetic Boost</option>
                            <option value="artistic">Artistic Style Enhancement</option>
                            <option value="fix_common">Fix Common Beginner Issues</option>
                        </select>
                    </div>
                   <div class="w-full grid grid-cols-2 lg:grid-cols-3 gap-3">
                        <button id="analyzeBtn" class="requires-login w-full bg-gradient-to-r from-sky-500 to-indigo-500 hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                           <i class="ph-bold ph-magic-wand"></i> Analyze
                       </button>
                        <button id="enhanceBtn" class="requires-login w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                           <i class="ph-bold ph-shooting-star"></i> Enhance
                       </button>
                        <button id="batchBtn" class="requires-login w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                           <i class="ph-bold ph-stack"></i> Batch
                       </button>
                        <button id="metadataBtn" class="requires-login w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-file-text"></i> Metadata
                        </button>
                        <button id="promptBtn" class="requires-login w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-lightbulb"></i> Prompt
                        </button>
                        <button id="superResolutionBtn" class="requires-login w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-rocket"></i> Super Resolution
                        </button>
                        <button id="localVariationsBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed" title="Generate offline variations using OpenCV">
                            <i class="ph-bold ph-shapes"></i> Local Variations
                        </button>
                   </div>
               </div>
           </div>

            <div id="resultsPanel" class="flex flex-col gap-6">
                <div id="initialState" class="card-frosted p-6 rounded-xl flex flex-col items-center justify-center text-center h-full text-gray-500">
                   <i class="ph-bold ph-chart-bar text-6xl mb-4"></i>
                    <h3 class="font-semibold text-lg text-gray-400">Analysis Results</h3>
                    <p class="text-sm">Your image analysis will appear here.</p>
                </div>
                <div id="loadingState" class="hidden card-frosted p-6 rounded-xl flex flex-col items-center justify-center text-center h-full text-gray-500">
                    <i class="ph ph-spinner animate-spin text-6xl mb-4 text-sky-400"></i>
                    <h3 id="loadingText" class="font-semibold text-lg text-gray-400">Analyzing Image...</h3>
                     <p class="text-sm">Our AI is working its magic. Please wait.</p>
                </div>
                <div id="resultsContent" class="hidden flex flex-col gap-6">
                     <div class="card-frosted p-6 rounded-xl fade-in">
                        <h3 class="font-semibold text-white mb-4">Aesthetic Score</h3>
                        <div class="flex flex-col sm:flex-row items-center gap-6">
                            <div class="relative w-32 h-32">
                                 <svg class="w-full h-full" viewBox="0 0 100 100">
                                    <circle class="text-gray-700" stroke-width="8" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                     <circle id="progressCircle" class="progress-ring__circle text-sky-400" stroke-width="8" stroke-linecap="round" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                </svg>
                                <span id="scoreText" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl font-bold text-white">0%</span>
                             </div>
                            <div id="scoreBreakdown" class="flex-1 space-y-3"></div>
                        </div>
                    </div>
                    <div class="card-frosted p-6 rounded-xl fade-in" style="animation-delay: 200ms;">
                      <h3 class="font-semibold text-white mb-4">Image Quality Insights</h3>
                         <div id="qualityInsights" class="space-y-4"></div>
                    </div>
                    <div class="card-frosted p-6 rounded-xl fade-in" style="animation-delay: 100ms;">
                        <div class="flex justify-between items-center mb-4">
                         <h3 class="font-semibold text-white">Tags & Keywords</h3>
                            <button id="copyTagsBtn" class="text-sm text-sky-400 hover:text-sky-300 flex items-center gap-1">
                                <i class="ph ph-copy"></i> Copy
                            </button>
                        </div>
                        <div id="tagsContainer" class="flex flex-wrap gap-2"></div>
                     </div>
                    
                </div>
            </div>
        </main>
    </div>

     <div id="loginModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="relative bg-gray-900 rounded-xl w-full max-w-sm p-8 shadow-2xl border border-gray-700">
            <button id="closeLoginModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="text-center mb-6">
                <i class="ph-bold ph-sparkle text-4xl gradient-text mx-auto"></i>
                <h2 class="text-2xl font-bold text-white mt-4">Welcome Back</h2>
                <p class="text-gray-400">Sign in to unlock all features.</p>
            </div>
            
            <div class="space-y-3">
                 <button id="google-login-button" class="w-full flex items-center justify-center gap-3 bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors border border-gray-700">
                     <svg class="w-5 h-5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                            <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                            <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                            <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                        </svg>
                        Sign in with Google
                    </button>
                 <button id="github-login-button" class="w-full flex items-center justify-center gap-3 bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors border border-gray-700">
                    <i class="ph ph-github-logo text-xl"></i>
                    Sign in with GitHub
                </button>
            </div>

            <p id="auth-error" class="text-red-400 text-sm mt-4 text-center h-4"></p>
        </div>
    </div>

  <!-- FINAL REVISED CODE FOR ENHANCE MODAL -->
<div id="enhanceModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
    <div class="modal-content w-full h-full md:max-w-6xl md:h-[95vh] md:rounded-2xl p-6 relative flex flex-col">
        <button id="closeEnhanceModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
            <i class="ph ph-x text-2xl"></i>
        </button>
        <div class="flex items-center gap-3 mb-4 shrink-0">
            <i class="ph-bold ph-shooting-star text-2xl gradient-text"></i>
            <h2 class="text-xl font-bold text-white">AI Enhancement</h2>
        </div>
        
        <!-- Main layout container -->
        <div class="flex flex-col md:flex-row gap-6 flex-grow min-h-0">
            
            <!-- Left Column (Image Preview) -->
            <div class="md:w-3/5 flex-shrink-0 h-64 md:h-auto">
                <div id="image-compare-container" class="relative group rounded-lg overflow-hidden border border-gray-700 flex items-center justify-center bg-gray-900/50 w-full h-full">
                   <img id="beforeImageSlider" src="" alt="Original Image" class="absolute inset-0 w-full h-full object-contain pointer-events-none">
                    <div id="afterImageSliderContainer" class="absolute inset-0 h-full overflow-hidden pointer-events-none" style="width: 50%;">
                        <img id="afterImageSlider" src="" alt="Enhanced Image" class="h-full object-contain pointer-events-none" style="max-width: none;">
                    </div>
                    <div id="slider-handle" class="absolute top-0 h-full w-1 bg-sky-400 cursor-col-resize pointer-events-auto z-10" style="left: 50%;">
                        <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-10 h-10 rounded-full bg-white/90 backdrop-blur-sm border-2 border-sky-400 flex items-center justify-center shadow-lg">
                            <i class="ph-bold ph-arrows-left-right text-sky-500 text-xl"></i>
                        </div>
                    </div>
                    <input type="range" id="image-compare-slider" min="0" max="100" value="50" class="absolute inset-0 w-full h-full cursor-col-resize opacity-0 z-20">
                    <button id="enhanceLargePreviewBtn" class="absolute top-3 right-3 bg-black/50 text-white rounded-full p-2 hover:bg-black/70 transition-colors opacity-0 group-hover:opacity-100 z-20" title="Large Preview">
                        <i class="ph ph-arrows-out text-lg"></i>
                    </button>
                    <div class="absolute top-3 left-3 bg-black/50 text-white rounded-lg px-2 py-1 text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        <span class="text-gray-300">Before</span> / <span class="text-sky-400">After</span>
                    </div>
                </div>
                <canvas id="enhancedImagePreview" class="hidden"></canvas>
            </div>

            <!-- Right Column (All Controls in one scrollable container) -->
            <div class="flex flex-col gap-4 md:w-2/5 overflow-y-auto flex-grow min-h-0 pr-2">
                <!-- Action Buttons -->
                <div class="flex flex-col gap-2">
                    <div class="grid grid-cols-2 gap-2">
                        <button id="viewOriginalBtn" class="text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold rounded-lg transition-colors">View Original</button>
                        <button id="viewEnhancedBtn" class="text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-sky-600 hover:bg-sky-500 text-white font-semibold rounded-lg transition-colors">View Enhanced</button>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button id="cropBtn" title="Crop and resize image" class="text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-green-600 hover:bg-green-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-1 md:gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-crop"></i> Crop
                        </button>
                        <button id="objectRemovalBtn" title="Remove objects from the image" class="text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-purple-600 hover:bg-purple-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-1 md:gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-eraser"></i> Removal
                        </button>
                        <button id="reimagineBtn" title="Create variations of the image" class="text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-orange-600 hover:bg-orange-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-1 md:gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="ph-bold ph-sparkle"></i> Reimagine
                        </button>
                    </div>
                    <div class="flex">
                        <button id="resetEnhancementsBtn" class="w-full text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-red-800 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2">
                            <i class="ph ph-arrow-counter-clockwise"></i> Reset
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative">
                            <button id="normalUpscaleToggleBtn" class="w-full text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-gray-600 hover:bg-gray-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="upscale-text">Upscale</span>
                                <i class="ph ph-spinner animate-spin upscale-spinner hidden"></i>
                                <i class="ph ph-caret-down upscale-icon"></i>
                            </button>
                            <div id="normalUpscaleDropdown" class="hidden absolute bottom-full left-0 mb-2 w-full bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-20 p-1 space-y-1">
                                <button id="normalUpscale2xBtn" title="Upscale 2x using standard algorithm" class="w-full text-sm hover:bg-gray-700 text-white font-semibold px-3 py-1.5 rounded-md transition-colors flex items-center justify-center gap-2">2X Upscale</button>
                                <button id="normalUpscale4xBtn" title="Upscale 4x using standard algorithm" class="w-full text-sm hover:bg-gray-700 text-white font-semibold px-3 py-1.5 rounded-md transition-colors flex items-center justify-center gap-2">4X Upscale</button>
                            </div>
                        </div>
                        <div class="relative">
                            <button id="aiUpscaleToggleBtn" class="w-full text-xs px-2 py-1.5 md:text-sm md:px-3 md:py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-semibold rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <span class="upscale-text">AI Upscale</span>
                                <i class="ph ph-spinner animate-spin upscale-spinner hidden"></i>
                                <i class="ph ph-caret-down upscale-icon"></i>
                            </button>
                            <div id="aiUpscaleDropdown" class="hidden absolute bottom-full right-0 mb-2 w-full bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-20 p-1 space-y-1">
                                <button id="aiUpscale2xBtn" title="Upscale 2x using AI" class="w-full text-sm hover:bg-indigo-700 text-white font-semibold px-3 py-1.5 rounded-md transition-colors flex items-center justify-center gap-2">AI 2X</button>
                                <button id="aiUpscale4xBtn" title="Upscale 4x using AI" class="w-full text-sm hover:bg-indigo-700 text-white font-semibold px-3 py-1.5 rounded-md transition-colors flex items-center justify-center gap-2">AI 4X</button>
                            </div>
                        </div>
                    </div>
                    <button id="downloadEnhancedBtn" class="w-full text-center bg-sky-600 hover:bg-sky-500 text-white font-bold text-sm py-2 px-3 md:text-base md:py-3 md:px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <i class="ph ph-download-simple text-lg md:text-xl"></i> Download
                    </button>
                </div>
                
                <!-- Separator -->
                <div class="border-t border-gray-700 my-2"></div>

                <!-- Properties, Suggestions, and Sliders -->
                <div class="flex flex-col gap-6">
                    <div>
                        <h3 class="font-semibold text-white mb-3">Image Properties</h3>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-400">
                            <div><strong>File Name:</strong></div>
                            <div id="tech-prop-filename" class="truncate text-right text-gray-300" title="N/A">N/A</div>
                            <div><strong>Dimensions:</strong></div>
                            <div id="tech-prop-dimensions" class="truncate text-right text-gray-300">N/A</div>
                            <div><strong>File Size:</strong></div>
                            <div id="tech-prop-filesize" class="truncate text-right text-gray-300">N/A</div>
                            <div><strong>Type:</strong></div>
                            <div id="tech-prop-filetype" class="truncate text-right text-gray-300">N/A</div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-semibold text-white">AI Enhancement Suggestions</h3>
                            <button id="recheckImageBtn" class="bg-teal-600 hover:bg-teal-500 text-white font-semibold px-3 py-1.5 rounded-lg transition-colors text-xs flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="ph ph-check-square-offset"></i> Re-check Image
                            </button>
                        </div>
                        <div id="enhanceSuggestions" class="space-y-3 text-sm">
                            <p class="text-gray-500">Click the "Suggestions" button to generate ideas.</p>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-white text-base font-bold tracking-wide">Manual Adjustments</h4>
                            <button id="resetSlidersBtn" class="bg-sky-800 hover:bg-sky-700 text-white font-bold px-3 py-1 rounded-md text-xs shadow transition-colors">Reset Sliders</button>
                        </div>
                        <div class="flex flex-col gap-4">
                            <!-- All slider inputs go here -->
                                <div class="flex flex-col gap-1">
                                    <label for="slider-exposure" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                                        <span>Exposure</span><span id="sliderVal-exposure" class="text-sky-400 font-mono">0</span>
                                    </label>
                                    <input id="slider-exposure" type="range" min="-100" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                                </div>
                                <div>
                                    <label for="slider-highlights" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                                        <span>Highlights</span><span id="sliderVal-highlights" class="text-sky-400 font-mono">0</span>
                                    </label>
                                    <input id="slider-highlights" type="range" min="-100" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                                </div>
                                <div>
                                    <label for="slider-shadows" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                                        <span>Shadows</span><span id="sliderVal-shadows" class="text-sky-400 font-mono">0</span>
                                    </label>
                                    <input id="slider-shadows" type="range" min="-100" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                                </div>
                                <div>
                                    <label for="slider-vignette" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                                        <span>Vignette</span><span id="sliderVal-vignette" class="text-sky-400 font-mono">0</span>
                                    </label>
                                    <input id="slider-vignette" type="range" min="0" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label for="slider-brightness" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                                        <span>Brightness</span><span id="sliderVal-brightness" class="text-sky-400 font-mono">0</span>
                                    </label>
                                    <input id="slider-brightness" type="range" min="-100" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Contrast <span id="sliderVal-contrast" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="slider-contrast" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Blur / Sharpen <span id="sliderVal-blur" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="slider-blur" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Denoise <span id="sliderVal-denoise" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="0" max="100" value="0" id="slider-denoise" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Saturation <span id="sliderVal-saturation" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="slider-saturation" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Temperature <span id="sliderVal-temperature" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="slider-temperature" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Vibrance <span id="sliderVal-vibrance" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="slider-vibrance" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
    <!-- Crop Modal -->
    <div id="cropModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-[80] hidden">
        <div class="modal-content max-w-6xl w-full rounded-2xl p-4 md:p-6 relative flex flex-col h-[95vh] gap-4">
            <button id="closeCropModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="flex items-center gap-3 shrink-0">
                <i class="ph-bold ph-crop text-2xl gradient-text"></i>
                <h2 class="text-xl font-bold text-white">Crop & Resize Image</h2>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-4 flex-grow min-h-0">
                <!-- Left Side: Image Canvas -->
                <div id="crop-image-container" class="lg:col-span-3 bg-gray-900/50 rounded-lg border border-gray-700 flex items-center justify-center overflow-hidden relative">
                     <img id="cropImage" src="" alt="Image to crop">
                </div>

                <!-- Right Side: Controls -->
                <div class="lg:col-span-1 flex flex-col gap-4 bg-gray-900/70 rounded-xl border border-gray-800 p-4 overflow-y-auto">
                    <div>
                        <h3 class="font-semibold text-white mb-2">Aspect Ratio</h3>
                        <div class="grid grid-cols-3 gap-2">
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="NaN">Free</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="1">1:1</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="1.3333">4:3</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="0.75">3:4</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="1.5">3:2</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="0.6666">2:3</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="1.7777">16:9</button>
                            <button class="crop-ratio-btn text-sm bg-gray-700 hover:bg-sky-600 p-2 rounded-md" data-ratio="0.5625">9:16</button>
                        </div>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                         <h3 class="font-semibold text-white mb-2">Actions</h3>
                         <div class="grid grid-cols-2 gap-2">
                             <button id="crop-action-zoom-in" title="Zoom In" class="text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md flex justify-center items-center"><i class="ph ph-plus text-lg"></i></button>
                             <button id="crop-action-zoom-out" title="Zoom Out" class="text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md flex justify-center items-center"><i class="ph ph-minus text-lg"></i></button>
                             <button id="crop-action-rotate-left" title="Rotate Left" class="text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md flex justify-center items-center"><i class="ph ph-arrow-counter-clockwise text-lg"></i></button>
                             <button id="crop-action-rotate-right" title="Rotate Right" class="text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md flex justify-center items-center"><i class="ph ph-arrow-clockwise text-lg"></i></button>
                             <button id="crop-action-flip-h" title="Flip Horizontal" class="text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md flex justify-center items-center"><i class="ph ph-swap text-lg -scale-x-100"></i></button>
                             <button id="crop-action-flip-v" title="Flip Vertical" class="text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md flex justify-center items-center"><i class="ph ph-swap text-lg rotate-90"></i></button>
                         </div>
                    </div>
                    <div class="flex flex-col gap-2 mt-auto">
                         <button id="cropResetBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                            <i class="ph ph-arrow-u-up-left"></i> Reset
                        </button>
                        <button id="applyCropBtn" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                           <i class="ph-bold ph-check"></i> Apply Crop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Object Removal Modal -->
   <div id="objectRemovalModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-[70] hidden">
    <div class="modal-content max-w-6xl w-full rounded-2xl p-6 relative flex flex-col h-[95vh] gap-4">
        <button id="closeObjectRemovalModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
            <i class="ph ph-x text-2xl"></i>
        </button>
        <div class="flex items-center gap-3 shrink-0">
            <i class="ph-bold ph-eraser text-2xl gradient-text"></i>
            <h2 class="text-xl font-bold text-white">Object Removal</h2>
        </div>
        
        <!-- FIXED: Responsive layout for Object Removal -->
        <div class="flex flex-col md:flex-row gap-4 flex-grow min-h-0">
            <!-- Left Side: Canvas (FIXED height on mobile) -->
            <div id="removal-canvas-container" class="h-80 md:h-auto flex-shrink-0 md:flex-shrink md:w-3/4 flex-grow bg-gray-900/50 rounded-lg border border-gray-700 flex items-center justify-center overflow-hidden relative">
                 <canvas id="removalImageCanvas" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></canvas>
                 <canvas id="removalMaskCanvas" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 cursor-crosshair"></canvas>
                 <div id="removalLoadingOverlay" class="hidden absolute inset-0 bg-black/70 flex flex-col items-center justify-center text-white z-30">
                    <i class="ph ph-spinner animate-spin text-5xl mb-4"></i>
                    <p>Removing object, please wait...</p>
                 </div>
            </div>

            <!-- Right Side: Controls (FIXED to grow and scroll on mobile) -->
            <div class="md:w-1/4 flex flex-col gap-4 bg-gray-900/70 rounded-xl border border-gray-800 p-4 overflow-y-auto flex-grow min-h-0">
                <div>
                    <h3 class="font-semibold text-white mb-2">Instructions</h3>
                    <p class="text-sm text-gray-400">1. Use your mouse to paint over the object you want to remove.</p>
                    <p class="text-sm text-gray-400">2. Adjust brush size as needed.</p>
                    <p class="text-sm text-gray-400">3. Click "Remove Object" to process.</p>
                </div>
                <div class="border-t border-gray-700 pt-4">
                    <label for="brushSizeSlider" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                        <span>Brush Size</span><span id="brushSizeValue" class="text-sky-400 font-mono">20</span>
                    </label>
                    <input id="brushSizeSlider" type="range" min="5" max="100" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                </div>

                <div class="flex flex-col gap-2 mt-auto">
                     <button id="clearMaskBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                        <i class="ph ph-arrow-counter-clockwise"></i> Clear Mask
                    </button>
                    <button id="removeObjectBtn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                       <i class="ph-bold ph-magic-wand"></i> Remove Object
                    </button>
                     <button id="saveRemovedObjectBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                       <i class="ph ph-download-simple"></i> Save & Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
    <div id="metadataModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
         <div class="modal-content max-w-2xl w-full rounded-2xl p-6 relative flex flex-col">
            <button id="closeMetadataModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="flex justify-between items-center mb-4 shrink-0">
                <div class="flex items-center gap-3">
                    <i class="ph-bold ph-file-text text-2xl gradient-text"></i>
                    <h2 class="text-xl font-bold text-white">Image to SEO Metadata</h2>
                </div>
                <button id="exportMetadataBtn" class="bg-teal-600 hover:bg-teal-500 text-white font-semibold px-3 py-1.5 rounded-lg transition-colors text-sm flex items-center gap-2">
                    <i class="ph ph-export"></i> Export CSV
                </button>
            </div>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-col items-center justify-center w-full md:w-1/3">
                    <img id="metadataThumb" class="w-full max-w-xs aspect-square object-cover rounded-lg border border-gray-700 shadow" src="" alt="Image Preview">
                    <div id="metadataFileName" class="mt-2 text-xs text-gray-400 break-all text-center"></div>
                </div>
                <div id="metadataContent" class="flex-1 space-y-4 overflow-y-auto md:w-2/3">
                    <p class="text-gray-400">Click the button to generate metadata.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="promptModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content max-w-2xl w-full rounded-2xl p-6 relative flex flex-col">
            <button id="closePromptModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10">
                <i class="ph ph-x text-2xl"></i>
            </button>
             <div class="flex items-center gap-3 mb-4 shrink-0">
                <i class="ph-bold ph-lightbulb text-2xl gradient-text"></i>
                <h2 class="text-xl font-bold text-white">Image to Prompt</h2>
            </div>
           <div class="flex flex-col md:flex-row gap-6">
                <div class="flex flex-col items-center justify-center w-full md:w-1/3">
                    <img id="promptThumb" class="w-full max-w-xs aspect-square object-cover rounded-lg border border-gray-700 shadow" src="" alt="Image Preview">
                    <div id="promptFileName" class="mt-2 text-xs text-gray-400 break-all text-center"></div>
                </div>
                <div class="flex-1 md:w-2/3">
                    <div class="bg-gray-900/70 border border-gray-700 rounded-lg p-4 h-64 overflow-y-auto">
                        <p id="promptContent" class="text-gray-300 whitespace-pre-wrap">Click the button to generate a prompt.</p>
                    </div>
                     <button id="copyPromptBtn" class="mt-4 bg-sky-600 hover:bg-sky-500 text-white font-semibold px-3 py-1.5 rounded-lg transition-colors text-sm flex items-center gap-2">
                        <i class="ph ph-copy"></i> Copy Prompt
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="enhanceLargePreviewModal" class="fixed inset-0 bg-black/80 flex flex-col items-center justify-center z-[100] hidden p-4">
        <div class="relative rounded-lg overflow-hidden bg-transparent" style="width: 90vw; height: 90vh; max-width: 1200px;">
            <div id="modal-zoom-container" class="relative w-full h-full flex items-center justify-center overflow-hidden">
                <img id="enhanceLargeImage" class="block max-w-full max-h-full object-contain cursor-grab transition-transform duration-200" src="" alt="Large Preview">
            </div>
            <div class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black/50 rounded-full p-2 flex items-center gap-2">
                <button id="modal-zoom-out-btn" class="text-white p-2 rounded-full hover:bg-white/20"><i class="ph ph-minus text-xl"></i></button>
                <span id="modal-zoom-level-text" class="text-white font-mono text-sm w-12 text-center">100%</span>
                <button id="modal-zoom-in-btn" class="text-white p-2 rounded-full hover:bg-white/20"><i class="ph ph-plus text-xl"></i></button>
                <button id="modal-zoom-reset-btn" class="text-white p-2 rounded-full hover:bg-white/20"><i class="ph ph-arrows-counter-clockwise text-xl"></i></button>
            </div>
            <button id="closeEnhanceLargePreviewBtn" class="absolute top-4 right-4 bg-black/50 text-white rounded-full p-2 hover:bg-black/70 transition-colors">
                <i class="ph ph-x text-2xl"></i>
             </button>
        </div>
    </div>

    <!-- START: NEW ENHANCED PREVIEW MODAL -->
    <div id="beforeAfterLargePreviewModal" class="fixed inset-0 bg-black/90 flex items-center justify-center z-[100] hidden p-0 transition-opacity duration-300 overflow-hidden">
        <div id="large-preview-container" class="relative rounded-lg overflow-hidden flex flex-col bg-gray-900/50" style="width: 90vw; height: 90vh; max-width: 1200px;">
            <!-- Main View Area -->
            <div class="relative w-full flex-grow flex items-center justify-center overflow-hidden bg-gray-900/50 cursor-grab">

                <!-- PEEK VIEW PANE -->
                <div id="peek-view-pane" class="viewer-pane active">
                    <img id="peek-image" src="" alt="Adjusted preview" draggable="false">
                    <div class="viewer-label">Adjusted</div>
                </div>
                
                <!-- SLIDER VIEW PANE -->
                <div id="slider-view-pane" class="viewer-pane">
                    <div class="absolute inset-0 flex items-center justify-center">
                        <img id="slider-before-image" src="" alt="Before" draggable="false">
                        <div class="viewer-label">Original</div>
                    </div>
                    <div id="slider-after-container" class="absolute inset-0 flex items-center justify-center overflow-hidden" style="clip-path: polygon(0 0, 50% 0, 50% 100%, 0 100%);">
                        <img id="slider-after-image" src="" alt="After" draggable="false">
                        <div class="viewer-label">Adjusted</div>
                    </div>
                    <div id="large-preview-slider-handle" class="absolute top-0 h-full w-1 bg-cyan-400 cursor-ew-resize z-10 shadow-lg"></div>
                </div>
                
                <!-- SPLIT VIEW PANE -->
                <div id="split-view-pane" class="viewer-pane">
                    <div id="split-before-container">
                        <img id="split-before-image" src="" alt="Before" draggable="false">
                        <div class="viewer-label">Original</div>
                    </div>
                    <div id="split-after-container">
                        <img id="split-after-image" src="" alt="After" draggable="false">
                        <div class="viewer-label">Adjusted</div>
                    </div>
                </div>
            </div>

            <!-- Toolbar -->
            <div id="preview-toolbar">
                <button id="peek-view-btn" class="toolbar-btn" title="Peek View"><i class="ph-bold ph-eye"></i>Peek</button>
                <button id="slider-view-btn" class="toolbar-btn" title="Slider View"><i class="ph-bold ph-sliders"></i>Slider</button>
                <button id="split-view-btn" class="toolbar-btn" title="Split View"><i class="ph-bold ph-columns"></i>Split</button>
                <div class="toolbar-divider"></div>
                <button id="zoom-out-btn" class="toolbar-btn" title="Zoom Out"><i class="ph-bold ph-minus"></i></button>
                <span id="zoom-level-display">100%</span>
                <button id="zoom-in-btn" class="toolbar-btn" title="Zoom In"><i class="ph-bold ph-plus"></i></button>
                <div class="toolbar-divider"></div>
                <button id="reset-view-btn" class="toolbar-btn" title="Reset View"><i class="ph-bold ph-arrow-counter-clockwise"></i>Reset</button>
            </div>
            
            <button id="close-large-preview" class="absolute top-4 right-4 bg-red-600/80 text-white rounded-full p-1.5 hover:bg-red-700 z-[101] leading-none">
                <i class="ph-bold ph-x text-xl"></i>
            </button>
        </div>
    </div>
    <!-- END: NEW ENHANCED PREVIEW MODAL -->

    <!-- Batch Processing Modal (UPDATED) -->
    <div id="batchModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content max-w-6xl w-full rounded-2xl p-6 relative flex flex-col h-[95vh] gap-4">
            <button id="closeBatchModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="flex items-center gap-3 shrink-0 mb-0">
                <i class="ph-bold ph-stack text-2xl gradient-text"></i>
                <h2 class="text-xl font-bold text-white">Batch Processing</h2>
            </div>
    
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow min-h-0">
                <!-- Left Side: Queue & Preview (UPDATED) -->
                <div class="flex flex-col gap-4 bg-gray-900/50 rounded-lg border border-gray-700 p-4 h-full min-h-0">
                    
                    <!-- Upload Box (can be hidden) -->
                    <div id="batchUploadBox" class="relative p-4 rounded-xl flex flex-col items-center justify-center text-center border-2 border-dashed border-gray-600 hover:border-sky-500 transition-all h-48 cursor-pointer flex-shrink-0">
                        <input type="file" id="batchImageUpload" class="hidden" accept="image/*" multiple>
                        <div class="flex flex-col items-center gap-2 text-gray-400">
                            <i class="ph-bold ph-upload-simple text-4xl"></i>
                            <p class="font-semibold text-sm">Drag & drop images here</p>
                            <p class="text-xs">or</p>
                            <button id="batchBrowseBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-3 py-1.5 rounded-lg transition-colors text-xs">Browse Files</button>
                        </div>
                    </div>

                    <!-- Large Preview with Slider (hidden by default) -->
                    <div id="batchPreviewContainer" class="hidden relative group rounded-lg overflow-hidden border border-gray-700 h-64 flex-shrink-0 flex items-center justify-center bg-gray-900/50">
                        <img id="batch-beforeImageSlider" src="" alt="Original Batch Image" class="absolute inset-0 w-full h-full object-contain pointer-events-none">
                        <div id="batch-afterImageSliderContainer" class="absolute inset-0 h-full overflow-hidden pointer-events-none" style="width: 50%;">
                            <!-- MODIFIED: removed 'object-contain' class for smoother sliding -->
                            <img id="batch-afterImageSlider" src="" alt="Enhanced Batch Image" class="h-full pointer-events-none" style="max-width: none;">
                        </div>
                        <div id="batch-slider-handle" class="absolute top-0 h-full w-1 bg-sky-400 cursor-col-resize pointer-events-auto z-10" style="left: 50%;">
                            <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-8 h-8 rounded-full bg-white/90 backdrop-blur-sm border-2 border-sky-400 flex items-center justify-center shadow-lg">
                                <i class="ph-bold ph-arrows-left-right text-sky-500 text-lg"></i>
                            </div>
                        </div>
                        <input type="range" id="batch-image-compare-slider" min="0" max="100" value="50" class="absolute inset-0 w-full h-full cursor-col-resize opacity-0 z-20">
                        <button id="closeBatchPreviewBtn" class="absolute top-2 right-2 bg-black/50 text-white rounded-full p-1 hover:bg-black/70 transition-colors z-20" title="Close Preview">
                            <i class="ph ph-x"></i>
                        </button>
                    </div>
    
                    <div class="flex justify-between items-center flex-shrink-0">
                        <h3 class="font-semibold text-white">Image Queue (<span id="batchQueueCount">0</span>)</h3>
                        <div class="flex items-center gap-2">
                             <button id="batchAddMoreBtn" class="text-sm text-sky-400 hover:text-sky-300">Add More</button>
                            <button id="batchClearQueueBtn" class="text-sm text-red-400 hover:text-red-300">Clear All</button>
                        </div>
                    </div>
                    <div id="batchQueueList" class="flex-grow overflow-y-auto space-y-2 pr-2">
                        <p class="text-center text-gray-500 pt-8">Upload images to start.</p>
                    </div>
                </div>
    
                <!-- Right Side: Controls -->
                <div class="flex flex-col gap-4 overflow-hidden min-h-0">
                     <div class="flex flex-col bg-gray-900/70 rounded-xl border border-gray-800 p-4 overflow-y-auto">
                        <!-- Quick Adjustments Section -->
                        <div class="mb-4">
                            <h4 class="text-white text-base font-bold tracking-wide mb-3">Quick Adjustments</h4>
                            <div class="flex flex-wrap gap-2">
                                <button class="batch-preset-btn text-xs bg-gray-700 hover:bg-sky-600 px-3 py-1.5 rounded-md" data-settings='{"brightness": 5, "contrast": 5, "saturation": 5, "blur": 5}'>Auto-Enhance</button>
                                <button class="batch-preset-btn text-xs bg-gray-700 hover:bg-sky-600 px-3 py-1.5 rounded-md" data-settings='{"brightness": 0, "contrast": 10, "saturation": 15, "blur": 0}'>Vibrant</button>
                                <button class="batch-preset-btn text-xs bg-gray-700 hover:bg-sky-600 px-3 py-1.5 rounded-md" data-settings='{"brightness": 8, "contrast": 5, "saturation": -5, "blur": 0}'>Portrait</button>
                                <button class="batch-preset-btn text-xs bg-gray-700 hover:bg-sky-600 px-3 py-1.5 rounded-md" data-settings='{"brightness": 0, "contrast": 10, "saturation": 10, "blur": 8}'>Landscape</button>
                                <button class="batch-preset-btn text-xs bg-gray-700 hover:bg-red-600 px-3 py-1.5 rounded-md" data-settings='{"brightness": 0, "contrast": 0, "saturation": 0, "blur": 0}'>Reset</button>
                            </div>
                        </div>
    
                        <div class="border-t border-gray-700 pt-4 mb-0">
                            <h4 class="text-white text-base font-bold tracking-wide mb-3">Manual Adjustments (Applied to all images)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Brightness <span id="batchSliderVal-brightness" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="batch-slider-brightness" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Contrast <span id="batchSliderVal-contrast" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="batch-slider-contrast" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Saturation <span id="batchSliderVal-saturation" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="-100" max="100" value="0" id="batch-slider-saturation" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                                <div class="flex flex-col gap-1">
                                    <label class="text-xs text-gray-300 flex justify-between">Sharpen <span id="batchSliderVal-blur" class="font-semibold text-sky-400">0</span></label>
                                    <input type="range" min="0" max="100" value="0" id="batch-slider-blur" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                                </div>
                            </div>
                        </div>
                       
                       <!-- START: MODIFIED ADDITIONAL PROCESSING SECTION -->
<div class="border-t border-gray-700 pt-4 mb-4">
    <h4 class="text-white text-base font-bold tracking-wide mb-3">Additional Processing</h4>
    <div class="space-y-3">
        <!-- Generate Metadata Toggle -->
        <div class="flex items-center justify-between bg-gray-800/50 p-2 rounded-lg">
            <label for="batchGenerateMetadata" class="text-sm font-medium text-gray-300 cursor-pointer flex items-center gap-2">
                <i class="ph ph-file-text"></i> Generate Metadata (Title, Keywords)
            </label>
            <div class="relative inline-block w-10 align-middle select-none">
                <input type="checkbox" name="toggle" id="batchGenerateMetadata" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                <label for="batchGenerateMetadata" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
            </div>
        </div>

        <!-- Add Watermark Section -->
        <div class="bg-gray-800/50 p-3 rounded-lg space-y-3">
            <div class="flex items-center justify-between">
                <label for="batchAddWatermark" class="text-sm font-medium text-gray-300 cursor-pointer flex items-center gap-2">
                    <i class="ph ph-stamp"></i> Add Watermark
                </label>
                <div class="relative inline-block w-10 align-middle select-none">
                    <input type="checkbox" name="toggle" id="batchAddWatermark" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                    <label for="batchAddWatermark" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-600 cursor-pointer"></label>
                </div>
            </div>
            
            <!-- Watermark Options (Hidden by default) -->
            <div id="batchWatermarkOptions" class="hidden pt-3 border-t border-gray-700 space-y-4">
                <!-- Watermark Type -->
                <div>
                    <label class="text-xs font-medium text-gray-400 mb-2 block">Watermark Type</label>
                    <div class="flex items-center gap-4">
                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                            <input type="radio" name="batchWatermarkType" value="text" class="accent-sky-400" checked> Text
                        </label>
                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                            <input type="radio" name="batchWatermarkType" value="image" class="accent-sky-400"> Image
                        </label>
                    </div>
                </div>

                <!-- Text Watermark Options -->
                <div id="batchWatermarkTextOptions">
                    <input type="text" id="batchWatermarkText" placeholder="Your watermark text..." class="w-full bg-gray-900 border border-gray-700 text-gray-300 text-sm rounded-lg block p-2">
                </div>

                <!-- Image Watermark Options -->
                <div id="batchWatermarkImageOptions" class="hidden">
                    <input type="file" id="batchWatermarkImageUpload" class="hidden" accept="image/png, image/svg+xml">
                    <button id="batchWatermarkImageBtn" class="w-full text-sm bg-gray-700 hover:bg-gray-600 p-2 rounded-md">Upload Watermark Image</button>
                    <img id="batchWatermarkPreview" src="" alt="Watermark Preview" class="hidden mt-2 max-h-16 mx-auto bg-white/10 p-1 rounded">
                </div>
                
                <!-- Common Watermark Settings -->
                <div>
                    <label for="batchWatermarkSize" class="text-xs text-gray-300 flex justify-between">Size 
                        (<span id="batchWatermarkSizeValue" class="font-semibold text-sky-400">10</span>%)
                    </label>
                    <input type="range" min="2" max="50" value="10" id="batchWatermarkSize" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                </div>
                <div>
                    <label for="batchWatermarkOpacity" class="text-xs text-gray-300 flex justify-between">Opacity 
                        <span id="batchWatermarkOpacityValue" class="font-semibold text-sky-400">0.7</span>
                    </label>
                    <input type="range" min="0.1" max="1" value="0.7" step="0.05" id="batchWatermarkOpacity" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
                </div>
                 <div>
                    <label for="batchWatermarkPosition" class="text-xs font-medium text-gray-400 mb-1 block">Position</label>
                    <select id="batchWatermarkPosition" class="w-full bg-gray-800 border border-gray-700 text-gray-300 text-sm rounded-lg block p-2">
                        <option value="bottom-right">Bottom Right</option>
                        <option value="bottom-left">Bottom Left</option>
                        <option value="top-right">Top Right</option>
                        <option value="top-left">Top Left</option>
                        <option value="center">Center</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- END: MODIFIED ADDITIONAL PROCESSING SECTION -->
                       
                        <div class="border-t border-gray-700 pt-4 mb-4">
                            <h4 class="text-white text-base font-bold tracking-wide mb-3">Upscale (Applied after adjustments)</h4>
                            <select id="batchUpscaleSelect" class="w-full bg-gray-800 border border-gray-700 text-gray-300 text-sm rounded-lg focus:ring-sky-500 focus:border-sky-500 block p-2.5">
                                <option value="none">None</option>
                                <option value="normal_2x">Normal Upscale 2X</option>
                                <option value="normal_4x">Normal Upscale 4X</option>
                                <option value="ai_2x">AI Upscale 2X</option>
                                <option value="ai_4x">AI Upscale 4X</option>
                            </select>
                        </div>
                        
                        <div class="mt-auto pt-4 border-t border-gray-700 space-y-3">
                             <div id="batchProgress" class="text-center text-gray-400 h-5"></div>
                             <button id="startBatchProcessBtn" class="w-full bg-gradient-to-r from-sky-500 to-indigo-500 hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                               <i class="ph-bold ph-play"></i> Start Processing
                             </button>
                             <button id="downloadMetadataCsvBtn" class="w-full bg-teal-600 hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                             <i class="ph ph-export"></i> Download Metadata (CSV)
                            </button>
                             <button id="downloadBatchZipBtn" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="ph ph-download-simple"></i> Download Results (ZIP)
                            </button>
                        </div>
                     </div>
                </div>
            </div>
        </div>
    </div>


    <div id="toast-notification"></div>

    <!-- Download Format Modal -->
    <div id="downloadModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60] hidden">
        <div class="modal-content bg-gray-900 border border-gray-700 rounded-2xl p-6 relative flex flex-col gap-4 w-full max-w-sm text-center shadow-2xl">
            <button id="closeDownloadModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors">
                <i class="ph ph-x text-xl"></i>
            </button>
            <div class="flex flex-col items-center gap-2">
                <i class="ph-bold ph-download-simple text-3xl gradient-text"></i>
                <h3 class="text-lg font-bold text-white">Select Download Format</h3>
                <p class="text-sm text-gray-400">Choose your preferred image format.</p>
            </div>
            
            <!-- JPG Quality Slider -->
            <div id="jpgQualitySection" class="w-full text-left">
                <label for="jpgQualitySlider" class="flex justify-between items-center text-sm font-medium text-gray-300 mb-1">
                    <span>JPG Quality</span><span id="jpgQualityValue" class="text-sky-400 font-mono">95%</span>
                </label>
                <input id="jpgQualitySlider" type="range" min="70" max="100" value="95" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-sky-400">
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-2">
                <button id="downloadJpgBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    JPG
                </button>
                <button id="downloadPngBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2">
                    PNG
                </button>
            </div>
        </div>
    </div>
    
    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden fade-in">
        <div class="relative modal-content w-full max-w-md p-6 rounded-xl">
            <button id="closeApiKeyModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="text-center mb-6">
                <i class="ph-bold ph-key text-4xl gradient-text mx-auto"></i>
                <h2 class="text-2xl font-bold text-white mt-4">Manage API Keys</h2>
                <p class="text-gray-400">Your keys are stored securely in your browser.</p>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="geminiApiKeyInput" class="block text-sm font-medium text-gray-300 mb-2">Gemini API Key</label>
                    <input type="password" id="geminiApiKeyInput" placeholder="Enter your Gemini API key" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all">
                  <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-indigo-600 hover:underline">Get Key</a>
                </div>
                <div>
                    <label for="clipdropApiKeyInput" class="block text-sm font-medium text-gray-300 mb-2">ClipDrop API Key (for Removal & Reimagine)</label>
                    <input type="password" id="clipdropApiKeyInput" placeholder="Enter your ClipDrop API key" class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all">
                  <a href="https://clipdrop.co/apis" target="_blank" class="text-xs text-indigo-500 hover:underline">Get Key</a>
                </div>
                <div class="mt-6">
                    <button id="saveApiKeysBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors">
                        Save Keys
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Super Resolution Modal -->
    <div id="superResolutionModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content w-full h-full md:max-w-6xl md:h-[95vh] md:rounded-2xl p-6 relative flex flex-col md:flex-row gap-6 overflow-y-auto border border-gray-700 bg-gray-900/90">
            <button id="closeSuperResolutionModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
                <i class="ph ph-x text-2xl"></i>
            </button>

            <!-- Left Controls Column -->
            <div class="flex flex-col gap-4 w-full md:w-80 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="ph-bold ph-rocket text-2xl gradient-text"></i>
                    <h2 class="text-xl font-bold text-white">AI Enhance & Super Resolution</h2>
                </div>

                <!-- Upload -->
                <div id="srUploadBox" class="relative p-6 rounded-xl flex flex-col items-center justify-center text-center border-2 border-dashed border-gray-600 hover:border-sky-500 transition-all cursor-pointer flex-grow md:flex-grow-0 h-48">
                    <input type="file" id="srImageUpload" class="hidden" accept="image/*">
                    <div class="flex flex-col items-center gap-2 text-gray-400">
                        <i class="ph-bold ph-upload-simple text-4xl"></i>
                        <p class="font-semibold text-sm">Upload Image</p>
                        <p class="text-xs">or drag & drop</p>
                    </div>
                </div>
                <div id="srUploadPreviewContainer" class="hidden relative w-full h-48">
                <img id="srUploadPreview" src="" alt="SR Upload Preview" class="w-full h-full object-contain rounded-lg border border-gray-700">
                <button id="srRemoveImageBtn" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1 leading-none hover:bg-red-600 z-10" title="Remove Image">
                <i class="ph ph-x text-md pointer-events-none"></i>
                </button>
                </div>

                <!-- Mode -->
                <div>
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Mode</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="srModeEnhance" class="sr-mode-btn bg-purple-700 text-white font-semibold py-2 rounded-lg">Enhance</button>
                        <button id="srModeSuperResolution" class="sr-mode-btn bg-gray-700 text-white font-semibold py-2 rounded-lg">Super Resolution</button>
                    </div>
                </div>
                
                <!-- Scale -->
                <div id="srScaleContainer">
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Scale</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="srScale2x" class="sr-scale-btn bg-gray-700 text-white font-semibold py-2 rounded-lg">2X</button>
                        <button id="srScale4x" class="sr-scale-btn bg-gray-700 text-white font-semibold py-2 rounded-lg">4X</button>
                    </div>
                    <div class="mt-3 flex items-start gap-2">
                        <input id="srForceFull" type="checkbox" class="mt-1.5 h-4 w-4 rounded border-gray-600 bg-gray-900/50">
                        <label for="srForceFull" class="text-xs text-gray-400">Force full 2X/4X output (disables mobile safety caps). This may use a lot of memory and can crash on low-end devices.</label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col gap-3 mt-auto">
                    <button id="srGenerateBtn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-magic-wand"></i> Generate
                    </button>
                    <button id="srDownloadBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-download-simple"></i> Download
                    </button>
                </div>
            </div>

            <!-- Right Preview Column -->
            <div id="srPreviewContainer" class="flex-grow flex items-center justify-center bg-gray-900/50 rounded-lg border border-gray-700 relative overflow-hidden h-64 md:h-auto">
                <div id="srInitialState" class="text-gray-500 text-2xl font-semibold">Preview</div>
                <div id="srLoadingState" class="hidden text-white flex-col items-center gap-4">
                    <i class="ph ph-spinner animate-spin text-5xl"></i>
                    <span>Processing...</span>
                </div>

                <div id="sr-image-compare-container" class="hidden absolute inset-0 w-full h-full group">
                    <img id="sr-beforeImageSlider" src="" alt="Original Image" class="absolute inset-0 w-full h-full object-contain pointer-events-none">
                    <div id="sr-afterImageSliderContainer" class="absolute inset-0 h-full overflow-hidden pointer-events-none" style="width: 50%;">
                        <img id="sr-afterImageSlider" src="" alt="Processed Image" class="h-full object-contain pointer-events-none" style="max-width: none;">
                    </div>
                    <div id="sr-slider-handle" class="absolute top-0 h-full w-1 bg-sky-400 cursor-col-resize pointer-events-auto z-10" style="left: 50%;">
                        <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-10 h-10 rounded-full bg-white/90 backdrop-blur-sm border-2 border-sky-400 flex items-center justify-center shadow-lg">
                            <i class="ph-bold ph-arrows-left-right text-sky-500 text-xl"></i>
                        </div>
                    </div>
                    <input type="range" id="sr-image-compare-slider" min="0" max="100" value="50" class="absolute inset-0 w-full h-full cursor-col-resize opacity-0 z-20">
                     <div class="absolute top-3 left-3 bg-black/50 text-white rounded-lg px-2 py-1 text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        Before
                    </div>
                    <div class="absolute top-3 right-3 bg-black/50 text-white rounded-lg px-2 py-1 text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        After
                    </div>
                </div>
            </div>
        </div>
    </div>
  
   <!-- Real ESRGUN Modal -->
    <div id="realesrModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content w-full h-full md:max-w-6xl md:h-[95vh] md:rounded-2xl p-6 relative flex flex-col md:flex-row gap-6 overflow-y-auto border border-gray-700 bg-gray-900/90">
            <button id="closeSuperResolutionModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
                <i class="ph ph-x text-2xl"></i>
            </button>

            <!-- Left Controls Column -->
            <div class="flex flex-col gap-4 w-full md:w-80 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <i class="ph-bold ph-rocket text-2xl gradient-text"></i>
                    <h2 class="text-xl font-bold text-white">AI Enhance & Super Resolution</h2>
                </div>

                <!-- Upload -->
                <div id="srUploadBox" class="relative p-6 rounded-xl flex flex-col items-center justify-center text-center border-2 border-dashed border-gray-600 hover:border-sky-500 transition-all cursor-pointer flex-grow md:flex-grow-0 h-48">
                    <input type="file" id="srImageUpload" class="hidden" accept="image/*">
                    <div class="flex flex-col items-center gap-2 text-gray-400">
                        <i class="ph-bold ph-upload-simple text-4xl"></i>
                        <p class="font-semibold text-sm">Upload Image</p>
                        <p class="text-xs">or drag & drop</p>
                    </div>
                </div>
                <div id="srUploadPreviewContainer" class="hidden relative w-full h-48">
                <img id="srUploadPreview" src="" alt="SR Upload Preview" class="w-full h-full object-contain rounded-lg border border-gray-700">
                <button id="srRemoveImageBtn" class="absolute top-2 right-2 bg-black/60 text-white rounded-full p-1 leading-none hover:bg-red-600 z-10" title="Remove Image">
                <i class="ph ph-x text-md pointer-events-none"></i>
                </button>
                </div>

                <!-- Mode -->
                <div>
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Mode</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="srModeEnhance" class="sr-mode-btn bg-purple-700 text-white font-semibold py-2 rounded-lg">Enhance</button>
                        <button id="srModeSuperResolution" class="sr-mode-btn bg-gray-700 text-white font-semibold py-2 rounded-lg">Super Resolution</button>
                    </div>
                </div>
                
                <!-- Scale -->
                <div id="srScaleContainer">
                    <label class="text-sm font-medium text-gray-300 mb-2 block">Scale</label>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="srScale2x" class="sr-scale-btn bg-gray-700 text-white font-semibold py-2 rounded-lg">2X</button>
                        <button id="srScale4x" class="sr-scale-btn bg-gray-700 text-white font-semibold py-2 rounded-lg">4X</button>
                    </div>
                    <div class="mt-3 flex items-start gap-2">
                        <input id="srForceFull" type="checkbox" class="mt-1.5 h-4 w-4 rounded border-gray-600 bg-gray-900/50">
                        <label for="srForceFull" class="text-xs text-gray-400">Force full 2X/4X output (disables mobile safety caps). This may use a lot of memory and can crash on low-end devices.</label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col gap-3 mt-auto">
                    <button id="srGenerateBtn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-magic-wand"></i> Generate
                    </button>
                    <button id="srDownloadBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="ph ph-download-simple"></i> Download
                    </button>
                </div>
            </div>

            <!-- Right Preview Column -->
            <div id="srPreviewContainer" class="flex-grow flex items-center justify-center bg-gray-900/50 rounded-lg border border-gray-700 relative overflow-hidden h-64 md:h-auto">
                <div id="srInitialState" class="text-gray-500 text-2xl font-semibold">Preview</div>
                <div id="srLoadingState" class="hidden text-white flex-col items-center gap-4">
                    <i class="ph ph-spinner animate-spin text-5xl"></i>
                    <span>Processing...</span>
                </div>

                <div id="sr-image-compare-container" class="hidden absolute inset-0 w-full h-full group">
                    <img id="sr-beforeImageSlider" src="" alt="Original Image" class="absolute inset-0 w-full h-full object-contain pointer-events-none">
                    <div id="sr-afterImageSliderContainer" class="absolute inset-0 h-full overflow-hidden pointer-events-none" style="width: 50%;">
                        <img id="sr-afterImageSlider" src="" alt="Processed Image" class="h-full object-contain pointer-events-none" style="max-width: none;">
                    </div>
                    <div id="sr-slider-handle" class="absolute top-0 h-full w-1 bg-sky-400 cursor-col-resize pointer-events-auto z-10" style="left: 50%;">
                        <div class="absolute top-1/2 -translate-y-1/2 -translate-x-1/2 w-10 h-10 rounded-full bg-white/90 backdrop-blur-sm border-2 border-sky-400 flex items-center justify-center shadow-lg">
                            <i class="ph-bold ph-arrows-left-right text-sky-500 text-xl"></i>
                        </div>
                    </div>
                    <input type="range" id="sr-image-compare-slider" min="0" max="100" value="50" class="absolute inset-0 w-full h-full cursor-col-resize opacity-0 z-20">
                     <div class="absolute top-3 left-3 bg-black/50 text-white rounded-lg px-2 py-1 text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        Before
                    </div>
                    <div class="absolute top-3 right-3 bg-black/50 text-white rounded-lg px-2 py-1 text-xs font-medium opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        After
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Local Variations Modal (Top-level, scrollable) -->
    <div id="localVariationsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-[60] hidden">
        <div class="modal-content w-full h-full md:max-w-6xl md:h-[95vh] md:rounded-2xl p-6 relative flex flex-col gap-4 overflow-y-auto border border-gray-700 bg-gray-900/90">
            <button id="closeLocalVariationsModalBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-20">
                <i class="ph ph-x text-2xl"></i>
            </button>
            <div class="flex items-center gap-3 sticky top-0 bg-transparent z-10">
                <i class="ph-bold ph-shapes text-2xl gradient-text"></i>
                <h2 class="text-xl font-bold text-white">Local Variations (Offline)</h2>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="bg-gray-900/60 rounded-xl border border-gray-700 p-4 flex flex-col gap-3 md:col-span-1">
                    <label class="text-sm text-gray-300">Count</label>
                    <input type="number" id="lvCount" min="1" max="20" value="6" class="bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200">
                    <label class="text-sm text-gray-300">Intensity</label>
                    <select id="lvIntensity" class="bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200">
                        <option value="0.3">Low</option>
                        <option value="0.6" selected>Medium</option>
                        <option value="1.0">High</option>
                    </select>
                    <label class="text-sm text-gray-300">Random Seed (optional)</label>
                    <input type="number" id="lvSeed" placeholder="auto" class="bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200" />
                    <label class="text-sm text-gray-300">Output Size</label>
                    <select id="lvSize" class="bg-gray-900/50 border border-gray-700 rounded-lg px-3 py-2 text-sm text-gray-200">
                        <option value="original">Original</option>
                        <option value="1024" selected>Long side 1024px</option>
                        <option value="2048">Long side 2048px</option>
                    </select>
                    <div class="mt-2 flex flex-col gap-2">
                        <button id="lvGenerateBtn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2.5 px-4 rounded-lg transition-colors disabled:opacity-50">Generate</button>
                        <button id="lvDownloadAllBtn" class="w-full bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-colors disabled:opacity-50">Download All</button>
                    </div>
                    <div id="lvProgress" class="text-xs text-gray-400 h-5"></div>
                </div>
                <div class="bg-gray-900/60 rounded-xl border border-gray-700 p-4 md:col-span-3 min-h-[320px]">
                    <div id="lvGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                    <div id="lvEmpty" class="text-center text-gray-500 py-12">No variations yet. Click Generate.</div>
                </div>
            </div>
        </div>
    </div>
  
  

  <!-- Footer -->
<footer class='border-t border-gray-800 bg-gray-900'>
    <div class='container mx-auto py-12 px-4'>
        <div class='grid grid-cols-1 md:grid-cols-6 gap-8 mb-8'>
            <div class='text-center md:text-left'>
                <div class='flex items-center justify-center md:justify-start gap-2 mb-4'>
                    <img alt='PixelPerfect Pro Footer Logo' class='h-8 w-8' src='https://lh3.googleusercontent.com/d/1v7HUgJoPYfn-oCFp3xm81gb56GQFIA8t'/>
                    <span class='text-lg font-bold text-white'>PixelPerfect Pro</span>
                </div>
                <p class='text-gray-400 text-sm'>Elevate your images with AI-powered enhancement tools.</p>
            </div>
            
            <div>
                <h3 class='text-white font-semibold mb-4'>All Tools</h3>
                <ul class='space-y-2'>
                    <li><a class='text-gray-400 hover:text-white' href='https://metadatatagpro.blogspot.com'>AI Metadata Generator</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='https://imgbgremovepro.blogspot.com'>Remove BG Pro</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='https://pixelstudioai.blogspot.com'>AI Pixel-Check studio</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='https://pixel-perfect-pro.base44.app/'>AI-Image Upscale</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='https://app--microstock-pro-c77f0cba.base44.app'>AI-Analyze for Microstock site</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='https://imggenpro.blogspot.com/'>Text to Image Generator</a></li>
                </ul>
            </div>
            <div>
             <h3 class='text-white font-semibold mb-4'>Adjustment</h3>
                <ul class='space-y-2'>
                    <li><a class='text-gray-400 hover:text-white' href='https://bulkeditmultitool.blogspot.com/'>Multi Image Tools</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='#'>Adjustments</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='#'>Histogram</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='#'>Sharpen / Smart Focus</a></li>
                </ul>
            </div>
             <div>
                    <h3 class='text-white font-semibold mb-4'>Company</h3>
                    <ul class='space-y-2'>
                        <li><a class='text-gray-400 hover:text-white' data-modal-target='about-us-en' href='#'>About Us</a></li>
                        <li><a class='text-gray-400 hover:text-white' data-modal-target='pricing' href='#'>Pricing</a></li>
                        <li><a class='text-gray-400 hover:text-white' data-modal-target='faq' href='#'>FAQ</a></li>
                    </ul>
                </div>
            <div>
                <h3 class='text-white font-semibold mb-4'>Legal</h3>
                <ul class='space-y-2'>
                    <li><a class='text-gray-400 hover:text-white' data-modal-target='privacy-modal-en' href='#'>Privacy Policy</a></li>
                     <li><a class='text-gray-400 hover:text-white' data-modal-target='terms-modal-en' href='#'>Terms of Service</a></li>
                </ul>
                
            </div>
            <div>
                <h3 class='text-white font-semibold mb-4'>Contact</h3>
                <ul class='space-y-2'>
                    <li><a class='text-gray-400 hover:text-white' data-modal-target='contact-modal' href='#'>Contact Us</a></li>
                    <li><a class='text-gray-400 hover:text-white' href='mailto:pradipcob84@gmail.com'>pradipcob84@gmail.com</a></li>
                </ul>
            </div>
        </div>
        <div class='text-center pt-8 border-t border-gray-800'>
           <div class='flex justify-center items-center gap-4 mb-4'>
    <a aria-label='Facebook' href='https://www.facebook.com/profile.php?id=61582098838826' target='_blank' class="text-gray-400 hover:text-white transition-colors">
        <i class='ph-fill ph-facebook-logo text-2xl'></i>
    </a>
    <a aria-label='Twitter' href='#' target='_blank' class="text-gray-400 hover:text-white transition-colors">
        <i class='ph-fill ph-twitter-logo text-2xl'></i>
    </a>
    <a aria-label='Instagram' href='https://www.instagram.com/pradipcob84/' target='_blank' class="text-gray-400 hover:text-white transition-colors">
        <i class='ph-fill ph-instagram-logo text-2xl'></i>
    </a>
    <a aria-label='Youtube' href='https://www.youtube.com/@PradipDas-v7' target='_blank' class="text-gray-400 hover:text-white transition-colors">
        <i class='ph-fill ph-youtube-logo text-2xl'></i>
    </a>
    <a aria-label='LinkedIn' href='https://www.linkedin.com/in/pradip-kumar-das-870526356/' target='_blank' class="text-gray-400 hover:text-white transition-colors">
        <i class='ph-fill ph-linkedin-logo text-2xl'></i>
    </a>
</div>
            <p class='text-gray-400 text-sm'>&copy; <span id="footer-year"></span> PixelPerfect Pro: All rights reserved</p>
        </div>
    </div>
</footer>
  
  <!-- About Us English Modal -->
  <div class='modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4' id='about-us-en'>
    <div class='bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300'>
        <div class='flex justify-between items-center mb-6'>
    <h2 class='text-2xl font-bold text-white'>About Us</h2>
    <div class='flex items-center gap-4'>
        <button class='text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-md' onclick="switchModal('about-us-en', 'about-us-bn')">বাংলা</button>
        <button data-modal-close="about-us-en" class="modal-close-btn text-gray-400 hover:text-white transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
</div>
        <div class='prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none'>
            <h3 class='font-semibold text-white mt-4'>Our Mission</h3>
              <p>At PixelPerfect Pro, our goal is to put advanced AI tools in the hands of photographers, designers, social media managers, and all creators, making the complex process of photo editing easier and faster.</p>
            <div class='prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none'>
               
                <h3 class='font-semibold text-white mt-4'>Our Story</h3>
                 <p>PixelPerfect Pro&#39;s journey began with a simple problem. We faced a huge challenge: repeatedly getting rejected while submitting images to microstock sites and wasting a lot of time fixing the technical details of the images. PixelPerfect Pro was born from this idea, created by a group of developers, AI experts, and design enthusiasts.</p>
             <h3 class='font-semibold text-white mt-4'>Our Commitment</h3>
                  <li><strong>Innovation:</strong>We are always committed to working with new and improved AI technologies, so that you get the best results.</li>
                    <li><strong>Simplicity:</strong>We believe that powerful tools should be simple to use. Our interface is designed in such a way that anyone can use it easily.</li>
                    <li><strong>Privacy:</strong>Protecting the privacy of your data and photos is our top priority. We respect your creativity and ensure its protection.</li> 
            </div>
            <p class='mt-4'>Thank you for joining us on this journey.</p>
        </div>
    </div>
</div>

<!-- About Us Modal (BENGALI) -->
<div class='modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4' id='about-us-bn'>
    <div class='bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300'>
        <div class='flex justify-between items-center mb-6'>
           <h2 class='text-2xl font-bold text-white'>About Us</h2>
    <div class='flex items-center gap-4'>
        <button class='text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-md' onclick="switchModal('about-us-bn', 'about-us-en')">English</button>
        <button data-modal-close="about-us-bn" class="modal-close-btn text-gray-400 hover:text-white transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
</div>
            <div class="prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none">
                <h3 class="font-semibold text-white mt-4">আমাদের লক্ষ্য (Our Mission)</h3>
                <p>PixelPerfect Pro-তে আমাদের লক্ষ্য হল ফটোগ্রাফার, ডিজাইনার, সোশ্যাল মিডিয়া ম্যানেজার এবং সকল ক্রিয়েটরদের হাতে উন্নতমানের AI টুল তুলে দেওয়া, যা ছবি এডিটিং-এর জটিল প্রক্রিয়াকে সহজ ও দ্রুত করে তুলবে।</p>
                
                <h3 class="font-semibold text-white mt-4">আমাদের গল্প (Our Story)</h3>
                <p>PixelPerfect Pro-এর যাত্রা শুরু হয়েছিল একটি সাধারণ সমস্যা থেকে। মাইক্রোস্টক সাইটগুলোতে ছবি জমা দেওয়ার সময় বারবার রিজেক্ট হওয়া এবং ছবির টেকনিক্যাল খুঁটিনাটি বিষয়গুলো ঠিক করতে গিয়ে প্রচুর সময় নষ্ট হওয়াটা ছিল আমাদের জন্য একটি বড় চ্যালেঞ্জ। এই ভাবনা থেকেই একদল ডেভেলপার, AI বিশেষজ্ঞ এবং ডিজাইন উৎসাহী মানুষের হাত ধরে PixelPerfect Pro-এর জন্ম।</p>

                <h3 class="font-semibold text-white mt-4">আমাদের প্রতিশ্রুতি (Our Commitment)</h3>
                <ul class="list-disc pl-5 space-y-2">
                    <li><strong>উদ্ভাবন (Innovation):</strong> আমরা সর্বদা নতুন এবং উন্নত AI প্রযুক্তি নিয়ে কাজ করতে প্রতিশ্রুতিবদ্ধ, যাতে আপনি সেরা ফলাফল পান।</li>
                    <li><strong>সহজ ব্যবহার (Simplicity):</strong> আমরা বিশ্বাস করি, শক্তিশালী টুলের ব্যবহার হওয়া উচিত সহজ। আমাদের ইন্টারফেসটি এমনভাবে ডিজাইন করা হয়েছে, যাতে যে কেউ সহজেই এটি ব্যবহার করতে পারে।</li>
                    <li><strong>গোপনীয়তা (Privacy):</strong> আপনার ডেটা এবং ছবির গোপনীয়তা রক্ষা করা আমাদের সর্বোচ্চ অগ্রাধিকার। আমরা আপনার সৃষ্টিশীলতাকে সম্মান করি এবং এর সুরক্ষা নিশ্চিত করি।</li>
                </ul>
                <p class="mt-4">আমাদের এই যাত্রায় সঙ্গী হওয়ার জন্য আপনাকে ধন্যবাদ।</p>
            </div>
        </div>
    </div>
  
  <!-- START: NEW FAQ SECTION -->
  
  <div id="faq" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300">
             <button data-modal-close="faq" class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10">
                <i class="ph ph-x text-2xl"></i>
            </button>
                    <h2 class="text-3xl md:text-4xl font-bold text-white">Frequently Asked Questions</h2>
                    <p class="text-gray-400 mt-4">Have questions? We've got answers. If you can't find what you're looking for, feel free to contact us.</p>
               
                <div class="space-y-4">
                    <!-- FAQ Item 1 -->
                    <details class="faq-item bg-gray-900/50 border border-gray-800 rounded-lg p-6 fade-in-up" style="animation-delay: 100ms;">
                        <summary class="flex justify-between items-center font-semibold text-lg text-white list-none">
                            What kind of images work best with PixelPerfect Pro?
                            <i class="ph ph-plus faq-icon text-2xl text-sky-400"></i>
                        </summary>
                        <p class="text-gray-400 mt-4">Our AI is trained on a vast dataset and works well with most image types, including portraits, landscapes, product photos, and digital art. For best results, start with an image that is reasonably well-lit and not excessively blurry.</p>
                    </details>
                    <!-- FAQ Item 2 -->
                    <details class="faq-item bg-gray-900/50 border border-gray-800 rounded-lg p-6 fade-in-up" style="animation-delay: 200ms;">
                        <summary class="flex justify-between items-center font-semibold text-lg text-white list-none">
                            Is my data and are my images secure?
                            <i class="ph ph-plus faq-icon text-2xl text-sky-400"></i>
                        </summary>
                        <p class="text-gray-400 mt-4">Absolutely. We prioritize your privacy and security. Your images are processed securely and are not used for any purpose other than providing you with the enhancement service. We automatically delete uploaded images from our servers after 24 hours.</p>
                    </details>
                    <!-- FAQ Item 3 -->
                    <details class="faq-item bg-gray-900/50 border border-gray-800 rounded-lg p-6 fade-in-up" style="animation-delay: 300ms;">
                        <summary class="flex justify-between items-center font-semibold text-lg text-white list-none">
                            Can I cancel my Pro plan at any time?
                            <i class="ph ph-plus faq-icon text-2xl text-sky-400"></i>
                        </summary>
                        <p class="text-gray-400 mt-4">Yes, you can cancel your subscription at any time from your account dashboard. You will retain access to Pro features until the end of your current billing period. No questions asked.</p>
                    </details>
                    <!-- FAQ Item 4 -->
                    <details class="faq-item bg-gray-900/50 border border-gray-800 rounded-lg p-6 fade-in-up" style="animation-delay: 400ms;">
                        <summary class="flex justify-between items-center font-semibold text-lg text-white list-none">
                            What is batch processing and how does it work?
                            <i class="ph ph-plus faq-icon text-2xl text-sky-400"></i>
                        </summary>
                        <p class="text-gray-400 mt-4">Batch processing allows you to upload multiple images at once and apply the same enhancements (like upscaling or color correction) to all of them simultaneously. Once the processing is complete, you can download all your edited images in a single, convenient ZIP file. This feature is a massive time-saver for large projects.</p>
                    </details>
                </div>
            </div>
            </div>
   <!-- END: NEW FAQ SECTION -->
  
   <!-- START: NEW PRICING SECTION -->
  <div id="pricing" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-6xl max-h-[90vh] overflow-y-auto text-gray-300">
             <button data-modal-close="pricing" class="modal-close-btn absolute top-4 right-4 text-gray-400 hover:text-white transition-colors z-10">
                <i class="ph ph-x text-2xl"></i>
            </button>
                 <div class="container mx-auto px-4 text-center">
                   <h2 class="text-3xl md:text-4xl font-bold mb-4 text-white">Simple, Transparent Pricing</h2>
                <p class="text-gray-400 max-w-2xl mx-auto mb-12">Choose the plan that's right for you. Get started for free, no credit card required.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    <!-- Pricing Card: Free -->
                    <div class="card-frosted p-8 rounded-xl flex flex-col fade-in-up" style="animation-delay: 100ms;">
                        <h3 class="text-2xl font-bold text-white mb-2">Hobby</h3>
                        <p class="text-gray-400 mb-6">Perfect for casual use and trying out our core features.</p>
                        <div class="my-4">
                            <span class="text-5xl font-extrabold text-white">$0</span>
                            <span class="text-gray-400">/ month</span>
                        </div>
                        <ul class="space-y-3 text-left text-gray-300 my-8 flex-grow">
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>5 AI Enhancements / day</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Basic Quality Analysis</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>2x AI Upscaling</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Standard Support</li>
                        </ul>
                        <a href="https://img2pixelpro.blogspot.com" class="mt-auto w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Get Started</a>
                    </div>

                    <!-- Pricing Card: Pro (Highlighted) -->
                    <div class="card-frosted p-8 rounded-xl flex flex-col relative border-2 border-sky-500 transform scale-105 fade-in-up" style="animation-delay: 300ms;">
                        <div class="absolute top-0 -translate-y-1/2 left-1/2 -translate-x-1/2 bg-sky-500 text-white text-xs font-bold px-4 py-1 rounded-full uppercase">Most Popular</div>
                        <h3 class="text-2xl font-bold text-white mb-2">Pro</h3>
                        <p class="text-gray-400 mb-6">For professionals and serious creators who need full power.</p>
                        <div class="my-4">
                            <span class="text-5xl font-extrabold text-white">$12</span>
                            <span class="text-gray-400">/ month</span>
                        </div>
                        <ul class="space-y-3 text-left text-gray-300 my-8 flex-grow">
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Unlimited AI Enhancements</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Advanced Quality Analysis</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Up to 8x AI Upscaling</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Unlimited Batch Processing</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>AI Metadata Generation</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Priority Support</li>
                        </ul>
                        <a href="https://img2pixelpro.blogspot.com" class="mt-auto w-full bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">Go Pro</a>
                    </div>
                     <!-- Pricing Card: Enterprise -->
                    <div class="card-frosted p-8 rounded-xl flex flex-col fade-in-up" style="animation-delay: 500ms;">
                        <h3 class="text-2xl font-bold text-white mb-2">Business</h3>
                        <p class="text-gray-400 mb-6">For teams and agencies with custom needs and integrations.</p>
                        <div class="my-4">
                             <span class="text-4xl font-extrabold text-white">Custom</span>
                        </div>
                        <ul class="space-y-3 text-left text-gray-300 my-8 flex-grow">
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Everything in Pro</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Team Accounts & Seats</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>API Access</li>
                            <li class="flex items-center gap-3"><i class="ph-bold ph-check-circle text-sky-400 text-xl"></i>Dedicated Account Manager</li>
                        </ul>
                        <button data-modal-target="contact-modal" class="mt-auto w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-colors">Contact Sales</button>
                    </div>
                </div>
            </div>
            </div>
            </div>
   <!-- END: NEW PRICING SECTION -->

  
  <!-- Privacy Policy Modal (ENGLISH) -->
<div id="privacy-modal-en" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300">
        <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-white">Privacy Policy</h2>
    <div class="flex items-center gap-4">
        <button onclick="switchModal('privacy-modal-en', 'privacy-modal-bn')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-md">বাংলা</button>
        <button data-modal-close="privacy-modal-en" class="modal-close-btn text-gray-400 hover:text-white transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
</div>
        <div class="prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none">
            <p><strong>Last Updated:</strong> October 15, 2025</p>
            <p>Welcome to PixelPerfect Pro ("we", "our", "us"). We are committed to protecting your privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our website and services.</p>
            
            <h3 class="font-semibold text-white mt-4">1. Information We Collect</h3>
            <p>We may collect personal information such as your name and email address when you register for an account, and usage data like your IP address and browser type. The primary data we handle is the images you upload for processing.</p>

            <h3 class="font-semibold text-white mt-4">2. How We Use Your Information</h3>
            <p>We use your information to provide, maintain, and improve our services, process your subscriptions, and communicate with you. Your images are used solely for the purpose of applying the AI enhancements you request.</p>
            
            <h3 class="font-semibold text-white mt-4">3. Image Data Handling and Deletion</h3>
            <p><strong>Your privacy is our priority.</strong> The images you upload are processed on our secure servers. We do <strong>not</strong> use your images for training our AI models or for any other purpose. All uploaded images are <strong>automatically and permanently deleted</strong> from our servers after 24 hours to ensure your data remains confidential.</p>

            <h3 class="font-semibold text-white mt-4">4. Data Sharing and Disclosure</h3>
            <p>We do not sell, trade, or rent your personal information to third parties. We may share information with trusted third-party service providers (e.g., payment gateways, cloud hosting) who assist us in operating our website, so long as those parties agree to keep this information confidential.</p>

            <h3 class="font-semibold text-white mt-4">5. Data Security</h3>
            <p>We implement a variety of security measures, including SSL encryption, to maintain the safety of your personal information. However, no method of transmission over the Internet is 100% secure.</p>

            <h3 class="font-semibold text-white mt-4">6. Changes to This Policy</h3>
            <p>We may update this Privacy Policy from time to time. We will notify you of any changes by posting the new policy on this page.</p>

            <h3 class="font-semibold text-white mt-4">7. Contact Us</h3>
            <p>If you have any questions about this Privacy Policy, please contact us at: pradipcob84@gmail.com</p>
        </div>
    </div>
</div>

<!-- Privacy Policy Modal (BENGALI) -->
<div id="privacy-modal-bn" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300">
        <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-white">গোপনীয়তা নীতি</h2>
    <div class="flex items-center gap-4">
        <button onclick="switchModal('privacy-modal-bn', 'privacy-modal-en')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-md">English</button>
        <button data-modal-close="privacy-modal-bn" class="modal-close-btn text-gray-400 hover:text-white transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
</div>
        <div class="prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none">
            <p><strong>সর্বশেষ আপডেট:</strong> অক্টোবর ১৫, ২০২৫</p>
            <p>PixelPerfect Pro ("আমরা", "আমাদের")-তে আপনাকে স্বাগতম। আমরা আপনার তথ্যের গোপনীয়তা রক্ষা করতে প্রতিশ্রুতিবদ্ধ। এই গোপনীয়তা নীতি ব্যাখ্যা করে যে, আপনি যখন আমাদের ওয়েবসাইট এবং পরিষেবাগুলো ব্যবহার করেন, তখন আমরা কীভাবে আপনার তথ্য সংগ্রহ, ব্যবহার এবং সুরক্ষিত রাখি।</p>
            
            <h3 class="font-semibold text-white mt-4">১. আমরা যে তথ্য সংগ্রহ করি</h3>
            <p>আপনি যখন অ্যাকাউন্ট নিবন্ধন করেন, তখন আমরা আপনার নাম ও ইমেল ঠিকানার মতো ব্যক্তিগত তথ্য সংগ্রহ করতে পারি। এছাড়া ব্যবহারের ডেটা, যেমন আপনার আইপি অ্যাড্রেস এবং ব্রাউজারের ধরন সংগ্রহ করা হতে পারে। আমাদের প্রধান কাজ হলো আপনার আপলোড করা ছবিগুলো প্রসেস করা।</p>

            <h3 class="font-semibold text-white mt-4">২. তথ্যের ব্যবহার</h3>
            <p>আমরা আপনার তথ্য ব্যবহার করে আমাদের পরিষেবা প্রদান, রক্ষণাবেক্ষণ ও উন্নত করি, আপনার সাবস্ক্রিপশন পরিচালনা করি এবং আপনার সাথে যোগাযোগ করি। আপনার ছবিগুলো শুধুমাত্র আপনার অনুরোধ করা AI এডিটিং প্রক্রিয়া সম্পাদনের জন্য ব্যবহৃত হয়।</p>
            
            <h3 class="font-semibold text-white mt-4">৩. ছবির ডেটা হ্যান্ডলিং এবং মুছে ফেলা</h3>
            <p><strong>আপনার গোপনীয়তা আমাদের সর্বোচ্চ অগ্রাধিকার।</strong> আপনার আপলোড করা ছবিগুলো আমাদের সুরক্ষিত সার্ভারে প্রসেস করা হয়। আমরা আপনার ছবি আমাদের AI মডেলকে প্রশিক্ষণ দেওয়ার জন্য বা অন্য কোনো উদ্দেশ্যে ব্যবহার করি <strong>না</strong>। আপনার তথ্যের গোপনীয়তা নিশ্চিত করতে, আপলোড করা সমস্ত ছবি <strong>২৪ ঘণ্টা পর স্বয়ংক্রিয়ভাবে এবং স্থায়ীভাবে</strong> আমাদের সার্ভার থেকে মুছে ফেলা হয়।</p>

            <h3 class="font-semibold text-white mt-4">৪. তথ্য শেয়ারিং</h3>
            <p>আমরা আপনার ব্যক্তিগত তথ্য কোনো তৃতীয় পক্ষের কাছে বিক্রি, ট্রেড বা ভাড়া দিই না। আমরা বিশ্বস্ত তৃতীয়-পক্ষ পরিষেবা প্রদানকারী (যেমন: পেমেন্ট গেটওয়ে, ক্লাউড হোস্টিং)-এর সাথে তথ্য শেয়ার করতে পারি, যতক্ষণ তারা এই তথ্য গোপন রাখতে সম্মত থাকে।</p>

            <h3 class="font-semibold text-white mt-4">৫. ডেটা সুরক্ষা</h3>
            <p>আপনার ব্যক্তিগত তথ্যের সুরক্ষা নিশ্চিত করতে আমরা SSL এনক্রিপশনসহ বিভিন্ন নিরাপত্তা ব্যবস্থা ব্যবহার করি। তবে, ইন্টারনেটের মাধ্যমে তথ্য আদান-প্রদানের কোনো পদ্ধতিই ১০০% সুরক্ষিত নয়।</p>

            <h3 class="font-semibold text-white mt-4">৬. এই নীতির পরিবর্তন</h3>
            <p>আমরা সময়ে সময়ে এই গোপনীয়তা নীতি আপডেট করতে পারি। যেকোনো পরিবর্তন এই পেজে পোস্ট করে আপনাকে জানানো হবে।</p>

            <h3 class="font-semibold text-white mt-4">৭. যোগাযোগ</h3>
            <p>এই গোপনীয়তা নীতি সম্পর্কে আপনার কোনো প্রশ্ন থাকলে, অনুগ্রহ করে আমাদের সাথে যোগাযোগ করুন: pradipcob84@gmail.com</p>
        </div>
    </div>
</div>


   <!-- Terms of Service Modal (ENGLISH) -->
<div id="terms-modal-en" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300">
       <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-white">Terms of Service</h2>
    <div class="flex items-center gap-4">
        <button onclick="switchModal('terms-modal-en', 'terms-modal-bn')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-md">বাংলা</button>
        <button data-modal-close="terms-modal-en" class="modal-close-btn text-gray-400 hover:text-white transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
</div>
        <div class="prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none">
            <p><strong>Last Updated:</strong> October 15, 2025</p>
            <h3 class="font-semibold text-white mt-4">1. Acceptance of Terms</h3>
            <p>By accessing or using the services provided by PixelPerfect Pro, you agree to be bound by these Terms of Service. If you disagree with any part of the terms, then you may not access the service.</p>
            
            <h3 class="font-semibold text-white mt-4">2. Use of Service</h3>
            <p>You agree to use our service for lawful purposes only. You are responsible for the images you upload and must ensure you have the necessary rights or permissions for them. You will not upload content that is illegal, offensive, or infringes on copyright.</p>
            
            <h3 class="font-semibold text-white mt-4">3. Intellectual Property</h3>
            <p><strong>Your Content:</strong> You retain full ownership and all rights to the images you upload. We claim no intellectual property rights over your material. We are granted a limited, non-exclusive license solely to process your images to provide you with the service.</p>
            <p><strong>Our Content:</strong> All content on this website, including the software, text, graphics, and logos, is the property of PixelPerfect Pro and is protected by copyright laws.</p>
            
            <h3 class="font-semibold text-white mt-4">4. Subscriptions and Payments</h3>
            <p>Our premium services are offered on a subscription basis. By subscribing, you agree to pay the specified fees. Subscriptions can be canceled at any time, but payments are non-refundable unless required by law.</p>

            <h3 class="font-semibold text-white mt-4">5. Termination</h3>
            <p>We may terminate or suspend your access to our service immediately, without prior notice, for any reason, including a breach of these Terms.</p>
            
            <h3 class="font-semibold text-white mt-4">6. Disclaimer of Warranties</h3>
            <p>Our service is provided "as is" and "as available" without any warranties. We do not guarantee that the service will be error-free, secure, or uninterrupted.</p>
            
            <h3 class="font-semibold text-white mt-4">7. Limitation of Liability</h3>
            <p>In no event shall PixelPerfect Pro be liable for any indirect, incidental, or consequential damages arising out of your use of the service.</p>
            
            <h3 class="font-semibold text-white mt-4">8. Contact Us</h3>
            <p>If you have any questions about these Terms, please contact us at: pradipcob84@gmail.com</p>
        </div>
    </div>
</div>

<!-- Terms of Service Modal (BENGALI) -->
<div id="terms-modal-bn" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto text-gray-300">
        <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-white">Terms of Service</h2>
    <div class="flex items-center gap-4">
        <button onclick="switchModal('terms-modal-bn', 'terms-modal-en')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-md">English</button>
        <button data-modal-close="terms-modal-bn" class="modal-close-btn text-gray-400 hover:text-white transition-colors">
            <i class="ph ph-x text-2xl"></i>
        </button>
    </div>
</div>
        <div class="prose prose-invert prose-p:text-gray-300 prose-headings:text-white max-w-none">
            <p><strong>সর্বশেষ আপডেট:</strong> অক্টোবর ১৫, ২০২৫</p>
            <h3 class="font-semibold text-white mt-4">১. শর্তাবলী গ্রহণ</h3>
            <p>PixelPerfect Pro দ্বারা প্রদত্ত পরিষেবাগুলো ব্যবহার করার মাধ্যমে, আপনি এই পরিষেবার শর্তাবলীতে আবদ্ধ হতে সম্মত হচ্ছেন। আপনি যদি এই শর্তাবলীর কোনো অংশের সাথে দ্বিমত পোষণ করেন, তবে আপনি পরিষেবাটি ব্যবহার করতে পারবেন না।</p>
            
            <h3 class="font-semibold text-white mt-4">২. পরিষেবার ব্যবহার</h3>
            <p>আপনি আমাদের পরিষেবা শুধুমাত্র আইনি উদ্দেশ্যে ব্যবহার করতে সম্মত হচ্ছেন। আপনি যে ছবিগুলো আপলোড করেন তার জন্য আপনি দায়ী এবং আপনাকে নিশ্চিত করতে হবে যে আপনার কাছে সেগুলোর প্রয়োজনীয় অধিকার বা অনুমতি রয়েছে। আপনি এমন কোনো সামগ্রী আপলোড করবেন না যা বেআইনি, আপত্তিকর বা কপিরাইট লঙ্ঘন করে।</p>
            
            <h3 class="font-semibold text-white mt-4">৩. বুদ্ধিবৃত্তিক সম্পত্তি</h3>
            <p><strong>আপনার কন্টেন্ট:</strong> আপনি যে ছবিগুলো আপলোড করেন, সেগুলোর সম্পূর্ণ মালিকানা এবং সমস্ত অধিকার আপনার। আমরা আপনার উপকরণের উপর কোনো বুদ্ধিবৃত্তিক সম্পত্তির অধিকার দাবি করি না। আপনাকে পরিষেবা প্রদানের জন্য আপনার ছবি প্রসেস করার জন্য আমাদের একটি সীমিত লাইসেন্স দেওয়া হয়।</p>
            <p><strong>আমাদের কন্টেন্ট:</strong> এই ওয়েবসাইটের সমস্ত কন্টেন্ট, সফটওয়্যার, টেক্সট, গ্রাফিক্স এবং লোগোসহ, PixelPerfect Pro-এর সম্পত্তি এবং কপিরাইট আইন দ্বারা সুরক্ষিত।</p>
            
            <h3 class="font-semibold text-white mt-4">৪. সাবস্ক্রিপশন এবং পেমেন্ট</h3>
            <p>আমাদের প্রিমিয়াম পরিষেবাগুলো সাবস্ক্রিপশন ভিত্তিতে প্রদান করা হয়। সাবস্ক্রাইব করার মাধ্যমে, আপনি নির্দিষ্ট ফি প্রদান করতে সম্মত হচ্ছেন। সাবস্ক্রিপশন যেকোনো সময় বাতিল করা যেতে পারে, তবে আইন দ্বারা আবশ্যক না হলে পেমেন্ট অফেরতযোগ্য।</p>

            <h3 class="font-semibold text-white mt-4">৫. পরিষেবা বাতিলকরণ</h3>
            <p>এই শর্তাবলী লঙ্ঘনের মতো যেকোনো কারণে আমরা পূর্ব বিজ্ঞপ্তি ছাড়াই আপনার পরিষেবা ব্যবহারের অ্যাক্সেস অবিলম্বে স্থগিত বা বাতিল করতে পারি।</p>
            
            <h3 class="font-semibold text-white mt-4">৬. ওয়ারেন্টি অস্বীকৃতি</h3>
            <p>আমাদের পরিষেবা "যেমন আছে" ভিত্তিতে প্রদান করা হয়। আমরা এই মর্মে কোনো গ্যারান্টি দিই না যে পরিষেবাটি ত্রুটিমুক্ত, সুরক্ষিত বা নিরবচ্ছিন্ন হবে।</p>
            
            <h3 class="font-semibold text-white mt-4">৭. দায়বদ্ধতার সীমাবদ্ধতা</h3>
            <p>আমাদের পরিষেবা ব্যবহারের ফলে আপনার কোনো পরোক্ষ বা আনুষঙ্গিক ক্ষতির জন্য PixelPerfect Pro কোনোভাবেই দায়ী থাকবে না।</p>
            
            <h3 class="font-semibold text-white mt-4">৮. যোগাযোগ</h3>
            <p>এই শর্তাবলী সম্পর্কে আপনার কোনো প্রশ্ন থাকলে, অনুগ্রহ করে আমাদের সাথে যোগাযোগ করুন: pradipcob84@gmail.com</p>
        </div>
    </div>
</div>

   <!-- Contact Modal -->
    <div id="contact-modal" class="modal-container hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800/80 rounded-2xl p-8 backdrop-blur-lg border border-gray-700 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Get in Touch</h2>
                <button data-modal-close class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <p class="text-gray-400 mb-8">Have questions? We're here to help.</p>
            
            <form class="space-y-6">
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <label for="name" class="block text-white mb-2">Name</label>
                        <input type="text" id="name" name="name" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-sky-500 text-white" placeholder="Your name">
                    </div>
                    <div>
                        <label for="email" class="block text-white mb-2">Email</label>
                        <input type="email" id="email" name="email" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-sky-500 text-white" placeholder="your@email.com">
                    </div>
                </div>
                <div>
                    <label for="subject" class="block text-white mb-2">Subject</label>
                    <input type="text" id="subject" name="subject" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-sky-500 text-white" placeholder="How can we help?">
                </div>
                <div>
                    <label for="message" class="block text-white mb-2">Message</label>
                    <textarea id="message" name="message" rows="5" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:border-sky-500 text-white" placeholder="Your message..."></textarea>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">Send Message</button>
            </form>

            <div class="mt-12 pt-8 border-t border-gray-700">
                <div class="grid md:grid-cols-3 gap-8 text-center">
                    <div><i class="ph-bold ph-envelope-simple text-3xl text-sky-400 mb-2"></i><h3 class="text-white font-semibold">Email</h3><p class="text-gray-400">pradipcob84@gmail.com</p></div>
                    <div><i class="ph-bold ph-chat-circle-dots text-3xl text-sky-400 mb-2"></i><h3 class="text-white font-semibold">Live Chat</h3><p class="text-gray-400">Available 24/7</p></div>
                    <div><i class="ph-bold ph-map-pin text-3xl text-sky-400 mb-2"></i><h3 class="text-white font-semibold">Office</h3><p class="text-gray-400">Dhalpal, Cob,WB 736159 </p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- END: NEW FOOTER MODALS -->
    <!-- START: NEW SCRIPT FOR FOOTER MODALS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Function to open a modal
    const openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
        }
    };

    // Function to close a modal
    const closeModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
        }
    };

    // ****** নতুন ফাংশনটি এখানে যুক্ত করুন ******
    // Function to switch modals
    window.switchModal = (closeId, openId) => {
        closeModal(closeId);
        openModal(openId);
    };

    // Add event listeners to all modal trigger elements
    document.querySelectorAll('[data-modal-target]').forEach(trigger => {
        trigger.addEventListener('click', (event) => {
            event.preventDefault();
            const modalId = trigger.getAttribute('data-modal-target');
            openModal(modalId);
        });
    });

    // Add event listeners to all modal close buttons
    document.querySelectorAll('[data-modal-close]').forEach(button => {
        button.addEventListener('click', () => {
            const modalId = button.getAttribute('data-modal-close');
            // Find the parent modal and close it
            const parentModal = button.closest('.modal-container');
            if (parentModal) {
                closeModal(parentModal.id);
            }
        });
    });

    // Add event listener to close modals when clicking on the overlay
    document.querySelectorAll('.modal-container').forEach(modalOverlay => {
        modalOverlay.addEventListener('click', (event) => {
            // If the click is on the overlay itself (and not its children)
            if (event.target === modalOverlay) {
                closeModal(modalOverlay.id);
            }
        });
    });

    // Close modals with the Escape key
    document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
            document.querySelectorAll('.modal-container:not(.hidden)').forEach(modal => {
                 closeModal(modal.id);
            });
        }
    });
});
</script>
<!-- END: NEW SCRIPT FOR FOOTER MODALS -->
   <!-- Ad script container -->
    <div id="container-7128caf782579cf1a6e998e1d0a0fe7b"></div>

    <!-- Main Application Logic -->
      <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State ---
        let imageBase64 = '';
        let currentFileObject = null;
        let analysisResults = null;
        let currentMetadata = null;
        let enhancementSuggestionsData = null; 
        let originalImageSrcForEnhance = '';
        let enhancedImageSrcForEnhance = '';
        let currentUploadedFileName = ''; 
        let currentImageDimensions = { width: 0, height: 0 };
        let currentRecentFileCacheKey = null;
        let cropper = null;
        let watermarkFile = null;
        let batchQueue = [];
        let batchResults = [];
        let batchMetadataResults = [];
        let currentBatchPreviewIndex = null;
        let fileToDownloadFromRecents = null;
        window.downloadContext = null;

        // --- Cache API ---
        const CACHE_NAME = 'pixelperfect-recent-images-v1';
        const MAX_RECENT_FILES = 10;

        // --- Element Selectors ---
        const analyzeBtn = document.getElementById('analyzeBtn');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const batchBtn = document.getElementById('batchBtn');
        const metadataBtn = document.getElementById('metadataBtn');
        const promptBtn = document.getElementById('promptBtn');
        const superResolutionBtn = document.getElementById('superResolutionBtn');
        const localVariationsBtn = document.getElementById('localVariationsBtn');
        const uploadBox = document.getElementById('uploadBox');
        const imageUpload = document.getElementById('imageUpload');
        const browseBtn = document.getElementById('browseBtn');
        const imageUrlInput = document.getElementById('imageUrl');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const closePreviewBtn = document.getElementById('closePreviewBtn');
        const viewLargeBtn = document.getElementById('viewLargeBtn');
        const enhancePromptTypeDropdown = document.getElementById('enhancePromptType');
        const recentFilesContainer = document.getElementById('recentFilesContainer');
        const recentFilesGrid = document.getElementById('recentFilesGrid');
        const initialState = document.getElementById('initialState');
        const loadingState = document.getElementById('loadingState');
        const loadingText = document.getElementById('loadingText');
        const resultsContent = document.getElementById('resultsContent');
        const progressCircle = document.getElementById('progressCircle');
        const scoreText = document.getElementById('scoreText');
        const scoreBreakdown = document.getElementById('scoreBreakdown');
        const tagsContainer = document.getElementById('tagsContainer');
        const copyTagsBtn = document.getElementById('copyTagsBtn');
        const qualityInsights = document.getElementById('qualityInsights');
        const enhanceModal = document.getElementById('enhanceModal');
        const closeEnhanceModalBtn = document.getElementById('closeEnhanceModalBtn');
        const enhanceSuggestions = document.getElementById('enhanceSuggestions');
        const enhancedImagePreviewCanvas = document.getElementById('enhancedImagePreview');
        const downloadEnhancedBtn = document.getElementById('downloadEnhancedBtn');
        const resetEnhancementsBtn = document.getElementById('resetEnhancementsBtn');
        const recheckImageBtn = document.getElementById('recheckImageBtn');
        const resetSlidersBtn = document.getElementById('resetSlidersBtn');
        const toastNotification = document.getElementById('toast-notification');
        const cropBtn = document.getElementById('cropBtn');
        const objectRemovalBtn = document.getElementById('objectRemovalBtn');
        const reimagineBtn = document.getElementById('reimagineBtn'); 
        const normalUpscaleToggleBtn = document.getElementById('normalUpscaleToggleBtn');
        const normalUpscaleDropdown = document.getElementById('normalUpscaleDropdown');
        const normalUpscale2xBtn = document.getElementById('normalUpscale2xBtn');
        const normalUpscale4xBtn = document.getElementById('normalUpscale4xBtn');
        const aiUpscaleToggleBtn = document.getElementById('aiUpscaleToggleBtn');
        const aiUpscaleDropdown = document.getElementById('aiUpscaleDropdown');
        const aiUpscale2xBtn = document.getElementById('aiUpscale2xBtn');
        const aiUpscale4xBtn = document.getElementById('aiUpscale4xBtn');
        const cropModal = document.getElementById('cropModal');
        const closeCropModalBtn = document.getElementById('closeCropModalBtn');
        const cropImage = document.getElementById('cropImage');
        const applyCropBtn = document.getElementById('applyCropBtn');
        const cropResetBtn = document.getElementById('cropResetBtn');
        const objectRemovalModal = document.getElementById('objectRemovalModal');
        const closeObjectRemovalModalBtn = document.getElementById('closeObjectRemovalModalBtn');
        const removalCanvasContainer = document.getElementById('removal-canvas-container');
        const removalImageCanvas = document.getElementById('removalImageCanvas');
        const removalMaskCanvas = document.getElementById('removalMaskCanvas');
        const removalLoadingOverlay = document.getElementById('removalLoadingOverlay');
        const brushSizeSlider = document.getElementById('brushSizeSlider');
        const brushSizeValue = document.getElementById('brushSizeValue');
        const clearMaskBtn = document.getElementById('clearMaskBtn');
        const removeObjectBtn = document.getElementById('removeObjectBtn');
        const saveRemovedObjectBtn = document.getElementById('saveRemovedObjectBtn');
        let removalCtx, maskCtx, removalImageObject = null, removedObjectBlob = null;
        let isDrawing = false, lastX = 0, lastY = 0, brushSize = 20;
        const imageCompareSlider = document.getElementById('image-compare-slider');
        const beforeImageSlider = document.getElementById('beforeImageSlider');
        const afterImageSliderContainer = document.getElementById('afterImageSliderContainer');
        const afterImageSlider = document.getElementById('afterImageSlider');
        const sliderHandle = document.getElementById('slider-handle');
        const viewOriginalBtn = document.getElementById('viewOriginalBtn');
        const viewEnhancedBtn = document.getElementById('viewEnhancedBtn');
        const sliders = document.querySelectorAll('#enhanceModal input[type="range"]:not(#image-compare-slider)');
        const enhanceLargePreviewModal = document.getElementById('enhanceLargePreviewModal');
        const enhanceLargeImage = document.getElementById('enhanceLargeImage');
        const closeEnhanceLargePreviewBtn = document.getElementById('closeEnhanceLargePreviewBtn');
        const metadataModal = document.getElementById('metadataModal');
        const closeMetadataModalBtn = document.getElementById('closeMetadataModalBtn');
        const metadataContent = document.getElementById('metadataContent');
        const exportMetadataBtn = document.getElementById('exportMetadataBtn');
        const promptModal = document.getElementById('promptModal');
        const closePromptModalBtn = document.getElementById('closePromptModalBtn');
        const promptContent = document.getElementById('promptContent');
        const copyPromptBtn = document.getElementById('copyPromptBtn');
        const batchModal = document.getElementById('batchModal');
        const closeBatchModalBtn = document.getElementById('closeBatchModalBtn');
        const batchUploadBox = document.getElementById('batchUploadBox');
        const batchImageUpload = document.getElementById('batchImageUpload');
        const batchBrowseBtn = document.getElementById('batchBrowseBtn');
        const batchQueueList = document.getElementById('batchQueueList');
        const batchQueueCount = document.getElementById('batchQueueCount');
        const batchClearQueueBtn = document.getElementById('batchClearQueueBtn');
        const batchUpscaleSelect = document.getElementById('batchUpscaleSelect');
        const batchProgress = document.getElementById('batchProgress');
        const startBatchProcessBtn = document.getElementById('startBatchProcessBtn');
        const downloadBatchZipBtn = document.getElementById('downloadBatchZipBtn');
        const downloadMetadataCsvBtn = document.getElementById('downloadMetadataCsvBtn');
        const batchSliders = document.querySelectorAll('#batchModal input[type="range"]:not(#batch-image-compare-slider)');
        const batchAddMoreBtn = document.getElementById('batchAddMoreBtn'); 
        const batchPreviewContainer = document.getElementById('batchPreviewContainer'); 
        const closeBatchPreviewBtn = document.getElementById('closeBatchPreviewBtn');
        const batchBeforeImageSlider = document.getElementById('batch-beforeImageSlider'); 
        const batchAfterImageSliderContainer = document.getElementById('batch-afterImageSliderContainer'); 
        const batchAfterImageSlider = document.getElementById('batch-afterImageSlider'); 
        const batchSliderHandle = document.getElementById('batch-slider-handle'); 
        const batchImageCompareSlider = document.getElementById('batch-image-compare-slider');
        const srUploadPreviewContainer = document.getElementById('srUploadPreviewContainer');
        const srRemoveImageBtn = document.getElementById('srRemoveImageBtn');
        const batchAddWatermark = document.getElementById('batchAddWatermark');
        const batchWatermarkOptions = document.getElementById('batchWatermarkOptions');
        const batchWatermarkTypeRadios = document.querySelectorAll('input[name="batchWatermarkType"]');
        const batchWatermarkTextOptions = document.getElementById('batchWatermarkTextOptions');
        const batchWatermarkImageOptions = document.getElementById('batchWatermarkImageOptions');
        const batchWatermarkText = document.getElementById('batchWatermarkText');
        const batchWatermarkImageUpload = document.getElementById('batchWatermarkImageUpload');
        const batchWatermarkImageBtn = document.getElementById('batchWatermarkImageBtn');
        const batchWatermarkPreview = document.getElementById('batchWatermarkPreview');
        const batchWatermarkSize = document.getElementById('batchWatermarkSize');
        const batchWatermarkSizeValue = document.getElementById('batchWatermarkSizeValue');
        const batchWatermarkOpacity = document.getElementById('batchWatermarkOpacity');
        const batchWatermarkOpacityValue = document.getElementById('batchWatermarkOpacityValue');
        const batchWatermarkPosition = document.getElementById('batchWatermarkPosition');
        const batchGenerateMetadata = document.getElementById('batchGenerateMetadata');
        const localVariationsModal = document.getElementById('localVariationsModal');
        const closeLocalVariationsModalBtn = document.getElementById('closeLocalVariationsModalBtn');
        const lvCountInput = document.getElementById('lvCount');
        const lvIntensitySelect = document.getElementById('lvIntensity');
        const lvSeedInput = document.getElementById('lvSeed');
        const lvSizeSelect = document.getElementById('lvSize');
        const lvGenerateBtn = document.getElementById('lvGenerateBtn');
        const lvDownloadAllBtn = document.getElementById('lvDownloadAllBtn');
        const lvProgress = document.getElementById('lvProgress');
        const lvGrid = document.getElementById('lvGrid');
        const lvEmpty = document.getElementById('lvEmpty');
        let lvResults = [];

        if (progressCircle) {
            const circleRadius = progressCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * circleRadius;
            progressCircle.style.strokeDasharray = `${circumference} ${circumference}`;
            progressCircle.style.strokeDashoffset = circumference;
        }

        window.showToast = (message, type = 'success') => {
            if (!toastNotification) { console.error("Toast element not found!"); return; }
            toastNotification.textContent = message;
            toastNotification.className = '';
            toastNotification.classList.add('show', type);
            setTimeout(() => toastNotification.classList.remove('show'), 4000);
        };

        window.updateEnhanceButtonState = () => {
            const isImageLoaded = !!imageBase64;
            const isCvReady = window.isOpenCvReady;
            const isBackendReady = isImageLoaded; 

            if (enhanceBtn) enhanceBtn.disabled = !(isBackendReady && isCvReady);
            if (metadataBtn) metadataBtn.disabled = !isBackendReady;
            if (promptBtn) promptBtn.disabled = !isBackendReady;
            if (superResolutionBtn) superResolutionBtn.disabled = !isImageLoaded;
            if (localVariationsBtn) localVariationsBtn.disabled = !(isImageLoaded && isCvReady);
            if (cropBtn) cropBtn.disabled = !isImageLoaded;
            if (objectRemovalBtn) objectRemovalBtn.disabled = !isBackendReady;
            if (reimagineBtn) reimagineBtn.disabled = !isBackendReady;
            if (normalUpscaleToggleBtn) normalUpscaleToggleBtn.disabled = !(isImageLoaded && isCvReady);
            if (aiUpscaleToggleBtn) aiUpscaleToggleBtn.disabled = !isBackendReady;

            if (objectRemovalBtn) objectRemovalBtn.title = isImageLoaded ? "Remove objects from the image" : "Image required";
            if (reimagineBtn) reimagineBtn.title = isImageLoaded ? "Create variations of the image" : "Image required";
            if (aiUpscaleToggleBtn) aiUpscaleToggleBtn.title = isImageLoaded ? "Upscale using AI" : "Image required";
        };

        const updateUI = () => {
            const isAnalysisReady = !!imageBase64; 
            if (analyzeBtn) analyzeBtn.disabled = !isAnalysisReady;
            window.updateEnhanceButtonState();
        };
        
        const setProgress = (percent) => {
            if (!progressCircle || !scoreText) return;
            const circleRadius = progressCircle.r.baseVal.value;
            const circumference = 2 * Math.PI * circleRadius;
            const targetPercent = Math.max(0, Math.min(100, Math.round(percent)));
            const offset = circumference - (targetPercent / 100) * circumference;
            progressCircle.style.strokeDashoffset = offset;
            scoreText.textContent = `${targetPercent}%`; 
        };

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = error => reject(error);
        });

        const handleFileSelect = async (file, cacheKeyToLoad = null) => {
            if (!file || !file.type.startsWith('image/')) {
                if (window.showToast) window.showToast('Please select a valid image file.', 'error');
                return;
            }
            
            const uploadPreview = document.getElementById('uploadPreview');
            const uploadPreviewImage = document.getElementById('uploadPreviewImage');
            if (uploadPreview && uploadPreviewImage) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadPreviewImage.src = e.target.result;
                    uploadPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
            
            resetPreview();
            currentFileObject = file;
            currentUploadedFileName = file.name;
            currentRecentFileCacheKey = cacheKeyToLoad; 

            if (uploadBox) uploadBox.classList.add('hidden');
            if (imagePreviewContainer) imagePreviewContainer.classList.remove('hidden');
            
            const objectURL = URL.createObjectURL(file);
            
            const img = new Image();
            img.onload = () => {
                currentImageDimensions = { width: img.naturalWidth, height: img.naturalHeight };
                if (typeof displayImageTechProperties === 'function') displayImageTechProperties();
            };
            img.src = objectURL;
            if (imagePreview) imagePreview.src = objectURL;
            
            try {
                imageBase64 = await toBase64(file);
                originalImageSrcForEnhance = objectURL;
                enhancedImageSrcForEnhance = objectURL;
                if (window.showToast) window.showToast('Image loaded successfully!', 'success');
                updateUI();
                if (!cacheKeyToLoad) {
                    currentRecentFileCacheKey = await addFileToRecents(file);
                }
            } catch (error) {
                console.error("File to Base64 conversion error:", error);
                if (window.showToast) window.showToast('Failed to read the image file.', 'error');
                resetPreview();
            }
        };

        const resetPreview = () => {        
            const uploadPreview = document.getElementById('uploadPreview');
            const uploadPreviewImage = document.getElementById('uploadPreviewImage');
            if (uploadPreview) {
                uploadPreview.classList.add('hidden');
                if (uploadPreviewImage) {
                    uploadPreviewImage.src = '';
                }
            }
            
            if (uploadBox) uploadBox.classList.remove('hidden');
            if (imagePreviewContainer) imagePreviewContainer.classList.add('hidden');
            const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='300'%3E%3Crect width='100%25' height='100%25' fill='%23222b3a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='gray' font-size='24'%3ENo Image%3C/text%3E%3C/svg%3E";
            if (imagePreview) imagePreview.src = placeholderSvg;
            
            if (beforeImageSlider) beforeImageSlider.src = '';
            if (afterImageSlider) afterImageSlider.src = '';

            imageBase64 = ''; originalImageSrcForEnhance = ''; enhancedImageSrcForEnhance = '';
            currentFileObject = null; currentImageDimensions = { width: 0, height: 0 };
            analysisResults = null; enhancementSuggestionsData = null; currentMetadata = null;
            currentUploadedFileName = '';
            currentRecentFileCacheKey = null;
            if (resultsContent) resultsContent.classList.add('hidden');
            if (initialState) initialState.classList.remove('hidden');
            if (loadingState) loadingState.classList.add('hidden');
            setProgress(0);
            if (scoreBreakdown) scoreBreakdown.innerHTML = '';
            if (tagsContainer) tagsContainer.innerHTML = '';
            if (qualityInsights) qualityInsights.innerHTML = '';
            if (imageUrlInput) imageUrlInput.value = '';
            if (imageUpload) imageUpload.value = ''; 
            updateUI();
        };

        const displayAnalysisResults = (data) => {
            analysisResults = data; setProgress(data.aestheticScore || 0);
            if (scoreBreakdown) {
                scoreBreakdown.innerHTML = '';
                const breakdownItems = data.scoreBreakdown || {};
                const breakdownIcons = { lighting: 'ph-sun', composition: 'ph-grid-four', sharpness: 'ph-selection-background', colorHarmony: 'ph-palette', subjectFocus: 'ph-user-focus' };
                Object.entries(breakdownItems).forEach(([key, value]) => {
                    const iconClass = breakdownIcons[key] || 'ph-question';
                    const displayName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    scoreBreakdown.innerHTML += `<div class="flex items-center justify-between text-sm"><div class="flex items-center gap-2"><i class="${iconClass} text-sky-400"></i><span class="text-gray-300">${displayName}</span></div><span class="font-semibold text-white">${value}/100</span></div>`;
                });
            }
            if (tagsContainer) {
                 tagsContainer.innerHTML = ''; (data.tags || []).forEach(tag => { tagsContainer.innerHTML += `<span class="bg-gray-700 text-gray-200 text-xs font-medium px-2.5 py-1 rounded-full">${tag}</span>`; });
            }
            if (qualityInsights) {
                qualityInsights.innerHTML = '';
                const insights = data.qualityInsights || {};
                const qualityIcons = {
                    compositionQuality: { 'Excellent': 'ph-fill ph-star-four text-green-400', 'Good': 'ph-fill ph-thumbs-up text-sky-400', 'Fair': 'ph-fill ph-warning-circle text-yellow-400', 'Poor': 'ph-fill ph-x-circle text-red-400' },
                    brightness: { 'Balanced': 'ph-fill ph-check-circle text-green-400', 'Underexposed': 'ph-fill ph-warning text-yellow-400', 'Overexposed': 'ph-fill ph-warning text-yellow-400' },
                    contrast: { 'High': 'ph-fill ph-arrow-up text-sky-400', 'Medium': 'ph-fill ph-minus-circle text-gray-400', 'Low': 'ph-fill ph-arrow-down text-yellow-400' },
                    noiseLevel: { 'Low': 'ph-fill ph-check-circle text-green-400', 'Moderate': 'ph-fill ph-warning-circle text-yellow-400', 'High': 'ph-fill ph-warning text-red-400' },
                    subjectClarity: { 'Sharp': 'ph-fill ph-check-circle text-green-400', 'Soft': 'ph-fill ph-warning-circle text-yellow-400', 'Blurry': 'ph-fill ph-x-circle text-red-400' },
                    overallImpression: 'ph-chat-circle-text text-gray-400'
                };
                Object.entries(insights).forEach(([key, value]) => {
                    let iconClass = 'ph-info text-gray-400';
                    if (qualityIcons[key]) {
                        if (typeof qualityIcons[key] === 'string') {
                            iconClass = qualityIcons[key];
                        } else if (qualityIcons[key][value]) {
                            iconClass = qualityIcons[key][value];
                        }
                    }
                    const displayName = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    qualityInsights.innerHTML += `
                        <div class="flex justify-between items-center mb-2 text-sm">
                            <span class="font-medium text-gray-300">${displayName}</span>
                            <div class="flex items-center gap-2 font-semibold">
                                <i class="${iconClass} text-lg"></i>
                                <span class="text-white">${value}</span>
                            </div>
                        </div>`;
                });
            }
            if (resultsContent) resultsContent.classList.remove('hidden');
            if (initialState) initialState.classList.add('hidden');
            if (loadingState) loadingState.classList.add('hidden');
        };

        const displayEnhanceResults = (data) => {
            enhancementSuggestionsData = data.suggestions; 
            if (!enhanceSuggestions) return;
            enhanceSuggestions.innerHTML = '';
            if (resetEnhancementsBtn) resetEnhancementsBtn.click(); 
            if (enhancementSuggestionsData && enhancementSuggestionsData.length > 0) {
                enhanceSuggestions.innerHTML = enhancementSuggestionsData.map((item, index) => `
                    <button data-suggestion-index="${index}" class="suggestion-btn w-full text-left p-3 bg-gray-900/50 rounded-lg border border-gray-700 hover:bg-gray-800 hover:border-sky-500 transition-all focus:outline-none focus:ring-2 focus:ring-sky-500">
                        <div class="flex items-center"><div class="flex-grow"><p class="font-semibold text-white mb-1">${item.adjustment}</p><p class="text-gray-400 text-xs">${item.reason}</p></div><span class="applied-indicator text-green-400 text-xl ml-2"></span></div></button>`).join('');
            } else { enhanceSuggestions.innerHTML = `<p class="text-gray-500">AI found no specific issues for the selected mode. You can still make manual adjustments or try a different mode.</p>`; }
            
            if (beforeImageSlider) beforeImageSlider.src = originalImageSrcForEnhance;
            if (afterImageSlider) afterImageSlider.src = originalImageSrcForEnhance;
            enhancedImageSrcForEnhance = originalImageSrcForEnhance;
            if (imageCompareSlider) {
                imageCompareSlider.value = 50;
                imageCompareSlider.dispatchEvent(new Event('input'));
            }
            if (enhanceModal) enhanceModal.classList.remove('hidden');
        };

        const callGeminiAPI = async (prompt, imageBase64Data_unused, expectJson = true) => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                throw new Error("Gemini API key is missing. Please set it in the settings.");
            }
            
            console.log("Resizing image before sending to Gemini API...");
            if (!originalImageSrcForEnhance) throw new Error("Original image source is missing.");

            const imageBlobForApi = await resizeImageForApi(originalImageSrcForEnhance, 1024);
            const imageBase64Data = await toBase64(imageBlobForApi);
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro-vision:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    parts: [
                        { text: prompt },
                        { inline_data: { mime_type: "image/jpeg", data: imageBase64Data } }
                    ]
                }]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorResult = await response.json();
                const errorMessage = errorResult?.error?.message || `Server error: ${response.status}`;
                throw new Error(errorMessage);
            }

            const result = await response.json();
            const textContent = result.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!textContent) throw new Error("Invalid API response structure from server.");

            if (expectJson) {
                try {
                    const jsonMatch = textContent.match(/```json\s*([\s\S]*?)\s*```|({[\s\S]*})/);
                    if (!jsonMatch) throw new Error("No JSON object found in API response.");
                    return JSON.parse(jsonMatch[1] || jsonMatch[2]);
                } catch(e) {
                     throw new Error("AI response was not valid JSON. " + e.message);
                }
            } else {
                return textContent;
            }
        };
      
        const handleAnalyze = async () => {
            if (!imageBase64) { if (window.showToast) window.showToast('An image is required for analysis.', 'error'); return; }
            if (loadingText) loadingText.textContent = 'Analyzing Image...';
            if (initialState) initialState.classList.add('hidden');
            if (resultsContent) resultsContent.classList.add('hidden');
            if (loadingState) loadingState.classList.remove('hidden');
            const promptText = `Analyze the provided image for a comprehensive, professional-level aesthetic and technical review. Output ONLY a valid JSON object. Do not include any explanatory text before or after the JSON. The JSON object should have the following structure: { "aestheticScore": <number from 0-100 for overall appeal>, "scoreBreakdown": { "lighting": <number 0-100>, "composition": <number 0-100>, "sharpness": <number 0-100>, "colorHarmony": <number 0-100>, "subjectFocus": <number 0-100> }, "tags": ["<up to 25 concise tags>"], "qualityInsights": { "compositionQuality": "<'Poor'|'Fair'|'Good'|'Excellent'>", "brightness": "<'Underexposed'|'Balanced'|'Overexposed'>", "contrast": "<'Low'|'Medium'|'High'>", "noiseLevel": "<'Low'|'Moderate'|'High'>", "subjectClarity": "<'Blurry'|'Soft'|'Sharp'>", "overallImpression": "<Briefly, e.g., 'Snapshot feel'>" }, "enhancementSuggestions": [ { "adjustment": "<e.g., 'Increase brightness by +10', 'Reduce saturation by -15', 'Sharpen image'>", "reason": "<why this will improve the image>" } ] } Ensure all numeric scores are integers. For adjustments, if a numeric value is implied, include it with its sign (e.g., +10, -15).`;
            try {
                const parsedData = await callGeminiAPI(promptText, imageBase64);
                if (currentFileObject && window.logUserAction) {
                    window.logUserAction('analyze_image', { 
                        filename: currentFileObject.name, 
                        filesize: currentFileObject.size 
                    });
                }
                displayAnalysisResults(parsedData);
                if (window.showToast) window.showToast('Analysis complete!', 'success');
            } catch (error) {
                console.error('Analysis failed:', error);
                if (window.showToast) window.showToast(`Analysis failed: ${error.message}`, 'error');
                if (loadingState) loadingState.classList.add('hidden');
                if (!analysisResults && initialState) initialState.classList.remove('hidden');
                else if (resultsContent) resultsContent.classList.remove('hidden');
            }
        };

        const formatBytes = (bytes, decimals = 2) => {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        };

        const displayImageTechProperties = () => {
            const fileNameEl = document.getElementById('tech-prop-filename');
            const dimensionsEl = document.getElementById('tech-prop-dimensions');
            const filesizeEl = document.getElementById('tech-prop-filesize');
            const filetypeEl = document.getElementById('tech-prop-filetype');
            const hFileNameEl = document.getElementById('hover-tech-prop-filename');
            const hDimensionsEl = document.getElementById('hover-tech-prop-dimensions');
            const hFilesizeEl = document.getElementById('hover-tech-prop-filesize');
            const hFiletypeEl = document.getElementById('hover-tech-prop-filetype');

            const setValues = (els, values) => {
                if (!els) return;
                els.forEach((el, idx) => {
                    if (el) el.textContent = values[idx];
                });
            };

            if (!currentFileObject) {
                setValues([fileNameEl, dimensionsEl, filesizeEl, filetypeEl], ['N/A','N/A','N/A','N/A']);
                setValues([hFileNameEl, hDimensionsEl, hFilesizeEl, hFiletypeEl], ['N/A','N/A','N/A','N/A']);
                if (fileNameEl) fileNameEl.title = 'N/A';
                return;
            }

            const nameVal = currentUploadedFileName || 'N/A';
            const dimVal = `${currentImageDimensions.width} x ${currentImageDimensions.height} px`;
            const sizeVal = formatBytes(currentFileObject.size);
            const typeVal = currentFileObject.type || 'N/A';

            setValues([fileNameEl, hFileNameEl], [nameVal, nameVal]);
            if (fileNameEl) fileNameEl.title = nameVal;
            setValues([dimensionsEl, hDimensionsEl], [dimVal, dimVal]);
            setValues([filesizeEl, hFilesizeEl], [sizeVal, sizeVal]);
            setValues([filetypeEl, hFiletypeEl], [typeVal, typeVal]);
        };

        const handleEnhance = async () => {
            if (!imageBase64) { if (window.showToast) window.showToast('An image is required.', 'error'); return; }
            if (!window.isOpenCvReady) { if (window.showToast) window.showToast('Enhancement engine (OpenCV) is not ready. Please wait.', 'info'); return; }
            displayEnhanceResults({ suggestions: [] }); 
            displayImageTechProperties();
            if (window.showToast) window.showToast('Opened Enhancement Panel. Generate suggestions or adjust manually.', 'info');
            const selectedPromptType = enhancePromptTypeDropdown.value;
            let promptForEnhancement = '';
            const knownAdjustments = "Brightness, Contrast, Exposure, Shadows, Highlights, Saturation, Vibrance, Temperature, Tint, Sharpen, Denoise, Vignette";
            const commonPromptSuffix = ` For each suggestion, provide a precise adjustment string using ONLY terms from this list: [${knownAdjustments}], followed by a numeric value with its sign if applicable (e.g., 'Increase Brightness by +10', 'Reduce Saturation by -15', 'Adjust Temperature by +5'). If a numeric value is not naturally part of a listed adjustment (e.g., 'Sharpen image', 'Denoise'), state the adjustment simply using only the listed terms. Output ONLY the valid JSON object: {"suggestions": [{"adjustment": "string", "reason": "string"}]}`;
            switch (selectedPromptType) {
                case 'microstock': promptForEnhancement = `You are a meticulous AI image quality inspector for microstock sites. Identify technical flaws: Lighting, Contrast, Shadow, Focus, Color Balance, Noise/Artifacts. If flaws exist, provide actionable suggestions. If no sound, return empty suggestions. ${commonPromptSuffix}`; break;
                case 'aesthetic': promptForEnhancement = `Analyze the image for overall visual appeal. Suggest 3-5 enhancements for color, light, clarity, composition. ${commonPromptSuffix}`; break;
                case 'artistic': promptForEnhancement = `This is an artistic image. Suggest 3-4 enhancements for artistic impact (mood, color harmony, texture, creative effects). Avoid making it look like a standard photo. ${commonPromptSuffix}`; break;
                case 'fix_common': promptForEnhancement = `Assume this image is by an amateur. Look for common mistakes (exposure, contrast, focus, dull colors). Provide 2-3 simple fixes. ${commonPromptSuffix}`; break;
                default: if (window.showToast) window.showToast('Invalid enhancement mode selected.', 'error'); return;
            }
            if (enhanceSuggestions) enhanceSuggestions.innerHTML = `<p class="text-gray-400 flex items-center gap-2"><i class="ph ph-spinner animate-spin text-2xl mr-2"></i>Generating suggestions...</p>`;
            try {
                const parsedData = await callGeminiAPI(promptForEnhancement, imageBase64, true);
                displayEnhanceResults(parsedData);
                displayImageTechProperties(); 
            } catch (error) {
                console.error('Enhancement suggestions failed:', error);
                if (window.showToast) window.showToast(`Enhancement suggestions failed: ${error.message}`, 'error');
                 if (enhanceSuggestions) enhanceSuggestions.innerHTML = `<p class="text-red-400">Failed to get suggestions. You can still use manual controls.</p>`;
            }
        };

        const copyToClipboard = (text, type = 'Text') => {
           if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text).then(() => {
                if (window.showToast) window.showToast(`${type} copied to clipboard!`);
            }).catch(err => {
                if (window.showToast) window.showToast(`Failed to copy ${type}.`, 'error');
                console.error('Async clipboard copy failed:', err);
            });
        } else {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.style.position = 'absolute';
            tempTextArea.style.left = '-9999px';
            tempTextArea.value = text;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                document.execCommand('copy');
                if (window.showToast) window.showToast(`${type} copied to clipboard!`);
            } catch (err) {
                if (window.showToast) window.showToast(`Failed to copy ${type}.`, 'error');
                console.error('Fallback clipboard copy failed:', err);
            }
            document.body.removeChild(tempTextArea);
        }
    };

        const updateEnhancedImage = (dataUrl) => {
            enhancedImageSrcForEnhance = dataUrl;
            if (afterImageSlider) afterImageSlider.src = dataUrl;
            if (imageCompareSlider) {
                imageCompareSlider.value = 100;
                imageCompareSlider.dispatchEvent(new Event('input'));
            }
        };
    
                const handleImageUrlInput = async () => {
            if (!imageUrlInput) return;
            const url = imageUrlInput.value.trim();
            if (!url) {
                if (window.showToast) window.showToast('Please enter an image URL.', 'info');
                return;
            }

            // একটি ফ্রি CORS প্রক্সি ব্যবহার করা হচ্ছে
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const fetchUrl = proxyUrl + encodeURIComponent(url);
            
            const filename = url.substring(url.lastIndexOf('/') + 1).split('?')[0] || "image_from_url.jpg";
            if (uploadBox) uploadBox.classList.add('hidden');
            if (imagePreviewContainer) imagePreviewContainer.classList.remove('hidden');
            if (imagePreview) imagePreview.src = ''; // লোডিং এর জন্য প্রিভিউ ক্লিয়ার করা হচ্ছে

            try {
                // সরাসরি URL এর পরিবর্তে প্রক্সি URL দিয়ে fetch করা হচ্ছে
                const response = await fetch(fetchUrl);
                if (!response.ok) throw new Error(`Failed to fetch image via proxy: ${response.status} ${response.statusText}`);
                
                const blob = await response.blob();
                if (!blob.type.startsWith('image/')) throw new Error('Fetched content is not a valid image type.');
                
                const file = new File([blob], filename, { type: blob.type });
                await handleFileSelect(file);
                imageUrlInput.value = '';
            } catch (error) {
                console.error("Error fetching image from URL:", error);
                if (window.showToast) window.showToast(`Failed to load image from URL: ${error.message}. Check CORS.`, 'error');
                resetPreview();
            }
        };
        const handleGetMetadata = async () => {
            if (!imageBase64) { if (window.showToast) window.showToast('An image is required.', 'error'); return; }
            if (metadataContent) metadataContent.innerHTML = `<div class="flex items-center justify-center text-gray-400"><i class="ph ph-spinner animate-spin text-2xl mr-2"></i>Generating metadata...</div>`;
            if (metadataModal) metadataModal.classList.remove('hidden');
            const thumb = document.getElementById('metadataThumb');
            const fileNameDiv = document.getElementById('metadataFileName');
            if (thumb) thumb.src = originalImageSrcForEnhance || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' fill='%23222b3a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='gray' font-size='18'%3ENo Image%3C/text%3E%3C/svg%3E";
            if (fileNameDiv) fileNameDiv.textContent = currentUploadedFileName;
            const promptText = `Analyze the image and generate SEO-friendly metadata. Provide ONLY a valid JSON object with the keys: 'fileName', 'title', and 'keywords' (as an array of strings). Use the original image's characteristics. Example: {"fileName": "red-rose-with-dew-drops.jpg", "title": "Vibrant Red Rose Covered in Morning Dew | Macro Photography", "keywords": ["red rose", "flower", "macro", "dew drops", "nature", "romance", "beauty"]}`;
            try { const data = await callGeminiAPI(promptText, imageBase64, true); currentMetadata = data;  logUserAction('generate_metadata', {
                    filename: currentUploadedFileName
                }); displayMetadata(data); } 
            catch (error) { console.error('Metadata generation failed:', error); if (window.showToast) window.showToast(`Metadata generation failed: ${error.message}`, 'error'); if (metadataContent) metadataContent.innerHTML = `<p class="text-red-400">Failed to generate metadata.</p>`; }
        };
        const displayMetadata = (data) => {
            if (!metadataContent) return; const { fileName, title, keywords } = data;
            const createRow = (label, value) => `<div class="flex items-start justify-between gap-4"><div class="flex-1"><label class="block text-sm font-semibold text-gray-400 mb-1">${label}</label><p class="text-gray-200 bg-gray-900/50 p-2 rounded-md text-sm">${value}</p></div><button class="copy-metadata-btn mt-7 bg-sky-700 hover:bg-sky-600 text-white font-semibold px-3 py-1.5 rounded-lg transition-colors text-xs flex items-center gap-1.5" data-text="${value}" data-type="${label}"><i class="ph ph-copy"></i> Copy</button></div>`;
            metadataContent.innerHTML = `${createRow('File Name', fileName || currentUploadedFileName || 'N/A')}${createRow('Title', title || 'N/A')}${createRow('Keywords', (keywords || []).join(', '))}`;
        };
        const handleGetPrompt = async () => {
            if (!imageBase64) { if (window.showToast) window.showToast('An image is required.', 'error'); return; }
            if (promptContent) promptContent.textContent = 'Generating prompt...'; if (promptModal) promptModal.classList.remove('hidden');
            const thumb = document.getElementById('promptThumb');
            const fileNameDiv = document.getElementById('promptFileName');
            if (thumb) thumb.src = originalImageSrcForEnhance || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' fill='%23222b3a'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='gray' font-size='18'%3ENo Image%3C/text%3E%3C/svg%3E";
            if (fileNameDiv) fileNameDiv.textContent = currentUploadedFileName;
            const promptText = `Describe the provided image in vivid detail, as if you were creating a prompt for an AI image generator like Midjourney or DALL-E. Capture the subject, style, lighting, composition, and mood. Provide ONLY the text of the prompt, without any extra formatting, labels, or quotation marks.`;
            try { const data = await callGeminiAPI(promptText, imageBase64, false); displayPrompt(data); } 
            catch(error) { console.error('Prompt generation failed:', error); if (window.showToast) window.showToast(`Prompt generation failed: ${error.message}`, 'error'); if (promptContent) promptContent.textContent = `Failed to generate prompt.`; }
        };
        const displayPrompt = (promptText) => { if (promptContent) promptContent.textContent = promptText; };
        const exportMetadataAsCsv = () => {
            if (!currentMetadata) { if (window.showToast) window.showToast('No metadata to export.', 'error'); return; }
            const { fileName, title, keywords } = currentMetadata;
            const escapeCsvCell = (cell) => { const strCell = String(cell || ''); if (strCell.includes(',') || strCell.includes('"') || strCell.includes('\n')) { return `"${strCell.replace(/"/g, '""')}"`; } return strCell; };
            const headers = ['File Name', 'Title', 'Keywords']; const row = [escapeCsvCell(fileName || currentUploadedFileName), escapeCsvCell(title), escapeCsvCell((keywords || []).join(', '))];
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n' + row.join(',');
            const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "metadata.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); if(window.showToast) window.showToast('Metadata exported as CSV.');
        };
        const applyManualEnhancements = () => {
            if (!window.isOpenCvReady || !originalImageSrcForEnhance) return;
            let img = new Image();
            img.crossOrigin = "Anonymous";
            img.onload = () => {
                let src = null, dst = null;
                try {
                    src = cv.imread(img);
                    if (src.empty()) throw new Error('Failed to read original image for manual enhancement.');
                    dst = src.clone();
                    let exposureValue = parseFloat(document.getElementById('slider-exposure').value) || 0;
                    let brightnessValue = parseFloat(document.getElementById('slider-brightness').value) || 0;
                    let contrastValue = parseFloat(document.getElementById('slider-contrast').value) || 0;
                    let saturationValue = parseFloat(document.getElementById('slider-saturation').value) || 0;
                    let temperatureValue = parseFloat(document.getElementById('slider-temperature').value) || 0;
                    let vibranceValue = parseFloat(document.getElementById('slider-vibrance').value) || 0;
                    let blurSharpenValue = parseFloat(document.getElementById('slider-blur').value) || 0;
                    let highlightsValue = parseFloat(document.getElementById('slider-highlights').value) || 0;
                    let shadowsValue = parseFloat(document.getElementById('slider-shadows').value) || 0;
                    let vignetteValue = parseFloat(document.getElementById('slider-vignette').value) || 0;
                    let denoiseValue = parseFloat(document.getElementById('slider-denoise').value) || 0;
                    if (exposureValue !== 0 || brightnessValue !== 0 || contrastValue !== 0) {
                        let alpha = 1.0 + contrastValue / 100.0;
                        let beta = brightnessValue;
                        let exposureFactor = Math.pow(2, exposureValue / 100.0);
                        dst.convertTo(dst, -1, alpha * exposureFactor, beta);
                    }
                    if (highlightsValue !== 0 || shadowsValue !== 0) {
                        let lab = new cv.Mat();
                        cv.cvtColor(dst, lab, cv.COLOR_RGB2Lab);
                        let lab_planes = new cv.MatVector();
                        cv.split(lab, lab_planes);
                        let L = lab_planes.get(0);
                        let l_channel = new cv.Mat(L.rows, L.cols, L.type());
                        L.copyTo(l_channel);
                        let shadowFactor = shadowsValue / 100.0;
                        let highlightFactor = -highlightsValue / 100.0;
                        for (let i = 0; i < l_channel.rows; i++) {
                            for (let j = 0; j < l_channel.cols; j++) {
                                let pixel = l_channel.ucharPtr(i, j)[0];
                                let newPixel = pixel;
                                if (shadowsValue !== 0) {
                                    let shadowAdj = shadowFactor > 0 ? (Math.pow(255 - pixel, 0.5) * shadowFactor * 5) : (Math.pow(pixel, 0.5) * shadowFactor * 5);
                                    newPixel += shadowAdj;
                                }
                                if (highlightsValue !== 0) {
                                    let highlightAdj = highlightFactor < 0 ? (Math.pow(pixel, 0.5) * highlightFactor * 5) : (Math.pow(255 - pixel, 0.5) * highlightFactor * 5);
                                     newPixel += highlightAdj;
                                }
                                l_channel.ucharPtr(i, j)[0] = Math.max(0, Math.min(255, newPixel));
                            }
                        }
                        lab_planes.set(0, l_channel);
                        cv.merge(lab_planes, lab);
                        cv.cvtColor(lab, dst, cv.COLOR_Lab2RGB);
                        l_channel.delete(); lab.delete(); lab_planes.delete();
                    }
                    if (saturationValue !== 0 || vibranceValue !== 0 || temperatureValue !== 0) {
                        let hsv = new cv.Mat();
                        cv.cvtColor(dst, hsv, cv.COLOR_RGB2HSV);
                        let hsv_planes = new cv.MatVector();
                        cv.split(hsv, hsv_planes);
                        let s = hsv_planes.get(1);
                        if (saturationValue !== 0 || vibranceValue !== 0) {
                             let sat_alpha = 1.0 + saturationValue / 100.0;
                             let vibranceFactor = vibranceValue / 100.0;
                             for (let i = 0; i < s.rows; i++) {
                                for (let j = 0; j < s.cols; j++) {
                                    let sat_pixel = s.ucharPtr(i,j)[0];
                                    let new_sat = sat_pixel * sat_alpha;
                                    let adjustment = vibranceFactor * (255 - new_sat);
                                    s.ucharPtr(i, j)[0] = Math.max(0, Math.min(255, Math.round(new_sat + adjustment)));
                                }
                            }
                        }
                        cv.merge(hsv_planes, hsv);
                        cv.cvtColor(hsv, dst, cv.COLOR_HSV2RGB);
                        hsv.delete(); hsv_planes.delete(); s.delete();
                        if (temperatureValue !== 0) {
                            let bgr_planes = new cv.MatVector();
                            cv.split(dst, bgr_planes);
                            let b = bgr_planes.get(0);
                            let r = bgr_planes.get(2);
                            let adjustment_mat = cv.Mat.ones(dst.rows, dst.cols, b.type());
                            if (temperatureValue > 0) { 
                                adjustment_mat.convertTo(adjustment_mat, -1, temperatureValue / 2.55, 0);
                                cv.add(r, adjustment_mat, r);
                            } else { 
                                adjustment_mat.convertTo(adjustment_mat, -1, -temperatureValue / 2.55, 0);
                                cv.add(b, adjustment_mat, b);
                            }
                            cv.merge(bgr_planes, dst);
                            bgr_planes.delete(); b.delete(); r.delete(); adjustment_mat.delete();
                        }
                    }
                    if (blurSharpenValue > 0) {
                        let blurred = new cv.Mat();
                        let amount = blurSharpenValue / 100.0;
                        cv.GaussianBlur(dst, blurred, new cv.Size(0, 0), 3, 0, cv.BORDER_DEFAULT);
                        cv.addWeighted(dst, 1.0 + amount, blurred, -amount, 0, dst);
                        blurred.delete();
                    } else if (blurSharpenValue < 0) {
                        let kernelSize = Math.floor(Math.abs(blurSharpenValue) / 10) * 2 + 1;
                        cv.GaussianBlur(dst, dst, new cv.Size(kernelSize, kernelSize), 0, 0, cv.BORDER_DEFAULT);
                    }
                    if (denoiseValue > 0 && cv.photo && cv.photo.fastNlMeansDenoisingColored) {
                        let hDenoise = denoiseValue * 0.3;
                        cv.photo.fastNlMeansDenoisingColored(dst, dst, hDenoise, 10, 7, 21);
                    }
                    if (vignetteValue > 0) {
                        let kernelX = cv.getGaussianKernel(dst.cols, vignetteValue * 2);
                        let kernelY = cv.getGaussianKernel(dst.rows, vignetteValue * 2);
                        let kernel = new cv.Mat();
                        cv.multiply(kernelY, kernelX.t(), kernel, 1, cv.CV_32F);
                        let mask = new cv.Mat();
                        cv.normalize(kernel, mask, 0, 1, cv.NORM_MINMAX);
                        let channels = new cv.MatVector();
                        cv.split(dst, channels);
                        for (let i = 0; i < channels.size(); i++) {
                            let channel32f = new cv.Mat();
                            channels.get(i).convertTo(channel32f, cv.CV_32F);
                            cv.multiply(channel32f, mask, channel32f);
                            channel32f.convertTo(channels.get(i), cv.CV_8U);
                            channel32f.delete();
                        }
                        cv.merge(channels, dst);
                        kernelX.delete(); kernelY.delete(); kernel.delete(); mask.delete(); channels.delete();
                    }
                    cv.imshow(enhancedImagePreviewCanvas, dst);
                    updateEnhancedImage(enhancedImagePreviewCanvas.toDataURL('image/jpeg'));
                } catch (e) { 
                    console.error("OpenCV Error applying manual enhancements:", e); 
                    if(window.showToast) window.showToast('Failed to apply manual adjustments. Check console.', 'error');
                } finally {
                    if (src) src.delete();
                    if (dst) dst.delete();
                }
            };
            img.src = originalImageSrcForEnhance;
        };
        const applySuggestion = (suggestion) => {
            console.log("Applying suggestion:", suggestion);
            try {
                if (!window.isOpenCvReady || !originalImageSrcForEnhance) { 
                    if (window.showToast) window.showToast('Enhancement engine not ready or no image loaded.', 'error'); return; 
                }
                const adjustmentText = suggestion.adjustment.toLowerCase();
                const getAdjustmentValue = (adjString, defaultValue = 0) => { const match = adjString.match(/(-?\+?\d+\.?\d*)/); return match ? parseFloat(match[0]) : defaultValue; };
                let value = getAdjustmentValue(suggestion.adjustment); 
                const applyViaSlider = (sliderId, changeAmount, defaultChange = 15) => {
                    const slider = document.getElementById(sliderId);
                    const valDisplay = document.getElementById(`sliderVal-${sliderId.split('-')[1]}`);
                    if (slider && valDisplay) {
                        let actualChange = changeAmount;
                        if (changeAmount === 0 && (adjustmentText.includes('increase') || adjustmentText.includes('boost'))) actualChange = defaultChange;
                        else if (changeAmount === 0 && (adjustmentText.includes('decrease') || adjustmentText.includes('reduce'))) actualChange = -defaultChange;
                        slider.value = actualChange;
                        slider.value = Math.max(parseFloat(slider.min), Math.min(parseFloat(slider.max), slider.value));
                        valDisplay.textContent = slider.value;
                        applyManualEnhancements();
                    }
                };
                if (adjustmentText.includes('brightness')) { applyViaSlider('slider-brightness', value, 10); } 
                else if (adjustmentText.includes('contrast')) { applyViaSlider('slider-contrast', value, 10); } 
                else if (adjustmentText.includes('saturation')) { applyViaSlider('slider-saturation', value, 15); } 
                else if (adjustmentText.includes('highlight')) { applyViaSlider('slider-highlights', value, 15); }
                else if (adjustmentText.includes('shadow')) { applyViaSlider('slider-shadows', value, 15); }
                else if (adjustmentText.includes('exposure')) { applyViaSlider('slider-exposure', value, 10); }
                else if (adjustmentText.includes('temperature')) { applyViaSlider('slider-temperature', value, 10); }
                else if (adjustmentText.includes('vibrance')) { applyViaSlider('slider-vibrance', value, 15); }
                else if (adjustmentText.includes('vignette')) { applyViaSlider('slider-vignette', value, 10); }
                else if (adjustmentText.includes('denoise')) { applyViaSlider('slider-denoise', value !== 0 ? value : 20, 20); } 
                else if (adjustmentText.includes('sharpen')) { applyViaSlider('slider-blur', value !== 0 ? value : 20, 20); } 
                else {
                    window.showToast(`AI suggested: "${suggestion.adjustment}". Please use manual sliders.`, 'info');
                    return;
                }
                window.showToast('Enhancement applied!', 'success');
            } catch (e) { 
                console.error("Error in applySuggestion wrapper:", e); 
                window.showToast('An unexpected error occurred while applying suggestion.', 'error'); 
            }
        };
        const handleRecheckImage = async () => {
              if (!enhancedImagePreviewCanvas || enhancedImagePreviewCanvas.width === 0) {
                  window.showToast('No enhanced image to re-check. Apply some changes first.', 'info');
             return;
             }
            
             const enhancedImageBase64 = enhancedImagePreviewCanvas.toDataURL('image/jpeg').split(',')[1];
            if (enhanceSuggestions) {
                enhanceSuggestions.innerHTML = `<p class="text-gray-400 flex items-center gap-2"><i class="ph ph-spinner animate-spin"></i> Re-checking image for issues...</p>`;
            }
            if (recheckImageBtn) recheckImageBtn.disabled = true;
            const selectedPromptType = enhancePromptTypeDropdown.value;
            let promptForRecheck = '';
            const knownAdjustments = "Brightness, Contrast, Exposure, Shadows, Highlights, Saturation, Vibrance, Temperature, Tint, Sharpen, Denoise, Vignette";
            const commonPromptSuffix = ` For each suggestion, provide a precise adjustment string using ONLY terms from this list: [${knownAdjustments}], followed by a numeric value with its sign if applicable (e.g., 'Increase Brightness by +10', 'Reduce Saturation by -15', 'Adjust Temperature by +5'). If a numeric value is not naturally part of a listed adjustment (e.g., 'Sharpen image', 'Denoise'), state the adjustment simply using only the listed terms. If the image is technically sound and has no obvious flaws for the given mode, return an empty "suggestions" array. Output ONLY the valid JSON object: {"suggestions": [{"adjustment": "string", "reason": "string"}]}`;
            switch (selectedPromptType) {
                case 'microstock': promptForRecheck = `You are a meticulous AI image quality inspector for microstock sites. Identify technical flaws: Lighting, Contrast, Shadow, Focus, Color Balance, Noise/Artifacts. If flaws exist, provide actionable suggestions. ${commonPromptSuffix}`; break;
                case 'aesthetic': promptForRecheck = `Analyze the image for overall visual appeal. Suggest 3-5 enhancements for color, light, clarity, composition. ${commonPromptSuffix}`; break;
                case 'artistic': promptForRecheck = `This is an artistic image. Suggest 3-4 enhancements for artistic impact (mood, color harmony, texture, creative effects). Avoid making it look like a standard photo. ${commonPromptSuffix}`; break;
                case 'fix_common': promptForRecheck = `Assume this image is by an amateur. Look for common mistakes (exposure, contrast, focus, dull colors). Provide 2-3 simple fixes. ${commonPromptSuffix}`; break;
                default: window.showToast('Invalid enhancement mode selected.', 'error'); if(recheckImageBtn) recheckImageBtn.disabled = false; return;
            }
            try {
                const parsedData = await callGeminiAPI(promptForRecheck, enhancedImageBase64, true);
                enhancementSuggestionsData = parsedData.suggestions; 
                if (enhancementSuggestionsData && enhancementSuggestionsData.length > 0) {
                     window.showToast('Found more areas for improvement!', 'info');
                     enhanceSuggestions.innerHTML = enhancementSuggestionsData.map((item, index) => `
                        <button data-suggestion-index="${index}" class="suggestion-btn w-full text-left p-3 bg-gray-900/50 rounded-lg border border-gray-700 hover:bg-gray-800 hover:border-sky-500 transition-all focus:outline-none focus:ring-2 focus:ring-sky-500">
                            <div class="flex items-center"><div class="flex-grow"><p class="font-semibold text-white mb-1">${item.adjustment}</p><p class="text-gray-400 text-xs">${item.reason}</p></div><span class="applied-indicator text-green-400 text-xl ml-2"></span></div></button>`).join('');
                } else {
                    window.showToast('Re-check complete. Image looks great!', 'success');
                    enhanceSuggestions.innerHTML = `<div class="flex items-center gap-3 p-3 rounded-lg bg-green-900/50 border border-green-700 text-green-300">
                        <i class="ph-fill ph-check-circle text-2xl"></i>
                        <div>
                            <p class="font-semibold">All Clear!</p>
                            <p class="text-xs">The AI found no further issues for the selected mode. The image is ready!</p>
                        </div>
                    </div>`;
                }
            } catch (error) {
                console.error('Image re-check failed:', error);
                window.showToast(`Image re-check failed: ${error.message}`, 'error');
                if (enhanceSuggestions) enhanceSuggestions.innerHTML = `<p class="text-red-400">Failed to re-check image. Please try again.</p>`;
            } finally {
                if (recheckImageBtn) recheckImageBtn.disabled = false;
            }
        };

        const handleAiUpscale = async (factor, buttonElement) => {
    if (!currentFileObject) {
        window.showToast('Please upload an image first.', 'error');
        return;
    }
    if (aiUpscaleDropdown) aiUpscaleDropdown.classList.add('hidden');
    window.showToast('Upscaling from original image. Manual adjustments will be reset.', 'info');
    if (resetSlidersBtn) resetSlidersBtn.click();
    
    const upscaleIcon = buttonElement?.querySelector('.upscale-icon');
    const upscaleSpinner = buttonElement?.querySelector('.upscale-spinner');
    if (buttonElement) buttonElement.disabled = true;
    if (upscaleIcon) upscaleIcon.classList.add('hidden');
    if (upscaleSpinner) upscaleSpinner.classList.remove('hidden');

    try {
        const originalBase64 = await toBase64(currentFileObject);
        const { width: originalWidth, height: originalHeight } = currentImageDimensions;

        // নিশ্চিত করুন যে width এবং height সঠিক সংখ্যা
        if (!originalWidth || !originalHeight) {
            throw new Error("Could not determine original image dimensions.");
        }

        const response = await fetch('/api/proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api: "clipdrop-upscale",
                base64Data: originalBase64,
                factor: factor, // <-- ফ্যাক্টর পাঠানো হচ্ছে
                originalWidth: originalWidth, // <-- মূল প্রস্থ পাঠানো হচ্ছে
                originalHeight: originalHeight // <-- মূল উচ্চতা পাঠানো হচ্ছে
            })
        });

        if (!response.ok) {
            const errorResult = await response.json();
            throw new Error(errorResult.error || `Server error: ${response.status}`);
        }

        const result = await response.json();
        const imageBlob = await (await fetch(`data:image/png;base64,${result.imageBase64}`)).blob();
        
        const newFileName = `Upscaled-AI-${factor}x-${currentUploadedFileName || 'image.jpg'}`;
        const newFile = new File([imageBlob], newFileName, { type: imageBlob.type });
        
        await updateImageStateAfterEdit(newFile, URL.createObjectURL(newFile));
        window.showToast(`Image successfully upscaled by ${factor}x! Preview updated.`, 'success');

    } catch (error) {
        console.error('AI Upscale API Error:', error);
        window.showToast(`AI Upscaling failed: ${error.message}`, 'error');
    } finally {
        if (buttonElement) {
            buttonElement.disabled = false;
            if (upscaleIcon) upscaleIcon.classList.remove('hidden');
            if (upscaleSpinner) upscaleSpinner.classList.add('hidden');
        }
    }
};
 
        const handleNormalUpscale = (factor, buttonElement) => {
            if (!window.isOpenCvReady || !originalImageSrcForEnhance) return;
            if(normalUpscaleDropdown) normalUpscaleDropdown.classList.add('hidden');
            window.showToast(`Upscaling ${factor}x using normal algorithm...`, 'info');
            const upscaleIcon = buttonElement?.querySelector('.upscale-icon');
            const upscaleSpinner = buttonElement?.querySelector('.upscale-spinner');
            if (buttonElement) buttonElement.disabled = true;
            if (upscaleIcon) upscaleIcon.classList.add('hidden');
            if (upscaleSpinner) upscaleSpinner.classList.remove('hidden');
            setTimeout(async () => {
                let img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = async () => {
                    let src = null, dst = new cv.Mat();
                    try {
                        src = cv.imread(img);
                        if (src.empty()) throw new Error('Failed to read image for normal upscale.');
                        let dsize = new cv.Size(src.cols * factor, src.rows * factor);
                        cv.resize(src, dst, dsize, 0, 0, cv.INTER_CUBIC);
                        cv.imshow(enhancedImagePreviewCanvas, dst);
                        const upscaledDataUrl = enhancedImagePreviewCanvas.toDataURL('image/png');
                        const blob = await (await fetch(upscaledDataUrl)).blob();
                        const newFileName = `Upscaled-Normal-${factor}x-${currentUploadedFileName || 'image.png'}`;
                        const newFile = new File([blob], newFileName, { type: blob.type });
                        currentFileObject = newFile;
                        currentUploadedFileName = newFile.name;
                        const objectURL = upscaledDataUrl;
                        if (imagePreview) imagePreview.src = objectURL;
                        const newImg = new Image();
                        newImg.onload = () => {
                            currentImageDimensions = { width: newImg.naturalWidth, height: newImg.naturalHeight };
                            displayImageTechProperties();
                        };
                        newImg.src = objectURL;
                        originalImageSrcForEnhance = objectURL;
                        enhancedImageSrcForEnhance = objectURL;
                        if (beforeImageSlider) beforeImageSlider.src = originalImageSrcForEnhance;
                        if (afterImageSlider) afterImageSlider.src = originalImageSrcForEnhance;
                        if(resetSlidersBtn) resetSlidersBtn.click();
                        if (enhanceSuggestions) {
                             enhancementSuggestionsData = null;
                             enhanceSuggestions.innerHTML = `<p class="text-gray-500">Image modified. Click "Re-check Image" for new suggestions.</p>`;
                        }
                        imageBase64 = await toBase64(newFile);
                        currentRecentFileCacheKey = await addFileToRecents(newFile, currentRecentFileCacheKey);
                        window.showToast(`Normal upscale ${factor}x complete! Preview updated.`, 'success');
                    } catch (e) {
                        console.error("OpenCV Error during normal upscale:", e);
                        window.showToast('Failed to perform normal upscale.', 'error');
                    } finally {
                        if (src) src.delete();
                        if (dst) dst.delete();
                        if (buttonElement) {
                            buttonElement.disabled = false;
                            if (upscaleIcon) upscaleIcon.classList.remove('hidden');
                            if (upscaleSpinner) upscaleSpinner.classList.add('hidden');
                        }
                    }
                };
                img.src = enhancedImageSrcForEnhance || originalImageSrcForEnhance;
            }, 50);
        };
        
        // ****** START: NEW HELPER FUNCTION FOR RESIZING ******
        /**
         * Resizes an image if it's larger than the max dimension, maintaining aspect ratio.
         * @param {string} imageUrl The source URL of the image to resize.
         * @param {number} maxDimension The maximum allowed width or height.
         * @returns {Promise<Blob>} A promise that resolves with the (possibly resized) image blob.
         */
        const resizeImageForApi = (imageUrl, maxDimension) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const { naturalWidth: width, naturalHeight: height } = img;

                    if (width <= maxDimension && height <= maxDimension) {
                        // Image is within limits, no resize needed. Just convert to blob.
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob(resolve, 'image/jpeg', 0.95);
                        return;
                    }
                    
                    // Image needs resizing
                    window.showToast(`Image is large, resizing for Reimagine...`, 'info');
                    const ratio = Math.min(maxDimension / width, maxDimension / height);
                    const newWidth = Math.round(width * ratio);
                    const newHeight = Math.round(height * ratio);

                    const canvas = document.createElement('canvas');
                    canvas.width = newWidth;
                    canvas.height = newHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    canvas.toBlob(resolve, 'image/jpeg', 0.95);
                };
                img.onerror = (err) => {
                    console.error("Failed to load image for resizing.", err);
                    reject(new Error("Failed to load image for resizing."));
                };
                img.src = imageUrl;
            });
        };
        // ****** END: NEW HELPER FUNCTION FOR RESIZING ******

       const handleReimagine = async () => {
    if (!currentFileObject) { window.showToast('Please upload an image first.', 'error'); return; }

    reimagineBtn.disabled = true;
    reimagineBtn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Reimagining...`;
    
    try {
        const sourceImageUrl = enhancedImageSrcForEnhance || originalImageSrcForEnhance;
        const imageBlobForApi = await resizeImageForApi(sourceImageUrl, 1024);
        const imageBase64 = await toBase64(imageBlobForApi);

        // --- মূল সমাধান: Vercel প্রক্সিকে কল করা হচ্ছে ---
        const response = await fetch('/api/proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                api: "clipdrop-reimagine", // <-- সঠিক API নাম
                imageBase64: imageBase64
            })
        });

        if (!response.ok) {
            const errorResult = await response.json();
            throw new Error(errorResult.error || `Server error: ${response.status}`);
        }
        
        const result = await response.json();
        const imageBlob = await (await fetch(`data:image/png;base64,${result.imageBase64}`)).blob();
        const newFileName = `Reimagined-${currentUploadedFileName || 'image.jpg'}`;
        const newFile = new File([imageBlob], newFileName, { type: imageBlob.type });
        await updateImageStateAfterEdit(newFile, URL.createObjectURL(newFile));
        window.showToast('Image successfully reimagined!', 'success');
    } catch (error) {
        console.error('Reimagine API Error:', error);
        window.showToast(`Reimagine failed: ${error.message}`, 'error');
    } finally {
        reimagineBtn.disabled = false;
        reimagineBtn.innerHTML = `<i class="ph-bold ph-sparkle"></i> Reimagine`;
    }
};
     
        // ****** END: UPDATED REIMAGINE FUNCTION ******

       
               
        function drawOnMask(e) {
            if (!isDrawing) return;
            maskCtx.lineJoin = 'round';
            maskCtx.lineCap = 'round';
            maskCtx.lineWidth = brushSize;
            maskCtx.strokeStyle = 'white';
            const rect = removalMaskCanvas.getBoundingClientRect();
            const scaleX = removalMaskCanvas.width / rect.width;
            const scaleY = removalMaskCanvas.height / rect.height;
            const currentX = (e.clientX - rect.left) * scaleX;
            const currentY = (e.clientY - rect.top) * scaleY;
            maskCtx.beginPath();
            maskCtx.moveTo(lastX, lastY);
            maskCtx.lineTo(currentX, currentY);
            maskCtx.stroke();
            [lastX, lastY] = [currentX, currentY];
        }
         function setupObjectRemovalModal() {
            if (!originalImageSrcForEnhance) { window.showToast('Load an image first!', 'error'); return; }
            removedObjectBlob = null;
            if (saveRemovedObjectBtn) saveRemovedObjectBtn.disabled = true;
            objectRemovalModal.classList.remove('hidden');
            removalImageObject = new Image();
            removalImageObject.crossOrigin = "Anonymous";
            removalImageObject.onload = () => {
                const container = removalCanvasContainer;
                const imgRatio = removalImageObject.naturalWidth / removalImageObject.naturalHeight;
                const containerRatio = container.clientWidth / container.clientHeight;
                let canvasWidth, canvasHeight;
                if (imgRatio > containerRatio) {
                    canvasWidth = container.clientWidth; canvasHeight = container.clientWidth / imgRatio;
                } else {
                    canvasHeight = container.clientHeight; canvasWidth = container.clientHeight * imgRatio;
                }
                [removalImageCanvas, removalMaskCanvas].forEach(c => {
                    c.width = removalImageObject.naturalWidth;
                    c.height = removalImageObject.naturalHeight;
                    c.style.width = `${canvasWidth}px`;
                    c.style.height = `${canvasHeight}px`;
                });
                removalCtx = removalImageCanvas.getContext('2d');
                maskCtx = removalMaskCanvas.getContext('2d');
                removalCtx.drawImage(removalImageObject, 0, 0);
                maskCtx.clearRect(0, 0, removalMaskCanvas.width, removalMaskCanvas.height);
            };
            removalImageObject.src = enhancedImageSrcForEnhance || originalImageSrcForEnhance;
        }
        
        // ==========================================================
        // ||       START: OBJECT REMOVAL FIX                      ||
        // ==========================================================

        /**
         * Resizes a canvas if its resolution exceeds a maximum pixel count.
         * @param {HTMLCanvasElement} sourceCanvas The canvas to resize.
         * @param {number} maxPixels The maximum allowed number of pixels.
         * @returns {HTMLCanvasElement} A new, resized canvas, or a copy of the original if no resize was needed.
         */
        const resizeCanvasForApi = (sourceCanvas, maxPixels) => {
            const { width, height } = sourceCanvas;
            const currentPixels = width * height;

            if (currentPixels <= maxPixels) {
                // No resize needed, return a direct copy.
                const newCanvas = document.createElement('canvas');
                newCanvas.width = width;
                newCanvas.height = height;
                newCanvas.getContext('2d').drawImage(sourceCanvas, 0, 0);
                return newCanvas;
            }

            console.log(`Resizing canvas from ${width}x${height} to fit under ${maxPixels / 1_000_000}MP...`);
            window.showToast?.('Image is too large, resizing for removal...', 'info');

            const ratio = Math.sqrt(maxPixels / currentPixels);
            const newWidth = Math.floor(width * ratio);
            const newHeight = Math.floor(height * ratio);

            const resizedCanvas = document.createElement('canvas');
            resizedCanvas.width = newWidth;
            resizedCanvas.height = newHeight;
            const ctx = resizedCanvas.getContext('2d');
            ctx.drawImage(sourceCanvas, 0, 0, newWidth, newHeight);
            
            return resizedCanvas;
        };

        async function handleObjectRemoval() {
            const maskData = maskCtx.getImageData(0, 0, removalMaskCanvas.width, removalMaskCanvas.height);
            if (![...maskData.data].some(c => c !== 0)) { 
                window.showToast?.('Please paint a mask over the object to remove.', 'info'); 
                return; 
            }
            
            if (removalLoadingOverlay) removalLoadingOverlay.classList.remove('hidden');
            
            try {
                // *** START OF FIX ***
                const MAX_PIXELS_CLIPDROP = 16 * 1000 * 1000;

                // Resize the image and mask canvases if they are too large
                const resizedImageCanvas = resizeCanvasForApi(removalImageCanvas, MAX_PIXELS_CLIPDROP);
                const resizedMaskCanvas = resizeCanvasForApi(removalMaskCanvas, MAX_PIXELS_CLIPDROP);
                
                // Get base64 data from the (potentially resized) canvases
                const imageBase64 = resizedImageCanvas.toDataURL('image/jpeg').split(',')[1];
                const maskBase64 = resizedMaskCanvas.toDataURL('image/png').split(',')[1];
                // *** END OF FIX ***

                // Vercel proxy call remains the same
                const response = await fetch('/api/proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api: "clipdrop-cleanup",
                        imageBase64: imageBase64,
                        maskBase64: maskBase64
                    })
                });

                if (!response.ok) {
                    const errorResult = await response.json();
                    throw new Error(errorResult.error || `Server error: ${response.status}`);
                }
                
                const result = await response.json();
                const resultingImageBlob = await (await fetch(`data:image/png;base64,${result.imageBase64}`)).blob();
                removedObjectBlob = resultingImageBlob;
                
                if (saveRemovedObjectBtn) saveRemovedObjectBtn.disabled = false;
                const newSrc = URL.createObjectURL(resultingImageBlob);
                
                // We create a new image object to load the result
                const resultImage = new Image();
                resultImage.onload = () => {
                    // Update the original high-res canvas with the new image content
                    removalImageCanvas.width = resultImage.width;
                    removalImageCanvas.height = resultImage.height;
                    removalCtx.clearRect(0, 0, removalImageCanvas.width, removalImageCanvas.height);
                    removalCtx.drawImage(resultImage, 0, 0);

                    // Also update the object used for redrawing the modal
                    removalImageObject.src = newSrc;
                };
                resultImage.src = newSrc;
                
                if (clearMaskBtn) clearMaskBtn.click();
                window.showToast?.('Object removed! Click Save & Close to apply.', 'success');

            } catch (error) {
                console.error('Object Removal Error:', error);
                window.showToast?.(`Object removal failed: ${error.message}`, 'error');
            } finally {
                if (removalLoadingOverlay) removalLoadingOverlay.classList.add('hidden');
            }
        }
        // ==========================================================
        // ||       END: OBJECT REMOVAL FIX                        ||
        // ==========================================================

      
        async function saveAndCloseObjectRemoval() {
            if (!removedObjectBlob) {
                objectRemovalModal.classList.add('hidden');
                return;
            }
            const newFileName = `Inpainted-${currentUploadedFileName || 'image.png'}`;
            const newFile = new File([removedObjectBlob], newFileName, { type: removedObjectBlob.type });
            const objectURL = URL.createObjectURL(newFile);
            await updateImageStateAfterEdit(newFile, objectURL);
            objectRemovalModal.classList.add('hidden');
            window.showToast('Image updated with removed object.', 'success');
        }
        function setupCropModal() {
            if (!enhancedImageSrcForEnhance) {
                window.showToast('Load an image first!', 'error');
                return;
            }
            cropImage.src = enhancedImageSrcForEnhance;
            cropModal.classList.remove('hidden');
            setTimeout(() => {
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(cropImage, {
                    viewMode: 1,
                    dragMode: 'move',
                    autoCropArea: 0.8,
                    restore: false,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            }, 200);
        }
        async function handleApplyCrop() {
            if (!cropper) return;
            const croppedCanvas = cropper.getCroppedCanvas();
            if (!croppedCanvas) {
                window.showToast('Could not get cropped image data.', 'error');
                return;
            }
            const dataUrl = croppedCanvas.toDataURL('image/png');
            const blob = await (await fetch(dataUrl)).blob();
            const newFileName = `Cropped-${currentUploadedFileName || 'image.png'}`;
            const newFile = new File([blob], newFileName, { type: blob.type });
            await updateImageStateAfterEdit(newFile, dataUrl);
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            cropModal.classList.add('hidden');
            window.showToast('Image cropped successfully!', 'success');
        }
        async function updateImageStateAfterEdit(newFile, objectURL) {
            currentFileObject = newFile;
            currentUploadedFileName = newFile.name;
            if (imagePreview) {
                imagePreview.src = objectURL;
            }
            const img = new Image();
            img.onload = () => {
                currentImageDimensions = { width: img.naturalWidth, height: img.naturalHeight };
                displayImageTechProperties();
            };
            img.src = objectURL;
            originalImageSrcForEnhance = objectURL;
            enhancedImageSrcForEnhance = objectURL; 
            if (beforeImageSlider) beforeImageSlider.src = originalImageSrcForEnhance;
            if (afterImageSlider) afterImageSlider.src = originalImageSrcForEnhance;
            if (resetSlidersBtn) resetSlidersBtn.click();
            if (imageCompareSlider) {
                imageCompareSlider.value = 50;
                imageCompareSlider.dispatchEvent(new Event('input'));
            }
            if (enhanceSuggestions) {
                enhancementSuggestionsData = null;
                enhanceSuggestions.innerHTML = `<p class="text-gray-500">Image modified. Click "Re-check Image" for new suggestions.</p>`;
            }
            try {
                imageBase64 = await toBase64(newFile);
            } catch (error) {
                console.error("File to Base64 conversion error after edit:", error);
                window.showToast('Failed to process the new image data.', 'error');
                return;
            }
            currentRecentFileCacheKey = await addFileToRecents(newFile, currentRecentFileCacheKey);
        }

        const setupBatchModal = () => {
           batchQueue = [];
           batchResults = [];
           batchMetadataResults = []; // <-- এই লাইনটি যোগ করুন
           hideBatchPreview();
           updateBatchQueueUI();
           if(batchProgress) batchProgress.textContent = '';
           if(downloadBatchZipBtn) downloadBatchZipBtn.disabled = true;
           if(downloadMetadataCsvBtn) downloadMetadataCsvBtn.disabled = true; // <-- এই লাইনটি যোগ করুন
           if(startBatchProcessBtn) startBatchProcessBtn.disabled = true;
           batchModal.classList.remove('hidden');
         };

        const handleBatchFileSelect = (files) => {
            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    batchQueue.push(file);
                }
            }
            updateBatchQueueUI();
        };

        const hideBatchPreview = () => {
            if (batchPreviewContainer) batchPreviewContainer.classList.add('hidden');
            if (batchUploadBox) batchUploadBox.classList.remove('hidden');
            currentBatchPreviewIndex = null;
        };

        const showBatchPreview = async (index) => {
            if (index < 0 || index >= batchQueue.length) {
                hideBatchPreview();
                return;
            }
            currentBatchPreviewIndex = index;
            const file = batchQueue[index];
            const objectURL = URL.createObjectURL(file);
            batchBeforeImageSlider.src = objectURL;
            
            const settings = getBatchSettings();
            const adjustedDataUrl = await getBatchAdjustedDataURL(file, settings);
            batchAfterImageSlider.src = adjustedDataUrl;
            
            batchImageCompareSlider.value = 50;
            const event = new Event('input', { bubbles: true });
            batchImageCompareSlider.dispatchEvent(event);

            batchUploadBox.classList.add('hidden');
            batchPreviewContainer.classList.remove('hidden');
        };
        
        const updateBatchQueueUI = () => {
            if(batchQueueCount) batchQueueCount.textContent = batchQueue.length;
            if(startBatchProcessBtn) startBatchProcessBtn.disabled = batchQueue.length === 0;

            if(batchQueue.length === 0) {
                batchQueueList.innerHTML = `<p class="text-center text-gray-500 pt-8">Upload images to start.</p>`;
                hideBatchPreview();
                return;
            }

            batchQueueList.innerHTML = '';
            batchQueue.forEach((file, index) => {
                const objectURL = URL.createObjectURL(file);
                batchQueueList.innerHTML += `
                    <div class="batch-queue-item relative flex items-center gap-3 p-2 bg-gray-800/50 rounded-lg cursor-pointer hover:bg-gray-700/50" data-index="${index}">
                        <img src="${objectURL}" alt="${file.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0">
                        <div class="flex-grow overflow-hidden">
                            <p class="text-sm text-white truncate font-medium">${file.name}</p>
                            <p class="text-xs text-gray-400">${formatBytes(file.size)}</p>
                        </div>
                        <button class="batch-remove-item-btn absolute top-1 right-1 bg-red-600/80 text-white rounded-full p-0.5 leading-none hover:bg-red-500 z-10" data-index="${index}" title="Remove">
                            <i class="ph ph-x text-sm pointer-events-none"></i>
                        </button>
                    </div>
                `;
            });
        };

             const getBatchSettings = () => {
             const settings = {};
                   batchSliders.forEach(slider => {
             const key = slider.id.replace('batch-slider-', '');
                   settings[key] = parseFloat(slider.value) || 0;
            });
                  settings.upscale = batchUpscaleSelect.value;
                 settings.generateMetadata = batchGenerateMetadata.checked;
    
            // START: নতুন ওয়াটারমার্ক সেটিংস
               settings.addWatermark = batchAddWatermark.checked;
               settings.watermarkType = document.querySelector('input[name="batchWatermarkType"]:checked').value;
               settings.watermarkText = batchWatermarkText.value.trim();
               settings.watermarkImageFile = watermarkFile; // আপলোড করা ফাইল
               settings.watermarkSize = parseFloat(batchWatermarkSize.value) / 100; // শতাংশকে দশমিকে রূপান্তর
               settings.watermarkOpacity = parseFloat(batchWatermarkOpacity.value);
               settings.watermarkPosition = batchWatermarkPosition.value;
             // END: নতুন ওয়াটারমার্ক সেটিংস

             return settings;
           };

        async function getBatchAdjustedDataURL(file, settings) {
            if (!isOpenCvReady) {
                showToast('OpenCV not ready for preview.', 'error');
                return URL.createObjectURL(file);
            }
            return new Promise((resolve, reject) => {
                const objectURL = URL.createObjectURL(file);
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    let src, dst;
                    try {
                        src = cv.imread(img);
                        dst = src.clone();
                        if (settings.brightness !== 0 || settings.contrast !== 0) {
                            cv.convertScaleAbs(dst, dst, 1.0 + settings.contrast / 100.0, settings.brightness);
                        }
                        if (settings.saturation !== 0) {
                            let hsv = new cv.Mat();
                            cv.cvtColor(dst, hsv, cv.COLOR_RGB2HSV);
                            let hsv_planes = new cv.MatVector();
                            cv.split(hsv, hsv_planes);
                            let s = hsv_planes.get(1);
                            let sat_alpha = 1.0 + settings.saturation / 100.0;
                            for (let i = 0; i < s.rows; i++) {
                                for (let j = 0; j < s.cols; j++) {
                                    s.ucharPtr(i, j)[0] = Math.max(0, Math.min(255, s.ucharPtr(i, j)[0] * sat_alpha));
                                }
                            }
                            cv.merge(hsv_planes, hsv);
                            cv.cvtColor(hsv, dst, cv.COLOR_HSV2RGB);
                            hsv.delete(); hsv_planes.delete(); s.delete();
                        }
                        if (settings.blur > 0) {
                            let blurred = new cv.Mat();
                            cv.GaussianBlur(dst, blurred, new cv.Size(0, 0), 3);
                            cv.addWeighted(dst, 1.0 + settings.blur / 100.0, blurred, -settings.blur / 100.0, 0, dst);
                            blurred.delete();
                        }
                        const canvas = document.createElement('canvas');
                        cv.imshow(canvas, dst);
                        resolve(canvas.toDataURL('image/jpeg', 0.95));
                    } catch (e) {
                        reject(e);
                    } finally {
                         if (src) src.delete();
                         if (dst) dst.delete();
                         URL.revokeObjectURL(objectURL);
                    }
                };
                img.onerror = reject;
                img.src = objectURL;
            });
        }
        
        const handleBatchProcess = async () => {
    if (batchQueue.length === 0) {
        showToast("Please add images to the queue first.", 'info');
        return;
    }
    
    const settings = getBatchSettings();
     
          logUserAction('batch_process_started', {
                image_count: batchQueue.length,
                settings: settings // এটি দিয়ে আপনি জানতে পারবেন ব্যবহারকারী কোন সেটিং ব্যবহার করেছে
            });

    const checks = {
        'normal_2x': { condition: !isOpenCvReady, message: 'OpenCV is not ready for Normal Upscale.' },
        'normal_4x': { condition: !isOpenCvReady, message: 'OpenCV is not ready for Normal Upscale.' },
        'ai_2x': { condition: !clipDropApiKey, message: 'ClipDrop API key is required for AI Upscale.' }
    };

    if (checks[settings.upscale] && checks[settings.upscale].condition) {
        showToast(checks[settings.upscale].message, 'error');
        return;
    }
   

    startBatchProcessBtn.disabled = true;
    downloadBatchZipBtn.disabled = true;
    if(downloadMetadataCsvBtn) downloadMetadataCsvBtn.disabled = true;
    batchProgress.textContent = "Starting...";
    batchResults = [];
    batchMetadataResults = [];

    for (let i = 0; i < batchQueue.length; i++) {
        const file = batchQueue[i];
        batchProgress.textContent = `Processing ${i + 1}/${batchQueue.length}: ${file.name}`;
        try {
            // ১. মেটাডেটা জেনারেট (যদি সিলেক্ট করা থাকে)
            if (settings.generateMetadata) {
                try {
                    batchProgress.textContent = `Generating metadata for ${file.name}...`;
                    const imageBase64Data = await toBase64(file);
                    const promptText = `Analyze the image and generate SEO-friendly metadata. Provide ONLY a valid JSON object with the keys: 'fileName', 'title', 'keywords' (as an array of max 15 strings), and 'description' (a short, compelling sentence). Example: {"fileName": "red-rose.jpg", "title": "Vibrant Red Rose in Full Bloom", "keywords": ["red rose", "flower", "macro", "nature", "romance"], "description": "A stunning macro shot of a vibrant red rose, capturing the delicate texture of its petals."}`;
                    const meta = await callGeminiAPI(promptText, imageBase64Data, true);
                    batchMetadataResults.push({
                        fileName: file.name,
                        title: meta.title || '',
                        keywords: (meta.keywords || []).join(', '),
                        description: meta.description || ''
                    });
                } catch (metaError) {
                    console.error(`Metadata generation failed for ${file.name}:`, metaError);
                    showToast(`Metadata failed for ${file.name}.`, 'error');
                    // একটি খালি এন্ট্রি যোগ করুন যাতে CSV-তে ফাইলের নাম থাকে
                    batchMetadataResults.push({ fileName: file.name, title: 'ERROR', keywords: '', description: '' });
                }
            }

            // ২. ছবি প্রসেস (Adjustments & Upscale)
            batchProgress.textContent = `Applying adjustments to ${file.name}...`;
            let processedBlob = await applyBatchAdjustmentsToBlob(file, settings);

            if (settings.upscale.startsWith('normal_')) {
                processedBlob = await applyBatchNormalUpscale(processedBlob, settings.upscale === 'normal_4x' ? 4 : 2);
            } else if (settings.upscale.startsWith('ai_')) {
                processedBlob = await applyBatchAIUpscale(processedBlob, settings.upscale === 'ai_4x' ? 4 : 2);
            }

            // ৩. ওয়াটারমার্ক যোগ (যদি সিলেক্ট করা থাকে)
            if (settings.addWatermark && ( (settings.watermarkType === 'text' && settings.watermarkText) || (settings.watermarkType === 'image' && settings.watermarkImageFile) )) {
            batchProgress.textContent = `Adding watermark to ${file.name}...`;
            processedBlob = await applyWatermarkToBlob(processedBlob, settings);
         }
            
            batchResults.push({ name: `processed_${file.name}`, blob: processedBlob });

        } catch (error) {
            console.error(`Failed to process ${file.name}:`, error);
            showToast(`Skipped ${file.name} due to an error.`, 'error');
        }
    }

    batchProgress.textContent = `Processing Complete! ${batchResults.length} images processed.`;
    downloadBatchZipBtn.disabled = batchResults.length === 0;
    if(downloadMetadataCsvBtn) downloadMetadataCsvBtn.disabled = batchMetadataResults.length === 0;
    startBatchProcessBtn.disabled = false;
};
        async function applyBatchAdjustmentsToBlob(file, settings) {
            return new Promise(async (resolve, reject) => {
                try {
                    const dataUrl = await getBatchAdjustedDataURL(file, settings);
                    const blob = await (await fetch(dataUrl)).blob();
                    resolve(blob);
                } catch(e) {
                    reject(e);
                }
            });
        }

        async function applyBatchNormalUpscale(blob, factor) {
             return new Promise((resolve, reject) => {
                const objectURL = URL.createObjectURL(blob);
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    let src, dst;
                    try {
                        src = cv.imread(img);
                        dst = new cv.Mat();
                        let dsize = new cv.Size(src.cols * factor, src.rows * factor);
                        cv.resize(src, dst, dsize, 0, 0, cv.INTER_CUBIC);
                        const canvas = document.createElement('canvas');
                        cv.imshow(canvas, dst);
                        canvas.toBlob(resolve, 'image/png');
                    } catch(e) {
                        reject(e);
                    } finally {
                        if (src) src.delete();
                        if (dst) dst.delete();
                        URL.revokeObjectURL(objectURL);
                    }
                };
                img.onerror = reject;
                img.src = objectURL;
             });
        }

        async function applyBatchAIUpscale(blob, factor) {
    const base64Data = await toBase64(new File([blob], "temp.jpg"));
    
    const response = await fetch('/api/proxy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            api: "clipdrop-upscale",
            base64Data: base64Data
        })
    });

    if (response.ok) {
        const result = await response.json();
        return await (await fetch(`data:image/png;base64,${result.imageBase64}`)).blob();
    } else {
        const errorResult = await response.json();
        throw new Error(errorResult.error || `Batch AI Upscale failed: ${response.status}`);
    }
}
        
        const downloadBatchZip = async () => {
            if (batchResults.length === 0) return;
            showToast('Preparing ZIP file for download...', 'info');

            const zip = new JSZip();
            batchResults.forEach(result => {
                zip.file(result.name, result.blob);
            });

            const content = await zip.generateAsync({type:"blob"});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `PixelPerfect_Batch_${Date.now()}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);

            showToast('ZIP download started!', 'success');
        };

        const setupDownloadModal = () => {
            const downloadModal = document.getElementById('downloadModal');
            if (!downloadModal) return;
            const closeBtn = document.getElementById('closeDownloadModalBtn');
            const jpgBtn = document.getElementById('downloadJpgBtn');
            const pngBtn = document.getElementById('downloadPngBtn');
            const jpgQualitySlider = document.getElementById('jpgQualitySlider');
            const jpgQualityValue = document.getElementById('jpgQualityValue');
            if (!closeBtn || !jpgBtn || !pngBtn || !jpgQualitySlider || !jpgQualityValue) return;

            window.openDownloadModal = () => downloadModal.classList.remove('hidden');

            closeBtn.addEventListener('click', () => {
                downloadModal.classList.add('hidden');
                // cleanup any temp context URLs
                if (window.downloadContext?.src) { URL.revokeObjectURL(window.downloadContext.src); }
                window.downloadContext = null;
                fileToDownloadFromRecents = null; 
            });
            downloadModal.addEventListener('click', (e) => { 
                if (e.target === downloadModal) {
                    downloadModal.classList.add('hidden');
                    if (window.downloadContext?.src) { URL.revokeObjectURL(window.downloadContext.src); }
                    window.downloadContext = null;
                    fileToDownloadFromRecents = null; 
                }
            });

            jpgQualitySlider.addEventListener('input', () => { jpgQualityValue.textContent = `${jpgQualitySlider.value}%`; });

            const triggerDownload = (format) => {
                const isDownloadingFromRecents = !!fileToDownloadFromRecents;
                const hasCustomContext = !!window.downloadContext;
                const sourceFile = isDownloadingFromRecents ? fileToDownloadFromRecents : currentFileObject;
                const sourceSrc = hasCustomContext
                    ? window.downloadContext.src
                    : (isDownloadingFromRecents ? URL.createObjectURL(sourceFile) : enhancedImageSrcForEnhance);
                
                if (!sourceSrc || (!sourceFile && !hasCustomContext)) {
                    window.showToast('No image data to download.', 'error');
                    return;
                }
                const fileNameBase = hasCustomContext
                    ? (window.downloadContext.nameBase || 'output')
                    : sourceFile.name.replace(/\.[^/.]+$/, "");

                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    const canvas = document.createElement('canvas'); 
                    canvas.width = img.naturalWidth;
                    canvas.height = img.naturalHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);

                    const mimeType = `image/${format === 'jpg' ? 'jpeg' : 'png'}`;
                    const quality = (format === 'jpg') ? parseInt(jpgQualitySlider.value, 10) / 100 : 1.0;
                    
                    canvas.toBlob((blob) => {
                        const newFileName = `${fileNameBase}.${format}`;
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = newFileName;
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        
                        downloadModal.classList.add('hidden');
                        if (window.downloadContext?.src) { URL.revokeObjectURL(window.downloadContext.src); }
                        window.downloadContext = null;
                        fileToDownloadFromRecents = null; 
                        window.showToast(`Image downloaded as ${format.toUpperCase()}.`, 'success');

                    }, mimeType, quality);
                };
                img.src = sourceSrc;
            };

            jpgBtn.addEventListener('click', () => triggerDownload('jpg'));
            pngBtn.addEventListener('click', () => triggerDownload('png'));
        };
        const addFileToRecents = async (file, keyToReplace = null) => {
            try {
                const key = `/recent/${Date.now()}_${file.name}`;
                const cache = await caches.open(CACHE_NAME);
                await cache.put(key, new Response(file));
                let recentFilesMeta = JSON.parse(localStorage.getItem('recentFilesMeta') || '[]');
                if (keyToReplace) {
                    recentFilesMeta = recentFilesMeta.filter(item => item.key !== keyToReplace);
                    await cache.delete(keyToReplace).catch(err => console.warn("Failed to delete old cache key:", err));
                }
                recentFilesMeta.unshift({ key: key, name: file.name });
                if (recentFilesMeta.length > MAX_RECENT_FILES) {
                    const oldest = recentFilesMeta.pop();
                    if(oldest.key !== key) {
                        await cache.delete(oldest.key).catch(err => console.warn("Failed to delete oldest cache key:", err));
                    }
                }
                localStorage.setItem('recentFilesMeta', JSON.stringify(recentFilesMeta));
                await loadRecentFiles();
                return key;
            } catch (error) {
                console.error("Could not add file to cache:", error);
                return keyToReplace;
            }
        };

        const loadRecentFiles = async () => {
            try {
                const recentFilesMeta = JSON.parse(localStorage.getItem('recentFilesMeta') || '[]');
                if (recentFilesMeta.length > 0 && recentFilesContainer && recentFilesGrid) {
                    recentFilesContainer.classList.remove('hidden');
                    recentFilesGrid.innerHTML = '';
                    const cache = await caches.open(CACHE_NAME);
                    for (const meta of recentFilesMeta) {
                        const response = await cache.match(meta.key);
                        if (response) {
                            const blob = await response.blob();
                            const url = URL.createObjectURL(blob);
                            recentFilesGrid.innerHTML += `
                                <div class="relative group recent-file-card cursor-pointer" data-cache-key="${meta.key}" title="${meta.name}">
                                    <img src="${url}" alt="${meta.name}" class="w-full h-20 object-cover rounded-md border-2 border-gray-700 group-hover:border-sky-500 transition-all">
                                    <button class="download-recent-btn absolute bottom-1 right-1 bg-black/60 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-sky-600" data-cache-key="${meta.key}" title="Download">
                                        <i class="ph ph-download-simple text-md pointer-events-none"></i>
                                    </button>
                                    <button class="delete-recent-btn absolute top-1 right-1 bg-black/60 text-white rounded-full p-1.5 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600" data-cache-key="${meta.key}" title="Remove">
                                        <i class="ph ph-x text-md pointer-events-none"></i>
                                    </button>
                                    <p class="text-xs text-gray-400 truncate mt-1">${meta.name}</p>
                                </div>`;
                        }
                    }
                } else if (recentFilesContainer) {
                    recentFilesContainer.classList.add('hidden');
                }
            } catch (error) {
                 console.error("Failed to load recent files:", error);
                 if (recentFilesContainer) recentFilesContainer.classList.add('hidden');
            }
        };

        const deleteRecentFile = async (key) => {
            try {
                let recentFilesMeta = JSON.parse(localStorage.getItem('recentFilesMeta') || '[]');
                recentFilesMeta = recentFilesMeta.filter(item => item.key !== key);
                localStorage.setItem('recentFilesMeta', JSON.stringify(recentFilesMeta));
                const cache = await caches.open(CACHE_NAME);
                await cache.delete(key);
                await loadRecentFiles();
                if(key === currentRecentFileCacheKey) {
                    resetPreview();
                }
                showToast('File removed from recents.', 'info');
            } catch (error) {
                console.error("Failed to delete recent file:", error);
                showToast('Could not remove file.', 'error');
            }
        };

        // --- Super Resolution Modal Logic ---
        const srModal = document.getElementById('superResolutionModal');
        const closeSrModalBtn = document.getElementById('closeSuperResolutionModalBtn');
        const srUploadBox = document.getElementById('srUploadBox');
        const srImageUpload = document.getElementById('srImageUpload');
        const srUploadPreview = document.getElementById('srUploadPreview');
        const srModeEnhance = document.getElementById('srModeEnhance');
        const srModeSuperResolution = document.getElementById('srModeSuperResolution');
        const srScaleContainer = document.getElementById('srScaleContainer');
        const srScale2x = document.getElementById('srScale2x');
        const srScale4x = document.getElementById('srScale4x');
        const srForceFull = document.getElementById('srForceFull');
        const srGenerateBtn = document.getElementById('srGenerateBtn');
        const srDownloadBtn = document.getElementById('srDownloadBtn');
        const srInitialState = document.getElementById('srInitialState');
        const srLoadingState = document.getElementById('srLoadingState');
        const srCompareContainer = document.getElementById('sr-image-compare-container');
        const srBeforeImage = document.getElementById('sr-beforeImageSlider');
        const srAfterImageContainer = document.getElementById('sr-afterImageSliderContainer');
        const srAfterImage = document.getElementById('sr-afterImageSlider');
        const srSliderHandle = document.getElementById('sr-slider-handle');
        const srSlider = document.getElementById('sr-image-compare-slider');

        let srFile = null;
        let srMode = 'enhance'; // 'enhance' or 'super-resolution'
        let srScale = null; // 2 or 4
        let srResultBlob = null;
        
               const setupSuperResolutionModal = () => {
            srFile = currentFileObject;
            srResultBlob = null;
            srMode = 'enhance';
            srScale = null;
            
            // Reset UI
            srInitialState.style.display = 'block';
            srLoadingState.classList.add('hidden');
            srCompareContainer.classList.add('hidden');
            srDownloadBtn.disabled = true;
            srGenerateBtn.disabled = !srFile;

            // Mode buttons
            srModeEnhance.classList.add('bg-purple-700');
            srModeEnhance.classList.remove('bg-gray-700');
            srModeSuperResolution.classList.remove('bg-purple-700');
            srModeSuperResolution.classList.add('bg-gray-700');
            srScaleContainer.style.display = 'none';

            // Scale buttons
            [srScale2x, srScale4x].forEach(btn => {
                btn.classList.remove('bg-purple-700');
                btn.classList.add('bg-gray-700');
            });

            if (srFile) {
                const url = URL.createObjectURL(srFile);
                srUploadPreview.src = url;
                srUploadPreviewContainer.classList.remove('hidden'); // Use container
                srUploadBox.classList.add('hidden');
                srBeforeImage.src = url;
            } else {
                srUploadPreviewContainer.classList.add('hidden'); // Use container
                srUploadBox.classList.remove('hidden');
            }

            srModal.classList.remove('hidden');
        };
        
                const handleSrFileSelect = (file) => {
            if (file && file.type.startsWith('image/')) {
                srFile = file;
                const url = URL.createObjectURL(file);
                srUploadPreview.src = url;
                srUploadPreviewContainer.classList.remove('hidden'); // Use container
                srUploadBox.classList.add('hidden');
                srBeforeImage.src = url;
                srGenerateBtn.disabled = false;
            }
        };

        const callLocalSuperResolution = async () => {
            if (!window.isOpenCvReady) {
                showToast('OpenCV is not ready. Please wait a moment.', 'info');
                return;
            }

            if (!srFile) {
                showToast('Please upload an image first.', 'error');
                return;
            }

            if (srMode === 'super-resolution' && !srScale) {
                showToast('Please select a scale (2X or 4X).', 'info');
                return;
            }

            srLoadingState.classList.remove('hidden');
            srInitialState.style.display = 'none';
            srCompareContainer.classList.add('hidden');
            srGenerateBtn.disabled = true;
            srDownloadBtn.disabled = true;

            try {
                // Load image into a canvas
                const imgUrl = srUploadPreview?.src || URL.createObjectURL(srFile);
                const img = await new Promise((resolve, reject) => {
                    const im = new Image();
                    im.crossOrigin = 'anonymous';
                    im.onload = () => resolve(im);
                    im.onerror = reject;
                    im.src = imgUrl;
                });

                const tmpCanvas = document.createElement('canvas');
                tmpCanvas.width = img.naturalWidth;
                tmpCanvas.height = img.naturalHeight;
                const tmpCtx = tmpCanvas.getContext('2d');
                tmpCtx.drawImage(img, 0, 0);

                // OpenCV processing
                let src = cv.imread(tmpCanvas);
                if (!src || src.empty?.()) {
                    throw new Error('Could not read image. Try a smaller image or different format.');
                }
                // Ensure 3-channel RGB (medianBlur/other ops are more stable on 8UC3)
                if (src.type() === cv.CV_8UC4) {
                    let rgb = new cv.Mat();
                    cv.cvtColor(src, rgb, cv.COLOR_RGBA2RGB);
                    src.delete();
                    src = rgb;
                }

                // Safety limits (only on real mobile unless user forces full output)
                // Use userAgent detection so Desktop DevTools mobile view is not treated as mobile.
                const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                const forceFull = !!srForceFull?.checked;
                const capsEnabled = isMobile && !forceFull;
                const MAX_LONG_SIDE = capsEnabled ? 1536 : 8192; // effectively no cap when disabled
                const MAX_PIXELS = capsEnabled ? 2_500_000 : 64_000_000; // generous when disabled

                let work = new cv.Mat();
                let base = src;

                // If source itself is too large, downscale first (only if caps are enabled)
                const srcLong = Math.max(base.cols, base.rows);
                const srcArea = base.cols * base.rows;
                if (capsEnabled && (srcLong > MAX_LONG_SIDE || srcArea > MAX_PIXELS)) {
                    const scale = Math.min(MAX_LONG_SIDE / srcLong, Math.sqrt(MAX_PIXELS / srcArea));
                    let downsized = new cv.Mat();
                    cv.resize(base, downsized, new cv.Size(0, 0), scale, scale, cv.INTER_AREA);
                    if (base !== src) base.delete();
                    base = downsized; // now smaller
                }

                let wasCapped = false;
                if (srMode === 'super-resolution') {
                    const factor = srScale === 4 ? 4 : 2;
                    // Predict target and cap if needed
                    const targetW0 = base.cols * factor;
                    const targetH0 = base.rows * factor;
                    const targetLong0 = Math.max(targetW0, targetH0);
                    const targetArea0 = targetW0 * targetH0;

                    let effScale = 1.0;
                    if (capsEnabled && (targetLong0 > MAX_LONG_SIDE || targetArea0 > MAX_PIXELS)) {
                        effScale = Math.min(MAX_LONG_SIDE / targetLong0, Math.sqrt(MAX_PIXELS / targetArea0));
                        wasCapped = effScale < 1;
                    }

                    const outW = Math.max(1, Math.round(base.cols * factor * effScale));
                    const outH = Math.max(1, Math.round(base.rows * factor * effScale));
                    cv.resize(base, work, new cv.Size(outW, outH), 0, 0, cv.INTER_CUBIC);
                } else {
                    work = base.clone();
                }
                if (base !== src) base.delete();

                // Unsharp mask: sharpen details
                let blurred = new cv.Mat();
                let sharpened = new cv.Mat();
                const ksize = new cv.Size(0, 0);
                // Use lighter sharpening on mobile to reduce memory/compute pressure
                const sharpenAlpha = isMobile ? 1.2 : 1.5;
                const blurSigma = isMobile ? 0.8 : 0;
                cv.GaussianBlur(work, blurred, new cv.Size(3, 3), blurSigma, blurSigma, cv.BORDER_DEFAULT);
                cv.addWeighted(work, sharpenAlpha, blurred, -(sharpenAlpha - 1), 0, sharpened);

                // Optionally light denoise for upscaled images
                if (srMode === 'super-resolution') {
                    let denoised = new cv.Mat();
                    cv.medianBlur(sharpened, denoised, 3);
                    sharpened.delete();
                    sharpened = denoised;
                }

                // Render to canvas and create Blob (cap canvas size further on mobile)
                const MAX_CANVAS_PIXELS = capsEnabled ? 2_000_000 : 67_000_000;
                let renderMat = sharpened;
                const area = sharpened.cols * sharpened.rows;
                if (capsEnabled && area > MAX_CANVAS_PIXELS) {
                    const scale = Math.sqrt(MAX_CANVAS_PIXELS / area);
                    let resized = new cv.Mat();
                    cv.resize(sharpened, resized, new cv.Size(0, 0), scale, scale, cv.INTER_AREA);
                    renderMat = resized;
                }

                const outCanvas = document.createElement('canvas');
                outCanvas.width = renderMat.cols;
                outCanvas.height = renderMat.rows;
                try {
                    cv.imshow(outCanvas, renderMat);
                } catch (e) {
                    // Fallback: try another scale down if the canvas or WebGL fails
                    const area2 = renderMat.cols * renderMat.rows;
                    const scale2 = Math.min(0.75, Math.sqrt(MAX_CANVAS_PIXELS / (area2 + 1)));
                    if (scale2 < 1.0) {
                        let resized2 = new cv.Mat();
                        cv.resize(renderMat, resized2, new cv.Size(0, 0), scale2, scale2, cv.INTER_AREA);
                        outCanvas.width = resized2.cols;
                        outCanvas.height = resized2.rows;
                        cv.imshow(outCanvas, resized2);
                        resized2.delete();
                    } else {
                        throw e;
                    }
                }
                if (renderMat !== sharpened) renderMat.delete();

                // Use JPEG on mobile to reduce memory usage during encoding
                const mime = capsEnabled ? 'image/jpeg' : 'image/png';
                const quality = isMobile ? 0.92 : 1.0;
                srResultBlob = await new Promise((resolve) => outCanvas.toBlob(resolve, mime, quality));
                const resultUrl = URL.createObjectURL(srResultBlob);
                srAfterImage.src = resultUrl;

                srLoadingState.classList.add('hidden');
                srCompareContainer.classList.remove('hidden');
                srDownloadBtn.disabled = false;
                if (wasCapped) {
                    showToast(`Processing complete (scaled to ${outCanvas.width}x${outCanvas.height} due to device limits).`, 'info');
                } else {
                    showToast('Processing complete!', 'success');
                }

                // Cleanup
                src.delete();
                work.delete();
                blurred.delete();
                sharpened.delete();
            } catch (error) {
                console.error('OpenCV Super Resolution Error:', error);
                const msg = (typeof error === 'object' && error !== null && 'message' in error) ? error.message : `${error}`;
                showToast(`Error: ${msg || 'Failed to process image'}`, 'error');
                srLoadingState.classList.add('hidden');
                srInitialState.style.display = 'block';
            } finally {
                srGenerateBtn.disabled = false;
            }
        };

        // আপলোড রিসেট করার জন্য ফাংশন
        const resetSrUpload = () => {
            srFile = null;
            srResultBlob = null;
            srUploadPreview.src = '';
            if (srUploadPreviewContainer) srUploadPreviewContainer.classList.add('hidden');
            if (srUploadBox) srUploadBox.classList.remove('hidden');
            if (srGenerateBtn) srGenerateBtn.disabled = true;
            if (srDownloadBtn) srDownloadBtn.disabled = true;
            
            // ডান পাশের প্রিভিউ প্যানেল রিসেট করুন
            if (srInitialState) srInitialState.style.display = 'block';
            if (srCompareContainer) srCompareContainer.classList.add('hidden');
            if (srLoadingState) srLoadingState.classList.add('hidden');
            if (srBeforeImage) srBeforeImage.src = '';
            if (srAfterImage) srAfterImage.src = '';
        };
      
             // START: NEW HELPER FUNCTIONS

            async function applyWatermarkToBlob(blob, settings) {
    if (!settings.addWatermark) return blob;

    const mainImage = await new Promise((resolve, reject) => {
        const img = new Image();
        const url = URL.createObjectURL(blob);
        img.crossOrigin = "Anonymous";
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = (err) => { URL.revokeObjectURL(url); reject(err); };
        img.src = url;
    });

    const canvas = document.createElement('canvas');
    canvas.width = mainImage.width;
    canvas.height = mainImage.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(mainImage, 0, 0);

    // অপাসিটি সেট করুন
    ctx.globalAlpha = settings.watermarkOpacity;

    // টেক্সট ওয়াটারমার্ক
    if (settings.watermarkType === 'text' && settings.watermarkText) {
        const fontSize = Math.max(12, mainImage.width * (settings.watermarkSize / 1.5)); // টেক্সটের জন্য সাইজ একটু ভিন্নভাবে গণনা
        const padding = fontSize / 2;
        ctx.font = `bold ${fontSize}px Arial`;
        ctx.fillStyle = `rgba(255, 255, 255, 1)`; // অপাসিটি globalAlpha দিয়ে নিয়ন্ত্রিত
        ctx.shadowColor = "rgba(0, 0, 0, 0.8)";
        ctx.shadowBlur = 7;

        let x, y;
        switch (settings.watermarkPosition) {
            case 'bottom-left':
                ctx.textAlign = 'left'; ctx.textBaseline = 'bottom';
                x = padding; y = canvas.height - padding;
                break;
            case 'top-right':
                ctx.textAlign = 'right'; ctx.textBaseline = 'top';
                x = canvas.width - padding; y = padding;
                break;
            case 'top-left':
                ctx.textAlign = 'left'; ctx.textBaseline = 'top';
                x = padding; y = padding;
                break;
            case 'center':
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                x = canvas.width / 2; y = canvas.height / 2;
                break;
            default: // bottom-right
                ctx.textAlign = 'right'; ctx.textBaseline = 'bottom';
                x = canvas.width - padding; y = canvas.height - padding;
                break;
        }
        ctx.fillText(settings.watermarkText, x, y);
    }
    // ইমেজ ওয়াটারমার্ক
    else if (settings.watermarkType === 'image' && settings.watermarkImageFile) {
        const watermarkImg = await new Promise((resolve, reject) => {
            const img = new Image();
            const url = URL.createObjectURL(settings.watermarkImageFile);
            img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
            img.onerror = (err) => { URL.revokeObjectURL(url); reject(err); };
            img.src = url;
        });

        const wRatio = (mainImage.width * settings.watermarkSize) / watermarkImg.width;
        const hRatio = (mainImage.height * settings.watermarkSize) / watermarkImg.height;
        const ratio = Math.min(wRatio, hRatio);

        const w = watermarkImg.width * ratio;
        const h = watermarkImg.height * ratio;
        const padding = w * 0.1; // প্যাডিং ইমেজের আকারের উপর ভিত্তি করে

        let x, y;
        switch (settings.watermarkPosition) {
            case 'bottom-left': x = padding; y = canvas.height - h - padding; break;
            case 'top-right': x = canvas.width - w - padding; y = padding; break;
            case 'top-left': x = padding; y = padding; break;
            case 'center': x = (canvas.width - w) / 2; y = (canvas.height - h) / 2; break;
            default: // bottom-right
                x = canvas.width - w - padding; y = canvas.height - h - padding; break;
        }
        ctx.drawImage(watermarkImg, x, y, w, h);
    }

    return new Promise(resolve => canvas.toBlob(resolve, blob.type, 0.95));
}     
      
      
const downloadMetadataCsv = () => {
    if (!batchMetadataResults || batchMetadataResults.length === 0) {
        showToast('No metadata to export.', 'error');
        return;
    }

    const escapeCsvCell = (cell) => {
        const strCell = String(cell || '');
        if (strCell.includes(',') || strCell.includes('"') || strCell.includes('\n')) {
            return `"${strCell.replace(/"/g, '""')}"`;
        }
        return strCell;
    };

    const headers = ['File Name', 'Title', 'Keywords', 'Description'];
    const rows = batchMetadataResults.map(meta => 
        [
            escapeCsvCell(meta.fileName),
            escapeCsvCell(meta.title),
            escapeCsvCell(meta.keywords),
            escapeCsvCell(meta.description)
        ].join(',')
    );

    const csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + '\n' + rows.join('\n');
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `metadata_${Date.now()}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    showToast('Metadata exported as CSV.');
};

// END: NEW HELPER FUNCTIONS

    // --- Event Listeners ---
    if (batchBtn) batchBtn.addEventListener('click', setupBatchModal);
    // Ensure safe lookup for manageApiKeysBtn (may not exist in this layout)
    const manageApiKeysBtn = document.getElementById('manageApiKeysBtn');
    if (manageApiKeysBtn) manageApiKeysBtn.addEventListener('click', () => apiKeyModal.classList.remove('hidden'));
        if (closeApiKeyModalBtn) closeApiKeyModalBtn.addEventListener('click', () => apiKeyModal.classList.add('hidden'));
        if (saveApiKeysBtn) saveApiKeysBtn.addEventListener('click', () => { window.showToast?.('Saving keys...', 'info'); saveApiKeys(); });
        if (analyzeBtn) analyzeBtn.addEventListener('click', handleAnalyze);
        if (enhanceBtn) enhanceBtn.addEventListener('click', handleEnhance);
        if (metadataBtn) metadataBtn.addEventListener('click', handleGetMetadata);
        if (promptBtn) promptBtn.addEventListener('click', handleGetPrompt);
        if (superResolutionBtn) superResolutionBtn.addEventListener('click', setupSuperResolutionModal);
        if (localVariationsBtn) localVariationsBtn.addEventListener('click', () => {
            if (!imageBase64) { window.showToast?.('Load an image first.', 'info'); return; }
            if (!window.isOpenCvReady) { window.showToast?.('OpenCV is still loading. Please wait.', 'info'); return; }
            if (lvGrid) lvGrid.innerHTML = '';
            lvResults = [];
            if (lvEmpty) lvEmpty.classList.remove('hidden');
            if (localVariationsModal) localVariationsModal.classList.remove('hidden');
        });
        if (closeLocalVariationsModalBtn) closeLocalVariationsModalBtn.addEventListener('click', () => localVariationsModal.classList.add('hidden'));
      
      // --- নতুন Event Listener (এখানে পেস্ট করুন) ---
if (copyPromptBtn) {
    copyPromptBtn.addEventListener('click', () => {
        // বাটন ক্লিকের সময় এলিমেন্ট এবং তার টেক্সট আবার খুঁজে বের করা হচ্ছে
        const promptElement = document.getElementById('promptContent');
        if (promptElement) {
            const textToCopy = promptElement.textContent.trim();
            const defaultText = "Click the button to generate a prompt.";

            // টেক্সট খালি বা ডিফল্ট টেক্সট কি না তা পরীক্ষা করা হচ্ছে
            if (textToCopy && textToCopy !== defaultText) {
                copyToClipboard(textToCopy, 'Prompt');
            } else {
                if (window.showToast) {
                    window.showToast('There is no prompt to copy.', 'info');
                }
            }
        } else {
            console.error("promptContent element not found on click!");
        }
    });
}

            // START: NEW EVENT LISTENERS
if (downloadMetadataCsvBtn) {
    downloadMetadataCsvBtn.addEventListener('click', downloadMetadataCsv);
}
if (batchAddWatermark) {
    batchAddWatermark.addEventListener('change', () => {
        if (batchAddWatermark.checked) {
            batchWatermarkOptions.classList.remove('hidden');
        } else {
            batchWatermarkOptions.classList.add('hidden');
        }
    });
}
if (batchWatermarkOpacity) {
    batchWatermarkOpacity.addEventListener('input', () => {
        if (batchWatermarkOpacityValue) {
            batchWatermarkOpacityValue.textContent = batchWatermarkOpacity.value;
        }
    });
}
// END: NEW EVENT LISTENERS
      
      // START: NEW WATERMARK EVENT LISTENERS
if (batchAddWatermark) {
    batchAddWatermark.addEventListener('change', () => {
        batchWatermarkOptions.classList.toggle('hidden', !batchAddWatermark.checked);
    });
}
if (batchWatermarkTypeRadios) {
    batchWatermarkTypeRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'text') {
                batchWatermarkTextOptions.classList.remove('hidden');
                batchWatermarkImageOptions.classList.add('hidden');
            } else {
                batchWatermarkTextOptions.classList.add('hidden');
                batchWatermarkImageOptions.classList.remove('hidden');
            }
        });
    });
}
if (batchWatermarkImageBtn) {
    batchWatermarkImageBtn.addEventListener('click', () => batchWatermarkImageUpload.click());
}
if (batchWatermarkImageUpload) {
    batchWatermarkImageUpload.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            watermarkFile = file;
            const reader = new FileReader();
            reader.onload = (event) => {
                batchWatermarkPreview.src = event.target.result;
                batchWatermarkPreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });
}
if (batchWatermarkSize) {
    batchWatermarkSize.addEventListener('input', () => {
        if (batchWatermarkSizeValue) batchWatermarkSizeValue.textContent = batchWatermarkSize.value;
    });
}
// END: NEW WATERMARK EVENT LISTENERS
      
        async function generateLocalVariations() {
            if (!window.isOpenCvReady) { window.showToast?.('OpenCV is not ready.', 'error'); return; }
            if (!imageBase64) { window.showToast?.('Load an image first.', 'error'); return; }

            const count = Math.max(1, Math.min(20, parseInt(lvCountInput?.value || '6', 10)));
            const intensity = parseFloat(lvIntensitySelect?.value || '0.6');
            const seedVal = lvSeedInput?.value ? parseInt(lvSeedInput.value, 10) : null;
            const sizeOpt = lvSizeSelect?.value || '1024';

            // Seeded RNG
            let seed = seedVal ?? Math.floor(Math.random() * 1e9);
            const rng = () => {
                // simple LCG
                seed = (1664525 * seed + 1013904223) % 4294967296;
                return seed / 4294967296;
            };

            // Load source image into canvas
            const srcUrl = imagePreview?.src || originalImageSrcForEnhance;
            const img = await new Promise((resolve, reject) => {
                const im = new Image();
                im.crossOrigin = 'anonymous';
                im.onload = () => resolve(im);
                im.onerror = reject;
                im.src = srcUrl;
            });

            const baseCanvas = document.createElement('canvas');
            baseCanvas.width = img.naturalWidth; baseCanvas.height = img.naturalHeight;
            const bctx = baseCanvas.getContext('2d'); bctx.drawImage(img, 0, 0);

            const srcMat = cv.imread(baseCanvas);

            // Compute output size
            let targetW = srcMat.cols, targetH = srcMat.rows;
            if (sizeOpt !== 'original') {
                const longSide = parseInt(sizeOpt, 10);
                const aspect = srcMat.cols / srcMat.rows;
                if (aspect >= 1) { targetW = longSide; targetH = Math.round(longSide / aspect); }
                else { targetH = longSide; targetW = Math.round(longSide * aspect); }
            }

            lvResults = [];
            if (lvGrid) lvGrid.innerHTML = '';
            if (lvEmpty) lvEmpty.classList.add('hidden');
            if (lvProgress) lvProgress.textContent = 'Generating...';
            lvGenerateBtn && (lvGenerateBtn.disabled = true);
            lvDownloadAllBtn && (lvDownloadAllBtn.disabled = true);

            for (let i = 0; i < count; i++) {
                try {
                    // Start from resized base (no random transform; keep details same)
                    let base = new cv.Mat();
                    cv.resize(srcMat, base, new cv.Size(targetW, targetH), 0, 0, cv.INTER_AREA);
                    // Ensure 3-channel RGB (cv.imread(canvas) gives RGBA). Multiply requires same channels.
                    let baseRGB = new cv.Mat();
                    if (base.type() === cv.CV_8UC4) {
                        cv.cvtColor(base, baseRGB, cv.COLOR_RGBA2RGB);
                        base.delete();
                    } else {
                        // safe copy when already 3-channel
                        base.copyTo(baseRGB);
                        base.delete();
                    }

                    // Build a black vignette mask using a simple radial falloff
                    // Center ~1, edges ~ (1 - edgeDarkness)
                    const edgeDarkness = 0.65 * intensity; // High adds more black, Low adds a bit
                    let mask = cv.Mat.zeros(baseRGB.rows, baseRGB.cols, cv.CV_32FC1);
                    const cx = baseRGB.cols * 0.5, cy = baseRGB.rows * 0.5;
                    const maxR = Math.hypot(cx, cy);
                    for (let y2 = 0; y2 < mask.rows; y2++) {
                        const row = mask.floatPtr(y2);
                        const dy = y2 - cy;
                        for (let x2 = 0; x2 < mask.cols; x2++) {
                            const d = Math.hypot(x2 - cx, dy) / maxR; // 0 center -> 1 corners
                            const v = Math.max(0.0, 1.0 - edgeDarkness * d);
                            row[x2] = v;
                        }
                    }

                    // Apply mask: multiply image by 3-channel mask
                    let base32 = new cv.Mat(); baseRGB.convertTo(base32, cv.CV_32FC3, 1/255);
                    let mask3 = cv.Mat.zeros(mask.rows, mask.cols, cv.CV_32FC3);
                    let ch = new cv.MatVector();
                    ch.push_back(mask); ch.push_back(mask); ch.push_back(mask);
                    cv.merge(ch, mask3);
                    let vApplied = new cv.Mat();
                    cv.multiply(base32, mask3, vApplied);
                    let finalMat = new cv.Mat(); vApplied.convertTo(finalMat, cv.CV_8UC3, 255);
                    // Cleanup temps used before rendering
                    baseRGB.delete(); base32.delete(); mask3.delete(); ch.delete(); vApplied.delete(); mask.delete();

                    // To canvas & blob
                    const canvas = document.createElement('canvas');
                    canvas.width = finalMat.cols; canvas.height = finalMat.rows;
                    cv.imshow(canvas, finalMat);
                    finalMat.delete();

                    const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', 0.95));
                    const url = URL.createObjectURL(blob);
                    lvResults.push({ blob, url, name: `${(currentFileObject?.name || 'image').replace(/\.[^/.]+$/, '')}_var_${i+1}.jpg` });

                    // Render card
                    if (lvGrid) {
                        const card = document.createElement('div');
                        card.className = 'relative group border border-gray-700 rounded-md overflow-hidden';
                        card.innerHTML = `
                            <img src="${url}" class="w-full h-32 object-cover" alt="Variation ${i+1}" />
                            <div class="absolute bottom-1 right-1 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button class="bg-black/60 text-white rounded px-2 py-1 text-xs" data-idx="${i}">Download</button>
                            </div>`;
                        lvGrid.appendChild(card);
                         const dlBtn = card.querySelector('button');
                         dlBtn.addEventListener('click', () => {
                        const a = document.createElement('a');
                        a.href = url; a.download = lvResults[i].name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                        });
                      } // <-- এই বন্ধনীটি যোগ করুন


                   if (lvProgress) lvProgress.textContent = `Generated ${i+1}/${count}`;
                } catch (err) {
                    console.error('Local variation failed:', err);
                }
            }

            srcMat.delete();
            if (lvProgress) lvProgress.textContent = `Done: ${lvResults.length} variations`;
            lvGenerateBtn && (lvGenerateBtn.disabled = false);
            lvDownloadAllBtn && (lvDownloadAllBtn.disabled = lvResults.length === 0);
        }

        if (lvGenerateBtn) lvGenerateBtn.addEventListener('click', generateLocalVariations);
        if (lvDownloadAllBtn) lvDownloadAllBtn.addEventListener('click', () => {
            if (!lvResults.length) return;
            // Trigger individual downloads (no ZIP dependency)
            lvResults.forEach((item, idx) => {
                setTimeout(() => {
                    const a = document.createElement('a'); a.href = item.url; a.download = item.name; document.body.appendChild(a); a.click(); document.body.removeChild(a);
                }, idx * 200);
            });
        });
        if(srRemoveImageBtn) srRemoveImageBtn.addEventListener('click', resetSrUpload);
       
        if (browseBtn) browseBtn.addEventListener('click', () => { if(imageUpload) imageUpload.click(); });
        if (imageUpload) imageUpload.addEventListener('change', (e) => { if (e.target.files?.[0]) handleFileSelect(e.target.files[0]); });
        if (uploadBox) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => { uploadBox.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }); });
            uploadBox.addEventListener('dragenter', () => uploadBox.classList.add('drag-over'));
            uploadBox.addEventListener('dragover', () => uploadBox.classList.add('drag-over'));
            uploadBox.addEventListener('dragleave', (e) => { if (e.target === uploadBox || !uploadBox.contains(e.relatedTarget)) uploadBox.classList.remove('drag-over'); });
            uploadBox.addEventListener('drop', (e) => { uploadBox.classList.remove('drag-over'); if (e.dataTransfer.files?.[0]) handleFileSelect(e.dataTransfer.files[0]); });
        }
        if (imageUrlInput) { imageUrlInput.addEventListener('paste', () => setTimeout(handleImageUrlInput, 0)); imageUrlInput.addEventListener('change', handleImageUrlInput); }
        if (closePreviewBtn) closePreviewBtn.addEventListener('click', resetPreview);
        if (viewLargeBtn) viewLargeBtn.addEventListener('click', () => {
             const src = imagePreview?.src || '';
             if (!src) { window.showToast?.('Please load an image first.', 'info'); return; }
             if (!(enhanceLargeImage && enhanceLargePreviewModal)) return;

             const openModal = () => {
                 enhanceLargePreviewModal.classList.remove('hidden');
                 enhanceLargePreviewModal.dispatchEvent(new Event('modal-open'));
             };
             if (enhanceLargeImage.src === src && enhanceLargeImage.complete && enhanceLargeImage.naturalWidth > 0) {
                 openModal();
                 return;
             }

             const onLoad = () => {
                 enhanceLargeImage.removeEventListener('load', onLoad);
                 enhanceLargeImage.removeEventListener('error', onError);
                 openModal();
             };
             const onError = () => {
                 enhanceLargeImage.removeEventListener('load', onLoad);
                 enhanceLargeImage.removeEventListener('error', onError);
                 window.showToast?.('Could not load image for large preview.', 'error');
             };
             enhanceLargeImage.addEventListener('load', onLoad, { once: true });
             enhanceLargeImage.addEventListener('error', onError, { once: true });
             enhanceLargeImage.src = src;
             setTimeout(() => {
                 if (enhanceLargeImage.complete && enhanceLargeImage.naturalWidth > 0 && enhanceLargePreviewModal.classList.contains('hidden')) {
                     openModal();
                 }
             }, 50);
        });
        
        const enhanceLargePreviewBtn = document.getElementById('enhanceLargePreviewBtn');
        const beforeAfterModal = document.getElementById('beforeAfterLargePreviewModal');
        const largePreviewContainer = document.getElementById('large-preview-container');
        
        if (enhanceLargePreviewBtn && beforeAfterModal) {
            const peekPane = document.getElementById('peek-view-pane');
            const sliderPane = document.getElementById('slider-view-pane');
            const splitPane = document.getElementById('split-view-pane');
            const allPanes = [peekPane, sliderPane, splitPane];

            const peekBtn = document.getElementById('peek-view-btn');
            const sliderBtn = document.getElementById('slider-view-btn');
            const splitBtn = document.getElementById('split-view-btn');
            const allViewBtns = [peekBtn, sliderBtn, splitBtn];

            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const resetViewBtn = document.getElementById('reset-view-btn');
            const zoomLevelDisplay = document.getElementById('zoom-level-display');
            const closeBtn = document.getElementById('close-large-preview');
            
            const allImages = beforeAfterModal.querySelectorAll('img');
            const sliderHandle = document.getElementById('large-preview-slider-handle');
            const sliderAfterContainer = document.getElementById('slider-after-container');

            let zoom = 1, panX = 0, panY = 0;
            let isPanning = false, isSliding = false;
            let startPan = { x: 0, y: 0 };

            const updateZoomDisplay = () => {
                zoomLevelDisplay.textContent = `${Math.round(zoom * 100)}%`;
            };

            const applyTransform = () => {
                const transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
                allImages.forEach(img => { img.style.transform = transform; });
            };

            const resetView = () => {
                zoom = 1; panX = 0; panY = 0;
                applyTransform();
                updateZoomDisplay();
                const pct = 50;
                sliderHandle.style.left = `${pct}%`;
                sliderAfterContainer.style.clipPath = `polygon(0 0, ${pct}% 0, ${pct}% 100%, 0 100%)`;
            };

            const switchView = (viewName) => {
                allPanes.forEach(pane => pane.classList.remove('active'));
                allViewBtns.forEach(btn => btn.classList.remove('active'));

                if (viewName === 'peek') {
                    peekPane.classList.add('active');
                    peekBtn.classList.add('active');
                } else if (viewName === 'slider') {
                    sliderPane.classList.add('active');
                    sliderBtn.classList.add('active');
                } else if (viewName === 'split') {
                    splitPane.classList.add('active');
                    splitBtn.classList.add('active');
                }
                resetView();
            };
            
            enhanceLargePreviewBtn.addEventListener('click', () => {
                const beforeSrc = originalImageSrcForEnhance;
                const afterSrc = enhancedImageSrcForEnhance;

                if (!beforeSrc) {
                    window.showToast?.('Please load an image first.', 'error');
                    return;
                }

                document.getElementById('peek-image').src = afterSrc;
                document.getElementById('slider-before-image').src = beforeSrc;
                document.getElementById('slider-after-image').src = afterSrc;
                document.getElementById('split-before-image').src = beforeSrc;
                document.getElementById('split-after-image').src = afterSrc;

                switchView('peek');
                beforeAfterModal.classList.remove('hidden');
            });

            peekBtn.addEventListener('click', () => switchView('peek'));
            sliderBtn.addEventListener('click', () => switchView('slider'));
            splitBtn.addEventListener('click', () => switchView('split'));
            resetViewBtn.addEventListener('click', resetView);
            closeBtn.addEventListener('click', () => beforeAfterModal.classList.add('hidden'));

            zoomInBtn.addEventListener('click', () => {
                zoom = Math.min(8, zoom * 1.25);
                applyTransform();
                updateZoomDisplay();
            });
            zoomOutBtn.addEventListener('click', () => {
                zoom = Math.max(0.1, zoom / 1.25);
                applyTransform();
                updateZoomDisplay();
            });

            largePreviewContainer.addEventListener('wheel', e => {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                const oldZoom = zoom;
                zoom = Math.max(0.1, Math.min(8, zoom + (delta * zoom)));

                const rect = largePreviewContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;

                panX = mouseX - (mouseX - panX) * (zoom / oldZoom);
                panY = mouseY - (mouseY - panY) * (zoom / oldZoom);

                applyTransform();
                updateZoomDisplay();
            });

            largePreviewContainer.addEventListener('mousedown', e => {
                if (e.target === sliderHandle) return;
                e.preventDefault();
                isPanning = true;
                startPan.x = e.clientX - panX;
                startPan.y = e.clientY - panY;
                largePreviewContainer.style.cursor = 'grabbing';
            });
            
            sliderHandle.addEventListener('mousedown', e => {
                e.preventDefault();
                isSliding = true;
            });
            
            window.addEventListener('mousemove', e => {
                if (isPanning) {
                    e.preventDefault();
                    panX = e.clientX - startPan.x;
                    panY = e.clientY - startPan.y;
                    applyTransform();
                }
                if(isSliding) {
                    e.preventDefault();
                    const rect = sliderPane.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    let pct = (x / rect.width) * 100;
                    pct = Math.max(0, Math.min(100, pct));
                    sliderHandle.style.left = `${pct}%`;
                    sliderAfterContainer.style.clipPath = `polygon(0 0, ${pct}% 0, ${pct}% 100%, 0 100%)`;
                }
            });

            window.addEventListener('mouseup', () => {
                isPanning = false;
                isSliding = false;
                largePreviewContainer.style.cursor = 'grab';
            });

            document.addEventListener('keydown', e => {
                if (e.key === 'Escape' && !beforeAfterModal.classList.contains('hidden')) {
                    beforeAfterModal.classList.add('hidden');
                }
            });
        }

       if (recentFilesGrid) {
            recentFilesGrid.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-recent-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    const key = deleteBtn.dataset.cacheKey;
                    if (key) await deleteRecentFile(key);
                    return;
                }

                const downloadBtn = e.target.closest('.download-recent-btn');
                if (downloadBtn) {
                    e.stopPropagation();
                    const key = downloadBtn.dataset.cacheKey;
                    const card = downloadBtn.closest('.recent-file-card');
                    if (!key || !card) return;

                    try {
                        const cache = await caches.open(CACHE_NAME);
                        const response = await cache.match(key);
                        if (response) {
                            const blob = await response.blob();
                            const file = new File([blob], card.title, { type: blob.type });
                            fileToDownloadFromRecents = file;
                            if (window.openDownloadModal) window.openDownloadModal();
                        } else {
                            window.showToast('Could not load file to download.', 'error');
                            await deleteRecentFile(key);
                        }
                    } catch (error) {
                        window.showToast('Error loading file from cache.', 'error');
                        console.error("Error loading from cache for download:", error);
                    }
                    return;
                }

                const card = e.target.closest('.recent-file-card');
                if (card) {
                    const key = card.dataset.cacheKey;
                    if (!key) return;
                    try {
                        const cache = await caches.open(CACHE_NAME);
                        const response = await cache.match(key);
                        if (response) {
                            const blob = await response.blob();
                            const file = new File([blob], card.title, { type: blob.type });
                            await handleFileSelect(file, key);
                        } else {
                            window.showToast('Could not load recent file. It might have been cleared.', 'error');
                            await deleteRecentFile(key);
                        }
                    } catch (error) {
                        window.showToast('Error loading file from cache.', 'error');
                        console.error("Error loading from cache:", error);
                    }
                }
            });
        }
        if(closeMetadataModalBtn) closeMetadataModalBtn.addEventListener('click', () => metadataModal.classList.add('hidden'));
        if(metadataModal) metadataModal.addEventListener('click', e => { if(e.target === metadataModal) metadataModal.classList.add('hidden')});
        if(metadataContent) metadataContent.addEventListener('click', (e) => { const button = e.target.closest('.copy-metadata-btn'); if (button) copyToClipboard(button.dataset.text, button.dataset.type); });
        if(exportMetadataBtn) exportMetadataBtn.addEventListener('click', exportMetadataAsCsv);
        if(closePromptModalBtn) closePromptModalBtn.addEventListener('click', () => promptModal.classList.add('hidden'));
        if(promptModal) promptModal.addEventListener('click', e => { if(e.target === promptModal) promptModal.classList.add('hidden'); });
        if (closeEnhanceModalBtn) closeEnhanceModalBtn.addEventListener('click', () => { if (enhanceModal) enhanceModal.classList.add('hidden'); });
        if (downloadEnhancedBtn) downloadEnhancedBtn.addEventListener('click', () => { 
            fileToDownloadFromRecents = null;
            if (window.openDownloadModal) window.openDownloadModal();
        });
        if (aiUpscale2xBtn) aiUpscale2xBtn.addEventListener('click', () => handleAiUpscale(2, aiUpscaleToggleBtn));
        if (aiUpscale4xBtn) aiUpscale4xBtn.addEventListener('click', () => handleAiUpscale(4, aiUpscaleToggleBtn));
        if (normalUpscale2xBtn) normalUpscale2xBtn.addEventListener('click', () => handleNormalUpscale(2, normalUpscaleToggleBtn));
        if (normalUpscale4xBtn) normalUpscale4xBtn.addEventListener('click', () => handleNormalUpscale(4, normalUpscaleToggleBtn));
        if (recheckImageBtn) recheckImageBtn.addEventListener('click', handleRecheckImage);
        if (objectRemovalBtn) objectRemovalBtn.addEventListener('click', setupObjectRemovalModal);
        if (reimagineBtn) reimagineBtn.addEventListener('click', handleReimagine);
        if (cropBtn) cropBtn.addEventListener('click', setupCropModal);
        const allDropdowns = [normalUpscaleDropdown, aiUpscaleDropdown];
        [normalUpscaleToggleBtn, aiUpscaleToggleBtn].forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = btn.nextElementSibling;
                const isHidden = dropdown.classList.contains('hidden');
                allDropdowns.forEach(d => d.classList.add('hidden'));
                if (isHidden) dropdown.classList.remove('hidden');
            });
        });
        window.addEventListener('click', () => { allDropdowns.forEach(d => d.classList.add('hidden')); });
        if (enhanceSuggestions) {
            enhanceSuggestions.addEventListener('click', (e) => {
                const button = e.target.closest('.suggestion-btn');
                if (button && !button.disabled) {
                    const suggestionIndex = button.dataset.suggestionIndex;
                    if (suggestionIndex !== undefined && enhancementSuggestionsData) {
                        const suggestion = enhancementSuggestionsData[suggestionIndex];
                        if (suggestion && typeof suggestion.adjustment === 'string') {
                            applySuggestion(suggestion);
                            button.disabled = true;
                            const indicator = button.querySelector('.applied-indicator');
                            if (indicator) indicator.innerHTML = '✔';
                            button.classList.add('cursor-not-allowed', 'opacity-70');
                            button.classList.remove('hover:bg-gray-800', 'hover:border-sky-500');
                        } else { if (window.showToast) window.showToast('Cannot apply invalid suggestion.', 'error'); }
                    }
                }
            });
        }
        if (imageCompareSlider) {
            imageCompareSlider.addEventListener('input', (e) => {
                const value = e.target.value;
                if (afterImageSliderContainer) afterImageSliderContainer.style.width = `${value}%`;
                if (sliderHandle) sliderHandle.style.left = `${value}%`;
                if (afterImageSlider && afterImageSliderContainer.parentElement) {
                    const containerWidth = afterImageSliderContainer.parentElement.offsetWidth;
                    afterImageSlider.style.width = `${containerWidth}px`;
                }
            });
        }
        if (viewOriginalBtn) viewOriginalBtn.addEventListener('click', () => { if (imageCompareSlider) { imageCompareSlider.value = 0; imageCompareSlider.dispatchEvent(new Event('input')); } });
        if (viewEnhancedBtn) viewEnhancedBtn.addEventListener('click', () => { if (imageCompareSlider) { imageCompareSlider.value = 100; imageCompareSlider.dispatchEvent(new Event('input')); } });
        if (resetEnhancementsBtn) resetEnhancementsBtn.addEventListener('click', () => {
            if(window.showToast) window.showToast('All enhancements reset.', 'info');
            originalImageSrcForEnhance = imagePreview.src;
            const img = new Image();
            img.onload = () => { currentImageDimensions = { width: img.naturalWidth, height: img.naturalHeight }; };
            img.src = originalImageSrcForEnhance;
            enhancedImageSrcForEnhance = originalImageSrcForEnhance;
            if (afterImageSlider) afterImageSlider.src = originalImageSrcForEnhance;
            if (beforeImageSlider) beforeImageSlider.src = originalImageSrcForEnhance;
            if(resetSlidersBtn) resetSlidersBtn.click();
            if (enhanceSuggestions) {
                const allSuggestionBtns = enhanceSuggestions.querySelectorAll('.suggestion-btn');
                allSuggestionBtns.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('cursor-not-allowed', 'opacity-70');
                    btn.classList.add('hover:bg-gray-800', 'hover:border-sky-500');
                    const indicator = btn.querySelector('.applied-indicator');
                    if (indicator) indicator.innerHTML = '';
                });
            }
        });
        if (copyTagsBtn) copyTagsBtn.addEventListener('click', () => { if(analysisResults?.tags?.length > 0) copyToClipboard(analysisResults.tags.join(', ')); else if (window.showToast) window.showToast('No tags to copy.', 'info'); });
        sliders.forEach(slider => {
            slider.addEventListener('input', (e) => { document.getElementById(`sliderVal-${e.target.id.split('-')[1]}`).textContent = e.target.value; });
            slider.addEventListener('change', applyManualEnhancements);
        });
        if (resetSlidersBtn) {
            resetSlidersBtn.addEventListener('click', () => {
                sliders.forEach(slider => { slider.value = 0; document.getElementById(`sliderVal-${slider.id.split('-')[1]}`).textContent = '0'; });
                applyManualEnhancements(); 
                if(window.showToast) window.showToast('Manual adjustments have been reset.', 'info');
            });
        }
        if (closeCropModalBtn) {
            closeCropModalBtn.addEventListener('click', () => {
                if (cropper) { cropper.destroy(); cropper = null; }
                cropModal.classList.add('hidden');
            });
        }
        if (applyCropBtn) applyCropBtn.addEventListener('click', handleApplyCrop);
        if (cropResetBtn && typeof cropper !== 'undefined') cropResetBtn.addEventListener('click', () => { if(cropper) cropper.reset(); });
        document.querySelectorAll('.crop-ratio-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!cropper) return;
                const ratio = parseFloat(e.target.dataset.ratio);
                cropper.setAspectRatio(ratio);
            });
        });
        document.getElementById('crop-action-zoom-in')?.addEventListener('click', () => { if(cropper) cropper.zoom(0.1); });
        document.getElementById('crop-action-zoom-out')?.addEventListener('click', () => { if(cropper) cropper.zoom(-0.1); });
        document.getElementById('crop-action-rotate-left')?.addEventListener('click', () => { if(cropper) cropper.rotate(-45); });
        document.getElementById('crop-action-rotate-right')?.addEventListener('click', () => { if(cropper) cropper.rotate(45); });
        document.getElementById('crop-action-flip-h')?.addEventListener('click', () => { if(cropper) cropper.scaleX(-cropper.getData().scaleX || -1); });
        document.getElementById('crop-action-flip-v')?.addEventListener('click', () => { if(cropper) cropper.scaleY(-cropper.getData().scaleY || -1); });
        if(closeObjectRemovalModalBtn) closeObjectRemovalModalBtn.addEventListener('click', () => objectRemovalModal.classList.add('hidden'));
        if(removeObjectBtn) removeObjectBtn.addEventListener('click', handleObjectRemoval);
        if(saveRemovedObjectBtn) saveRemovedObjectBtn.addEventListener('click', saveAndCloseObjectRemoval);
        if(clearMaskBtn && removalMaskCanvas) clearMaskBtn.addEventListener('click', () => maskCtx.clearRect(0, 0, removalMaskCanvas.width, removalMaskCanvas.height));
        if(brushSizeSlider) {
            brushSizeSlider.addEventListener('input', (e) => {
                brushSize = e.target.value;
                if(brushSizeValue) brushSizeValue.textContent = brushSize;
            });
        }
        if(removalMaskCanvas) {
            removalMaskCanvas.addEventListener('mousedown', (e) => {
                isDrawing = true;
                const rect = removalMaskCanvas.getBoundingClientRect();
                const scaleX = removalMaskCanvas.width / rect.width;
                const scaleY = removalMaskCanvas.height / rect.height;
                [lastX, lastY] = [(e.clientX - rect.left) * scaleX, (e.clientY - rect.top) * scaleY];
            });
            removalMaskCanvas.addEventListener('mousemove', drawOnMask);
            removalMaskCanvas.addEventListener('mouseup', () => isDrawing = false);
            removalMaskCanvas.addEventListener('mouseout', () => isDrawing = false);
        }
        if (closeBatchModalBtn) closeBatchModalBtn.addEventListener('click', () => batchModal.classList.add('hidden'));
        if (batchBrowseBtn) batchBrowseBtn.addEventListener('click', () => batchImageUpload.click());
        if (batchAddMoreBtn) batchAddMoreBtn.addEventListener('click', () => batchImageUpload.click());
        if (closeBatchPreviewBtn) closeBatchPreviewBtn.addEventListener('click', hideBatchPreview);

        if (batchImageUpload) batchImageUpload.addEventListener('change', (e) => handleBatchFileSelect(e.target.files));
        if (batchUploadBox) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => batchUploadBox.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
            batchUploadBox.addEventListener('dragenter', () => batchUploadBox.classList.add('drag-over'));
            batchUploadBox.addEventListener('dragover', () => batchUploadBox.classList.add('drag-over'));
            batchUploadBox.addEventListener('dragleave', (e) => batchUploadBox.classList.remove('drag-over'));
            batchUploadBox.addEventListener('drop', (e) => {
                batchUploadBox.classList.remove('drag-over');
                handleBatchFileSelect(e.dataTransfer.files);
            });
        }
        if (batchClearQueueBtn) batchClearQueueBtn.addEventListener('click', () => {
            batchQueue = [];
            updateBatchQueueUI();
        });

        if (batchQueueList) {
            batchQueueList.addEventListener('click', e => {
                const removeBtn = e.target.closest('.batch-remove-item-btn');
                if (removeBtn) {
                    e.stopPropagation();
                    const indexToRemove = parseInt(removeBtn.dataset.index, 10);
                    batchQueue.splice(indexToRemove, 1);
                    if (currentBatchPreviewIndex === indexToRemove) {
                        hideBatchPreview();
                    } else if (currentBatchPreviewIndex > indexToRemove) {
                        currentBatchPreviewIndex--;
                    }
                    updateBatchQueueUI();
                    return;
                }
                const queueItem = e.target.closest('.batch-queue-item');
                if (queueItem) {
                    const index = parseInt(queueItem.dataset.index, 10);
                    showBatchPreview(index);
                }
            });
        }

       if (startBatchProcessBtn) startBatchProcessBtn.addEventListener('click', handleBatchProcess);
        if (downloadBatchZipBtn) downloadBatchZipBtn.addEventListener('click', downloadBatchZip);
        
        batchSliders.forEach(slider => {
            // শুধুমাত্র নম্বরটি সাথে সাথে আপডেট করার জন্য 'input' ইভেন্ট ব্যবহার করুন
            slider.addEventListener('input', e => {
                const valEl = document.getElementById(`batchSliderVal-${e.target.id.split('-')[2]}`);
                if (valEl) valEl.textContent = e.target.value;
            });

            // শুধুমাত্র স্লাইডার ড্র্যাগ করা শেষ হলে ছবিটি প্রসেস করার জন্য 'change' ইভেন্ট ব্যবহার করুন
            slider.addEventListener('change', e => {
                if (currentBatchPreviewIndex !== null) {
                    showBatchPreview(currentBatchPreviewIndex);
                }
            });
        });

        if (batchImageCompareSlider) {
             batchImageCompareSlider.addEventListener('input', (e) => {
                const value = e.target.value;
                window.requestAnimationFrame(() => {
                    if (batchAfterImageSliderContainer) batchAfterImageSliderContainer.style.width = `${value}%`;
                    if (batchSliderHandle) batchSliderHandle.style.left = `${value}%`;
                    if (batchAfterImageSlider && batchAfterImageSliderContainer.parentElement) {
                        const containerWidth = batchAfterImageSliderContainer.parentElement.offsetWidth;
                        batchAfterImageSlider.style.width = `${containerWidth}px`;
                    }
                });
            });
        }

        document.querySelectorAll('.batch-preset-btn').forEach(button => {
            button.addEventListener('click', () => {
                try {
                    const settings = JSON.parse(button.dataset.settings);
                    for (const [key, value] of Object.entries(settings)) {
                        const slider = document.getElementById(`batch-slider-${key}`);
                        if (slider) {
                            slider.value = value;
                            slider.dispatchEvent(new Event('input', { bubbles: true }));
                        }
                    }
                } catch (e) {
                    console.error("Could not parse preset settings:", e);
                }
            });
        });

        if (enhanceLargePreviewModal) {
            const zoomContainer = document.getElementById('modal-zoom-container');
            const zoomInBtn = document.getElementById('modal-zoom-in-btn');
            const zoomOutBtn = document.getElementById('modal-zoom-out-btn');
            const zoomResetBtn = document.getElementById('modal-zoom-reset-btn');
            const zoomLevelText = document.getElementById('modal-zoom-level-text');
            let scale = 1, panning = false, pointX = 0, pointY = 0, start = { x: 0, y: 0 };
            const updateZoomText = () => { if(zoomLevelText) zoomLevelText.textContent = `${Math.round(scale * 100)}%`; };
            const applyTransform = () => { if (enhanceLargeImage) enhanceLargeImage.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; };
            const resetZoom = () => { scale = 1; pointX = 0; pointY = 0; applyTransform(); updateZoomText(); };
            if (closeEnhanceLargePreviewBtn) closeEnhanceLargePreviewBtn.addEventListener('click', () => enhanceLargePreviewModal.classList.add('hidden'));
            enhanceLargePreviewModal.addEventListener('click', (e) => { if(e.target === enhanceLargePreviewModal) enhanceLargePreviewModal.classList.add('hidden')});
            enhanceLargePreviewModal.addEventListener('modal-open', resetZoom);
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !enhanceLargePreviewModal.classList.contains('hidden')) {
                    enhanceLargePreviewModal.classList.add('hidden');
                }
            });
            if (zoomInBtn) zoomInBtn.addEventListener('click', () => { scale = Math.min(5, scale + 0.2); applyTransform(); updateZoomText(); });
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => { scale = Math.max(0.2, scale - 0.2); applyTransform(); updateZoomText(); });
            if (zoomResetBtn) zoomResetBtn.addEventListener('click', resetZoom);
            if (zoomContainer) {
                zoomContainer.addEventListener('wheel', (e) => { e.preventDefault(); const delta = e.deltaY > 0 ? -0.1 : 0.1; scale = Math.max(0.2, Math.min(5, scale + delta)); applyTransform(); updateZoomText(); });
                zoomContainer.addEventListener('mousedown', (e) => { e.preventDefault(); panning = true; start = { x: e.clientX - pointX, y: e.clientY - pointY }; if(enhanceLargeImage) { enhanceLargeImage.classList.add('cursor-grabbing'); enhanceLargeImage.classList.remove('cursor-grab'); } });
                zoomContainer.addEventListener('mouseup', () => { panning = false; if(enhanceLargeImage) { enhanceLargeImage.classList.remove('cursor-grabbing'); enhanceLargeImage.classList.add('cursor-grab'); } });
                zoomContainer.addEventListener('mouseleave', () => { panning = false; if(enhanceLargeImage) { enhanceLargeImage.classList.remove('cursor-grabbing'); enhanceLargeImage.classList.add('cursor-grab'); } });
                zoomContainer.addEventListener('mousemove', (e) => { e.preventDefault(); if (!panning) return; pointX = (e.clientX - start.x); pointY = (e.clientY - start.y); applyTransform(); });
                zoomContainer.addEventListener('dblclick', (e) => { e.preventDefault(); resetZoom(); });
            }
        }
        
        // Super Resolution Modal Event Listeners
        if(closeSrModalBtn) closeSrModalBtn.addEventListener('click', () => srModal.classList.add('hidden'));
        if(srUploadBox) srUploadBox.addEventListener('click', () => srImageUpload.click());
        if(srImageUpload) srImageUpload.addEventListener('change', (e) => handleSrFileSelect(e.target.files[0]));
        if(srUploadBox) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => srUploadBox.addEventListener(evt, e => {e.preventDefault(); e.stopPropagation();}));
            srUploadBox.addEventListener('dragenter', () => srUploadBox.classList.add('drag-over'));
            srUploadBox.addEventListener('dragleave', () => srUploadBox.classList.remove('drag-over'));
            srUploadBox.addEventListener('drop', e => {
                srUploadBox.classList.remove('drag-over');
                handleSrFileSelect(e.dataTransfer.files[0]);
            });
        }
        
        srModeEnhance.addEventListener('click', () => {
            srMode = 'enhance';
            srModeEnhance.classList.add('bg-purple-700');
            srModeEnhance.classList.remove('bg-gray-700');
            srModeSuperResolution.classList.remove('bg-purple-700');
            srModeSuperResolution.classList.add('bg-gray-700');
            srScaleContainer.style.display = 'none';
            srScale = null;
            [srScale2x, srScale4x].forEach(btn => btn.classList.remove('bg-purple-700').add('bg-gray-700'));
        });

        srModeSuperResolution.addEventListener('click', () => {
            srMode = 'super-resolution';
            srModeSuperResolution.classList.add('bg-purple-700');
            srModeSuperResolution.classList.remove('bg-gray-700');
            srModeEnhance.classList.remove('bg-purple-700');
            srModeEnhance.classList.add('bg-gray-700');
            srScaleContainer.style.display = 'block';
        });
        
        srScale2x.addEventListener('click', () => {
            srScale = 2;
            srScale2x.classList.add('bg-purple-700');
            srScale2x.classList.remove('bg-gray-700');
            srScale4x.classList.remove('bg-purple-700');
            srScale4x.classList.add('bg-gray-700');
        });
        
        srScale4x.addEventListener('click', () => {
            srScale = 4;
            srScale4x.classList.add('bg-purple-700');
            srScale4x.classList.remove('bg-gray-700');
            srScale2x.classList.remove('bg-purple-700');
            srScale2x.classList.add('bg-gray-700');
        });

        srGenerateBtn.addEventListener('click', callLocalSuperResolution);
        
        srDownloadBtn.addEventListener('click', () => {
            if (!srResultBlob) return;
            const objectUrl = URL.createObjectURL(srResultBlob);
            const baseName = (srFile?.name || 'image').replace(/\.[^/.]+$/, "");
            const suffix = `${srMode}${srScale ? '_' + srScale + 'x' : ''}`;
            window.downloadContext = { src: objectUrl, nameBase: `${baseName}_${suffix}` };
            if (window.openDownloadModal) window.openDownloadModal();
        });

        srSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            srAfterImageContainer.style.width = `${value}%`;
            srSliderHandle.style.left = `${value}%`;
            if (srAfterImage && srAfterImageContainer.parentElement) {
                const containerWidth = srAfterImageContainer.parentElement.offsetWidth;
                srAfterImage.style.width = `${containerWidth}px`;
            }
        });

       
        
       
      
        // Initialize API keys
        const initializeApiKeys = () => {
            const geminiApiKey = localStorage.getItem('geminiApiKey');
            const clipDropApiKey = localStorage.getItem('clipDropApiKey');
            
            // Set input values if they exist
            const geminiApiKeyInput = document.getElementById('geminiApiKeyInput');
            const clipdropApiKeyInput = document.getElementById('clipdropApiKeyInput');
            
            if (geminiApiKeyInput) geminiApiKeyInput.value = geminiApiKey || '';
            if (clipdropApiKeyInput) clipdropApiKeyInput.value = clipDropApiKey || '';

            // Add API key input event listeners
            if (geminiApiKeyInput) {
                geminiApiKeyInput.addEventListener('change', () => {
                    const newKey = geminiApiKeyInput.value.trim();
                    localStorage.setItem('geminiApiKey', newKey);
                    if (newKey) {
                        window.showToast?.('Gemini API key saved', 'success');
                    }
                });
            }

            if (clipdropApiKeyInput) {
                clipdropApiKeyInput.addEventListener('change', () => {
                    const newKey = clipdropApiKeyInput.value.trim();
                    localStorage.setItem('clipDropApiKey', newKey);
                    if (newKey) {
                        window.showToast?.('ClipDrop API key saved', 'success');
                    }
                });
            }

            // Check if API keys are missing and show notification
            if (!geminiApiKey) {
                window.showToast?.('Gemini API key is missing. Please set it in the settings.', 'warning');
                // Open settings modal automatically if API key is missing
                const manageApiKeysBtn = document.getElementById('manageApiKeysBtn');
                if (manageApiKeysBtn) {
                    manageApiKeysBtn.click();
                }
            }
        };

        loadRecentFiles();
        setupDownloadModal();
        initializeApiKeys();
        if (window.isOpenCvReady) { if (window.updateEnhanceButtonState) window.updateEnhanceButtonState(); }
    });
    </script>
    
    <!-- Authentication Logic -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SUPABASE_URL = 'https://fzvsnxzxkyizcrhsnwdz.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ6dnNueHp4a3lpemNyaHNud2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI3MjQxNjYsImV4cCI6MjA2ODMwMDE2Nn0.O6h54XciETatW88FvVx00telEjRaoMqrsSejWWSAWVo';

        if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
            console.warn('Supabase URL and Anon Key are not configured. Authentication will not work.');
            const authSection = document.getElementById('auth-section');
            if(authSection) authSection.style.display = 'none';
            return;
        }

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabaseClient = supabase; 

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const closeLoginModalBtn = document.getElementById('closeLoginModalBtn');
        const loginButton = document.getElementById('login-button');
        const googleLoginButton = document.getElementById('google-login-button');
        const githubLoginButton = document.getElementById('github-login-button');
        const logoutButton = document.getElementById('logout-button');
        const userAvatar = document.getElementById('user-avatar');
        const profileDropdown = document.getElementById('profile-dropdown');
        const userEmailDropdown = document.getElementById('user-email-dropdown');
        const userNameDropdown = document.getElementById('user-name-dropdown');
        const userAvatarDropdown = document.getElementById('user-avatar-dropdown');
        const authErrorEl = document.getElementById('auth-error');

        let currentUser = null;

        function updateUI(user) {
            currentUser = user;
            const requiresLoginElements = document.querySelectorAll('.requires-login');
            
            if (user) {
                loginButton.classList.add('hidden');
                userAvatar.classList.remove('hidden');
                const avatarUrl = user.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.user_metadata?.full_name || user.email)}&background=random`;
                userAvatar.src = avatarUrl;

                if (userAvatarDropdown) userAvatarDropdown.src = avatarUrl;
                if (userEmailDropdown) userEmailDropdown.textContent = user.email;
                if (userNameDropdown) {
                    userNameDropdown.textContent = user.user_metadata?.full_name || user.user_metadata?.name || 'No Name';
                }
                if (loginModal) loginModal.classList.add('hidden');
            } else {
                loginButton.classList.remove('hidden');
                userAvatar.classList.add('hidden');
                profileDropdown.classList.add('hidden');
            }

            // Update mobile quick auth action
            if (!window.refreshMobileAuthQuick) {
                window.refreshMobileAuthQuick = function() {
                    const container = document.getElementById('mobile-auth-quick');
                    if (!container) return; // Mobile menu may not be built yet
                    if (currentUser) {
                        const aurl = currentUser.user_metadata?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.user_metadata?.full_name || currentUser.email)}&background=random`;
                        container.innerHTML = `
                            <button id="mobile-profile-btn" class="w-full text-gray-300 bg-gray-800 hover:bg-gray-700 rounded-md py-2 text-sm flex items-center justify-center gap-2">
                                <img src="${aurl}" alt="Profile" class="w-5 h-5 rounded-full border border-gray-600" />
                                <span>Profile</span>
                            </button>
                        `;
                        // Open the same profile dropdown as desktop
                        const btn = document.getElementById('mobile-profile-btn');
                        btn?.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const pd = document.getElementById('profile-dropdown');
                            pd?.classList.toggle('hidden');
                            // Also close the mobile menu if open
                            const mm = document.getElementById('mobile-menu-content');
                            if (mm && mm.classList.contains('flex')) { mm.classList.add('hidden'); mm.classList.remove('flex'); }
                        });
                    } else {
                        container.innerHTML = `
                            <button id="mobile-login" class="w-full text-gray-300 bg-gray-800 hover:bg-gray-700 rounded-md py-2 text-sm flex items-center justify-center gap-2">
                                <i class="ph ph-user-circle"></i><span>Sign in</span>
                            </button>
                        `;
                        document.getElementById('mobile-login')?.addEventListener('click', () => {
                            const lm = document.getElementById('loginModal');
                            lm?.classList.remove('hidden');
                            const mm = document.getElementById('mobile-menu-content');
                            if (mm && mm.classList.contains('flex')) { mm.classList.add('hidden'); mm.classList.remove('flex'); }
                        });
                    }
                };
            }
            // Try to refresh mobile quick UI now (mobile menu might not exist yet; safe no-op)
            window.refreshMobileAuthQuick();
        }

        async function checkSession() {
            const { data, error } = await supabase.auth.getSession();
            if (error) {
                console.error('Error getting session:', error.message);
                return;
            }
            updateUI(data.session?.user ?? null);

            supabase.auth.onAuthStateChange((_event, session) => {
                updateUI(session?.user ?? null);
            });
        }
      
      // ****** নতুন কোডটি এখানে যুক্ত করুন ******
        // --- Supabase Helper Functions ---
        async function logUserAction(action, details) {
          try {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
              const { error } = await supabase
                .from('PixelPerfect_Pro_activity_log')
                .insert([{ 
                    user_id: user.id, 
                    action_type: action,
                    details: details 
                }]);
              if (error) {
                console.error('Error logging action:', error.message);
              } else {
                console.log(`Action logged: ${action}`);
              }
            }
          } catch (err) {
            console.error('Could not get user for logging:', err);
          }
        }

        // ফাংশনটিকে গ্লোবাল স্কোপে যুক্ত করুন
        window.logUserAction = logUserAction;
        // ****** নতুন কোড যুক্ত করা শেষ ******

        async function signInWithProvider(provider) {
            authErrorEl.textContent = '';
            const { error } = await supabase.auth.signInWithOAuth({ provider });
            if (error) {
                console.error(`Error signing in with ${provider}:`, error.message);
                authErrorEl.textContent = `Login failed: ${error.message}`;
            }
        }

        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Error signing out:', error.message);
                if(window.showToast) window.showToast(`Logout failed: ${error.message}`, 'error');
            } else {
                if(window.showToast) window.showToast('You have been logged out.', 'info');
                updateUI(null);
            }
        }

        loginButton?.addEventListener('click', () => loginModal.classList.remove('hidden'));
        closeLoginModalBtn?.addEventListener('click', () => loginModal.classList.add('hidden'));
        userAvatar?.addEventListener('click', (e) => {
            e.stopPropagation();
            const isMobile = !window.matchMedia('(min-width: 768px)').matches;
            if (isMobile) {
                if (profileDropdown) profileDropdown.classList.add('hidden');
                openProfileMobile();
            } else {
                profileDropdown.classList.toggle('hidden');
            }
        });

        googleLoginButton?.addEventListener('click', () => signInWithProvider('google'));
        githubLoginButton?.addEventListener('click', () => signInWithProvider('github'));

        logoutButton?.addEventListener('click', (e) => {
            e.preventDefault();
            signOut();
        });

        window.addEventListener('click', (event) => {
            if (profileDropdown && !profileDropdown.classList.contains('hidden')) {
                if (!profileDropdown.contains(event.target) && !userAvatar.contains(event.target)) {
                    profileDropdown.classList.add('hidden');
                }
            }
        });

        // Fallback: delegated handler in case direct binding fails
        document.addEventListener('click', (e) => {
            const btn = e.target.closest && e.target.closest('#saveApiKeysBtn');
            if (btn) {
                e.preventDefault();
                window.showToast?.('Saving keys...', 'info');
                saveApiKeys();
            }
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('.requires-login');
            if (target && !target.disabled) {
                if (!currentUser) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Login required for:', target.id || target.tagName);
                    if(window.showToast) window.showToast('Please log in to use this feature.', 'info');
                    loginModal.classList.remove('hidden');
                }
            }
        }, true);

        checkSession();
    });
    </script>
  
   <!-- START: NEW SCRIPT FOR FOOTER MODALS -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Function to open a modal
        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
        };

        // Function to close a modal
        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Add event listeners to all modal trigger elements
        document.querySelectorAll('[data-modal-target]').forEach(trigger => {
            trigger.addEventListener('click', (event) => {
                event.preventDefault();
                const modalId = trigger.getAttribute('data-modal-target');
                openModal(modalId);
            });
        });

        // Add event listeners to all modal close buttons
        document.querySelectorAll('[data-modal-close]').forEach(button => {
            button.addEventListener('click', () => {
                const modalId = button.getAttribute('data-modal-close');
                closeModal(modalId);
            });
        });

        // Add event listener to close modals when clicking on the overlay
        document.querySelectorAll('.fixed.inset-0').forEach(modalOverlay => {
            modalOverlay.addEventListener('click', (event) => {
                // If the click is on the overlay itself (and not its children)
                if (event.target === modalOverlay) {
                    const modalId = modalOverlay.id;
                    if (modalId) {
                        closeModal(modalId);
                    }
                }
            });
        });

        // Close modals with the Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                document.querySelectorAll('.fixed.inset-0:not(.hidden)').forEach(modal => {
                     closeModal(modal.id);
                });
            }
        });
    });
    </script>
    <!-- END: NEW SCRIPT FOR FOOTER MODALS -->
    
  <script>
document.addEventListener('DOMContentLoaded', function () {

    // All Tools: open centered modal on desktop, dropdown fallback if needed
    const allToolsBtn = document.getElementById('all-tools-btn');
    const allToolsDropdown = document.getElementById('all-tools-dropdown');
    const allToolsModal = document.getElementById('all-tools-modal');
    const allToolsModalContent = document.getElementById('all-tools-modal-content');
    const closeAllToolsModalBtn = document.getElementById('close-all-tools-modal');
    if (allToolsBtn) {
        window.openAllTools = function(event){
            if(event) event.stopPropagation();
            const isDesktop = window.matchMedia('(min-width: 768px)').matches;
            if (isDesktop && allToolsModal && allToolsModalContent && allToolsDropdown) {
                // Inject inner content from dropdown into modal to keep one source of truth
                const inner = allToolsDropdown.querySelector('div.p-2');
                if (inner) allToolsModalContent.innerHTML = inner.outerHTML;
                // Always hide the dropdown when opening modal (avoid double panels)
                allToolsDropdown.classList.add('hidden');
                allToolsDropdown.style.display = 'none';
                allToolsModal.classList.remove('hidden');
            } else if (allToolsDropdown) {
                allToolsDropdown.classList.toggle('hidden');
            }
        };
        // Close modal interactions
        const closeModal = () => {
            if (!allToolsModal) return;
            allToolsModal.classList.add('hidden');
            if (allToolsDropdown) {
                allToolsDropdown.style.display = '';
            }
        };
        closeAllToolsModalBtn?.addEventListener('click', closeModal);
        allToolsModal?.addEventListener('click', (e) => { if (e.target === allToolsModal) closeModal(); });
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeModal(); allToolsDropdown?.classList.add('hidden'); } });
        
        allToolsBtn.addEventListener('click', (e) => window.openAllTools(e));
        
        // Close dropdown when clicking outside (for small screens)
        document.addEventListener('click', function (event) {
            if (allToolsDropdown && !allToolsDropdown.classList.contains('hidden')) {
                if (!allToolsBtn.contains(event.target) && !allToolsDropdown.contains(event.target)) {
                    allToolsDropdown.classList.add('hidden');
                }
            }
        });
    }

    // Mobile Menu Logic
    const menuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenuContent = document.getElementById('mobile-menu-content');
    if (menuToggle && mobileMenuContent) {
        // Build the mobile menu content
        mobileMenuContent.innerHTML = `
            <div class="flex flex-col gap-3">
                <div class="grid grid-cols-3 gap-2">
                    <button class="px-3 py-2 text-xs font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">🎁 Invite</button>
                    <button class="px-3 py-2 text-xs font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">💰 Unlimited</button>
                    <button class="px-3 py-2 text-xs font-semibold text-gray-300 bg-gray-700/50 rounded-lg hover:bg-gray-600/50">✅ Free</button>
                </div>
                <div class="grid grid-cols-3 gap-2 pt-1">
                    <button id="mobile-manage-keys" class="text-gray-300 bg-gray-800 hover:bg-gray-700 rounded-md py-2 text-sm flex items-center justify-center gap-2"><i class="ph ph-key"></i><span>API</span></button>
                    <button id="mobile-settings" class="text-gray-300 bg-gray-800 hover:bg-gray-700 rounded-md py-2 text-sm flex items-center justify-center gap-2"><i class="ph ph-gear"></i><span>Settings</span></button>
                    <div id="mobile-auth-quick">
                        <button id="mobile-login" class="w-full text-gray-300 bg-gray-800 hover:bg-gray-700 rounded-md py-2 text-sm flex items-center justify-center gap-2"><i class="ph ph-user-circle"></i><span>Sign in</span></button>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-3">
                    <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">AI Tools</div>
                    <a href="https://metadatatagpro.blogspot.com" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-file-text"></i><span>AI Keyword & Description</span></a>
                    <a href="https://imgbgremovepro.blogspot.com/" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-eraser text-lg"></i><span>Remove BG Pro</span></a>
                    <a href="https://pixelstudioai.blogspot.com/" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-arrows-out-cardinal text-lg"></i><span>AI Pixel-Check Studio</span></a>
                    <a href="https://app--pixel-perfect-ai-3f3ef0a0.base44.app" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-shooting-star"></i><span>AI-Image Upscale</span></a>
                    <a href="https://app--microstock-pro-c77f0cba.base44.app" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-magic-wand"></i><span>AI-Analyze for Microstock site</span></a>
                    <a href="https://imggenpro.blogspot.com/" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-magic-wand"></i><span>Text to Image Generator</span></a>
                </div>
            </div>
            <div class="border-t border-gray-700 pt-3">
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Adjustment Tools</div>
                        <a href="https://bulkeditmultitool.blogspot.com/" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-lightbulb"></i><span>Multi Image Tools</span></a>
                        <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-sliders-horizontal text-lg"></i><span>Adjustments</span></a>
                        <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-chart-bar text-lg"></i><span>Histogram</span></a>
                        <a href="#" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph ph-sparkle text-lg"></i><span>Sharpen / Smart Focus</span></a>
                    </div>
                     <!-- Others Tools Column -->
                    <div class="border-t border-gray-700 pt-3">
                        <div class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Others Tools</div>
                        <a href="https://onlinemynotepad.blogspot.com/" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-gray-800 rounded-md"><i class="ph-bold ph-file-text"></i><span>Online Notepad</span></a>
                    </div>
                </div>
            </div>
        </div>
        `;

        // Toggle open/close
        menuToggle.addEventListener('click', function() {
            mobileMenuContent.classList.toggle('hidden');
            mobileMenuContent.classList.toggle('flex');
        });

        // Close when clicking outside
        document.addEventListener('click', function (event) {
            const withinToggle = menuToggle.contains(event.target);
            const withinMenu = mobileMenuContent.contains(event.target);
            if (!withinToggle && !withinMenu && mobileMenuContent.classList.contains('flex')) {
                mobileMenuContent.classList.add('hidden');
                mobileMenuContent.classList.remove('flex');
            }
        });

        // Wire up mobile quick actions
        const loginModal = document.getElementById('loginModal');
        mobileMenuContent.addEventListener('click', (e) => {
            if (e.target.closest('#mobile-login')) {
                if (loginModal) loginModal.classList.remove('hidden');
                mobileMenuContent.classList.add('hidden');
                mobileMenuContent.classList.remove('flex');
            }
            if (e.target.closest('#mobile-manage-keys')) {
                document.getElementById('manageApiKeysBtn')?.click();
                mobileMenuContent.classList.add('hidden');
                mobileMenuContent.classList.remove('flex');
            }
        });

        if (window.refreshMobileAuthQuick) window.refreshMobileAuthQuick();
    }
});
</script>

<!-- Ad Script -->
<script async="async" data-cfasync="false" src="//pl26941346.profitableratecpm.com/7128caf782579cf1a6e998e1d0a0fe7b/invoke.js"></script>
   
</body>
</html>    












